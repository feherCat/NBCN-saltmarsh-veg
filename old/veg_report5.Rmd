---
title: "NCBN Salt Marsh Vegetation Monitoring Protocol Review"
output:
  html_notebook: null
  html_document:
    df_print: paged
mainfont: Times New Roman
---

```{r setup, message=FALSE, warning=TRUE, include=FALSE}
pacman::p_load(tidyverse, AER, betareg, cowplot, english, flextable, ftExtra, ggh4x, gt, here, janitor, knitr, lemon, lmtest, lubridate, margins, monochromeR, officedown, officer, pairwiseAdonis, printy, stringr, stringi, vegan, xfun)

pacman::p_load_gh("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", "tjmahr/printy")

# remotes::install_github("laura-feher/lfeheR") # install if not already installed, but don't load because it will mask other dplyr & ggplot functions

options(dplyr.summarise.inform = FALSE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)

knitr::knit_hooks$set(
  evaluate.inline = function (code, envir = knit_global()) {
    v = try(eval(xfun::parse_only(code), envir = envir))
    knitr::knit_print(v, inline = TRUE, options = knitr::opts_chunk$get())
  },
  inline = function(x) {
  if (any(class(x) == "try-error")) {
    as.vector(x)
  } else x
})

set.seed(1234)
load(here::here("data", "derived", "veg_cleaned.rda"))

set_flextable_defaults(
  font.size = 12,
  font.family = "times new roman",
  padding = 1
  )

color_pals <- list(
  "park_pal" = c("#ef476f", "#f78c6b", "#ffd166", "#0bd59d", "#118ab2", "#073b4c"#, "#6E51AE" 
  ),
  "asis_pal" = monochromeR::generate_palette("#ef476f", modification = "go_lighter", n_colours = 9),
  #"caco_pal" = monochromeR::generate_palette("#f78c6b", modification = "go_lighter", n_colours = 2),
  "colo_pal" = monochromeR::generate_palette("#f78c6b", modification = "go_lighter", n_colours = 8),
  "fiis_pal" = monochromeR::generate_palette("#ffd166", modification = "go_lighter", n_colours = 9),
  "gate_pal" = monochromeR::generate_palette("#0bd59d", modification = "go_lighter", n_colours = 3),
  "gewa_pal" = "#118ab2",
  "sahi_pal" = "#073b4c"
)

color_pals[["site_pal"]] <- c(color_pals$asis_pal, #color_pals$caco_pal, 
              color_pals$colo_pal, color_pals$fiis_pal, color_pals$gate_pal, color_pals$gewa_pal, color_pals$sahi_pal)

"study_years" = veg_cleaned$park_perc_cover %>%
  group_by(UnitCode) %>%
  summarise(min_year = min(as.numeric(Year_chr)),
            max_year = max(as.numeric(Year_chr))) %>%
  split(.$UnitCode)

format_pval <- function(x) {
  if(is.na(x) | is.null(x)){
    NA
  } else if(x > 0.05) {
    "ns"
  } else if(x <= 0.05 & x > 0.01) {
    "< 0.05"
  } else if(x <= 0.01 & x > 0.001) {
    "< 0.01"
  } else if(x <= 0.001) {
    "< 0.001"
  } 
}

format_chi <- function(x) {
  if(is.na(x)){
    NA
  } else if(is.null(x)){
    NULL
  } else if(x < 0.01){
    format(x, scientific = TRUE, digits = 2)
  } else if(x > 0.01){
    as.character(format(round(x, 2), nsmall = 2))
  } 
}

# format_sps <- function(x) {
#   if (is.na(x)) {
#     NA
#   } else if (x == 0) {
#     format(x, nsmall = 0)
#   } else if (abs(x) >= 0.96 & x != 0) {
#     format(round(x), nsmall = 0)
#   } else if (abs(x) < 0.96 & abs(x) >= 0.096 & x != 0) {
#     format(round(x, 1), nsmall = 1) 
#   } else if (abs(x) < 0.096 & abs(x) >= 0.0096 & x != 0) {
#     format(round(x, 2), nsmall = 2) 
#   } else if (abs(x) < 0.0096 & x != 0) {
#     format(x, scientific = TRUE, digits = 1)
#   } else {
#     "-"
#   }
# }

format_sps <- function(x) {
   if (is.na(x)) {
     NA
   } else if (x == 0) {
     format(x, nsmall = 0)
   } else if (x < 0.01 & x > -0.01 & x != 0) {
     format(x, scientific = TRUE, digits = 1)
   } else if (x > 0.01 | x < -0.01 & x != 0) {
     sprintf("%.2f", round(x, 2))
   } else {
     "-"
   }
}
```

#### **1. Introduction**

##### **1.1** The NCBN Salt Marsh Vegetation Monitoring Protocol

|       The National Park Service Inventory and Monitoring (I&M) Program's Northeast Coastal and Barrier Network (NCBN) has identified salt marsh condition, in addition to several associated vital signs, as a high priority for long-term monitoring. The first iteration of the salt marsh vegetation monitoring protocol was originally developed by the USGS and University of Rhode Island for the purpose of comparing the vegetation community in hydrologically altered marshes to more pristine "control" marshes in order to understand the potential effects of hydrologic restoration on salt marsh habitats within Cape Cod National Seashore (Roman et al., 2001). This protocol was then adapted to measure change in the species composition and abundance of the salt marsh plant community at the other six coastal parks monitored by NCBN in response to a multitude of stressors such as hydrologic alteration, storms, visitor use, nutrient loading, watershed development, sea-level rise, and climate change, among others (Rocks and Stevens 2018). The salt marsh vegetation monitoring protocol was successfully implemented across seven NCBN parks over a period of 10 years from 2008 to 2018 but was placed on hold in 2018 due to staffing and budget shortages. Several annual summary reports were published for each park while the protocol was active, including reports for Assateague Island National Seashore (2008, 2010, 2012, and 2014), Cape Cod National Seashore (2003, 2008, and 2013), Colonial National Historical Park (2008, 2010, 2012, and 2014), Fire Island National Seashore (2009, 2011, and 2015), Gateway National Recreation Area (2010, 2012, and 2014), George Washington Birthplace National Monument (2008, 2010, and 2012), and Sagamore Hill National Historical Site (2009, 2011, and 2015) (DataStore saved search: 3465). To date, only a single trend analysis of the existing data has been conducted (Peck et al. 2021). Since this protocol was put on hold in 2018, resource management staff at several parks in the NCBN network have expressed interest in both the results of the previous monitoring efforts and in continued salt marsh vegetation monitoring at their respective parks. Thus, the objectives of this report are a) identify limitations of the current protocol and previous trend analyses conducted by Peck et al. (2021); b) provide additional analysis of the existing data and interpretation of the results that may be useful to the parks' resource management staff; and c) discuss alternative methods for continued monitoring of salt marsh vegetation in the parks.

 

##### **1.2** Limitations of the Current Protocol

|         During the years that this protocol was active, it was by far the most labor- and time-intensive vital sign monitored by NCBN. For instance, assuming a four-person crew (two full-time biologists and two interns) was used for each sampling event, a conservative estimate of 7,072 total man-hours were dedicated to field data collection alone during this time (i.e., 221 sampling events x 8 hours per day x 4 crew members). Furthermore, this estimate does not include the additional time needed for traveling to and from the NCBN main office (Kingston, Rhode Island) to each park, logistical considerations (e.g., time for budget and travel planning, equipment preparation, clean-up, etc.), or data management and reporting tasks, among others. For a more specific example, it took a total of 13 full days to complete field sampling at just one park - ASIS - in 2018. Similarly, this protocol was also one of the more budget intensive monitoring programs conducted by NCBN. In 2018, Rocks and Stevens (2018) estimated that the annual operational cost associated with the NCBN salt marsh vegetation monitoring protocol was \$50,000 per year - a figure that would likely be much higher today. Thus, budget and staffing shortages represent a major impediment to continuing the field data collection procedures as outlined in the existing protocol.
|       The data summaries that were suggested for annual reporting in the protocol implementation plan (Rocks and Stevens 2018) include species composition (species lists), percent cover for all cover types by site, and presence of any federal, state-listed and/or non-native species. Additionally, the protocol implementation plan also recommends that trend analysis be conducted on a 3- to 5-year basis and suggests the use of non-parametric multivariate community analysis methods such as analysis of similarities (ANOSIM) and similarity of percentages analysis (SIMPER) in order to understand change over time. The suggestion to include species lists for annual reporting are necessary in order to have a record of the full suite of species at each park and the compilation of these lists is relatively straightforward and easy to interpret. However, the recommended trend analysis (ANOSIM and SIMPER) does not actually calculate trends and can only indicate where differences between plant communities have occurred between pairs of the sample events. As such, these methods of analysis have limited value for understanding the broader "big picture" changes in these salt marsh plant communities and also do not provide a means for predicting future changes and developing management actions that may be needed to either counteract or facilitate these changes.

 

##### **1.3** Limitations of Previous Analyses

|       In 2021, NCBN commissioned a report by Neptune and Company (hereafter referred to as Peck et al. 2021) that evaluates the sampling power of the salt marsh vegetation and nekton monitoring protocols and summarizes trends within a limited subset of the metrics collected as part of these protocols. For the vegetation protocol, the metrics of interest were a multimetric index (MMI) of salt marsh condition developed by Nagel et al. (2017), as well as individual metrics of community composition including the percent cover of Spartina patens and percent cover of high salinity plant species. Power simulations were performed to assess whether the data collected to date were sufficient to detect trends in either the multimetric index or previously listed individual metrics given the large amount of staff time and program money being spent on these protocols. Trends in the multimetric index and the two selected individual metrics for the period of 2008 to 2018 were also quantified using regression analyses. In this section, we have summarized the findings of Peck et al. (2021) and identified limitations of the study that could potentially be addressed by performing additional analyses on the existing data from 2008-2018.

|       There are two limited conclusions that can be drawn from both a simple visual inspection of the plots showing how each measure changed over the study period (report figures 6-11) and results of the generalized linear models (report tables 3-8): 1) the selected metrics of vegetation community composition show no change at most parks, and 2) of the metrics that do have statistically significant rates of change (Spartina patens cover at FIIS and high salinity plant species cover at FIIS), the magnitude of these changes is relatively small. The findings of Peck et al. (2021) are largely consistent with other similar monitoring studies that found that vegetation communities that are responding to long-term factors, like sea-level rise and climate change, as opposed to dramatic hydrologic alterations or discrete disturbance events (e.g., hurricanes), are likely to see changes that occur over decades or centennial time scales (Roman et al. 1997; Warren and Niering 1993). Additionally, for the measures that showed no change at some or all parks, changes in these communities could be occurring at extremely subtle rates that may not be discernible over the relatively short 10-year period that the vegetation and nekton monitoring protocols were active. Similarly, this previous analysis examined only a subset of the data collected for this protocol and does not include many of the trend analyses that may be directly applicable to resource management in the parks. Although Peck et al. (2021) has value as both an assessment of the protocol's sampling frequency and intensity and as an initial exploratory data analysis, there are large amounts of data that were collected for the salt marsh vegetation monitoring protocol that were not examined in the report. For example, the protocol necessitates recording the presence and cover of every individual species found in every plot, but only a few species are used in the analyses. As such, the analyses contained within Peck et al. (2021) did not consider changes within the context of either a) ecologically significant groups that are known to characterize these habitats, or b) the entire full, comprehensive suite of species that comprise these communities. Given the multivariate nature of the data and the protocol's focus on monitoring change in biological communities over time, this report includes several additional analyses that could aid in interpreting and drawing conclusions from the existing 2008-2018 data set in the following sections. The methods and results of these additional analyses are provided in the following sections.

|       Finally, Peck et al. (2021) suggested that the current sampling intensity and frequency are not high enough to detect a true difference in many of the metrics of interest at most parks. Sampling efforts varied greatly between the parks due to differences in the areal extent of salt marsh habitats at each park. However, given that sampling efforts at each park are limited by logistical constraints that are not within NCBN’s control, such as staff availability, travel funds, weather, and site access challenges, it is unlikely that NCBN would have the bandwidth to increase sampling effort as suggested by Peck et al. (2021). Since several recent studies using remote sensing for ecological monitoring have demonstrated great promise as an alternative to time-consuming and expensive on-the-ground surveys (DiGiacomo et al. 2022, Harris et al. 2024, Myers et al. 2018, Nardin et al. 2021, Puckett et al., Routhier et al. 2023), we have utilized the final section of this report to discuss the possibility of applying these techniques to the salt marsh vegetation monitoring protocol as an alternative method that would allow NCBN to continue providing this valuable information to the parks given current logistical and budget constraints.

#### **2. Methods**

##### **2.1** Details of Park-Specific Sampling Schemes

```{r Sampling Schemes, message=FALSE, warning=FALSE, include=FALSE}

site_descriptions <- list(
  "year_site_plot_count" = veg_joined$plot_veg_cover %>%
    group_by(UnitCode) %>%
    summarise(year_count = n_distinct(Year_chr),
              site_count = n_distinct(UniqueID),
              min_year = min(as.integer(Year_chr)),
              max_year = max(as.integer(Year_chr))) %>%
    mutate(plot_count = case_when(
      UnitCode == "ASIS" ~ 450,
      UnitCode == "COLO" ~ 400,
      UnitCode == "FIIS" ~ 450,
      UnitCode == "GATE" ~ 150,
      UnitCode == "GEWA" ~ 50,
      UnitCode == "SAHI" ~ 50
    )) %>%
    split(.$UnitCode),
  
  "site_list" = veg_joined$plot_veg_cover %>%
    group_by(UnitCode) %>%
    distinct(UniqueID) %>%
    mutate(site = sub('.+_(.+)', '\\1', UniqueID)) %>%
    split(.$UnitCode),
  
  "site_year_list" = veg_joined$plot_veg_cover %>%
    group_by(UnitCode, Year_chr) %>%
    distinct(UniqueID) %>%
    mutate(site = sub('.+_(.+)', '\\1', UniqueID),
           site_number = as.numeric(str_extract(site, "\\d+"))) %>%
    arrange(site_number) %>%
    summarise(site_list = str_flatten_comma(site, last = ", and ")) %>%
    group_by(UnitCode, site_list) %>%
    summarise(year_list = str_flatten_comma(Year_chr, last = ", and "),
              year_name = str_flatten(Year_chr, collapse = "_")) %>%
    mutate(year_name = paste0("a", year_name)) %>%
    super_split(UnitCode, year_name),
  
  "caco_site_list" = veg_joined$veg %>%
    filter(UnitCode == "CACO") %>%
    group_by(UnitCode) %>%
    distinct(UniqueID) %>%
    mutate(site = sub('.+_(.+)', '\\1', UniqueID)) %>%
    split(.$UnitCode)
)
```

|       Assateague Island National Seashore is a barrier island on the Atlantic Coasts of Maryland (Worchester County) and Virginia (Accomack County) that consists of beach, dune, and back-barrier marsh habitats. `r as.character(str_to_title(english(site_descriptions$year_site_plot_count$ASIS$site_count)))` sites were monitored biannually across `r as.character(english(site_descriptions$year_site_plot_count$ASIS$year_count))` sampling events between `r site_descriptions$year_site_plot_count$ASIS$min_year` to `r site_descriptions$year_site_plot_count$ASIS$max_year` at a total of `r site_descriptions$year_site_plot_count$ASIS$plot_count` plots (Figure 1a).
|       At Cape Cod National Seashore, `r as.character(english(length(site_descriptions$caco_site_list$CACO$site)))` sites were monitored between 1997 to 2013. However, these sites were not monitored consistently across the same years because the study plan at this park was designed specifically for monitoring change at individual sites (rather than the entire park) following several different planned restoration projects. Given the difference in the study design as compared to the other six parks, we have excluded the data from Cape Cod from this analyses, although note that the park has published a monitoring report summarizing the monitoring data from 2003, 2008, and 2013 (Smith, 2015).
|       Colonial National Historical Park lies within the Atlantic Coastal Plain (York County, Virginia) and is bisected by the York and James Rivers which feed into the Chesapeake Bay. Although the majority (80%) of the managed area at Colonial is comprised of upland pine and hardwood forest, wetland habitats within the park include streams, ponds, swamps, and marshes. `r as.character(str_to_title(english(site_descriptions$year_site_plot_count$COLO$site_count)))` sites consisting of `r site_descriptions$year_site_plot_count$COLO$plot_count` plots were monitored across `r as.character(english(site_descriptions$year_site_plot_count$COLO$year_count))` sampling events between `r site_descriptions$year_site_plot_count$COLO$min_year` to `r site_descriptions$year_site_plot_count$COLO$max_year` (Figure 1b). However, sites `r site_descriptions$site_year_list$COLO$a2008_2010$site_list` were measured between `r site_descriptions$site_year_list$COLO$a2008_2010$year_list`, but were then replaced by sites `r site_descriptions$site_year_list$COLO$a2012_2014_2016$site_list` in `r site_descriptions$site_year_list$COLO$a2012_2014_2016$year_list` due to time and access constraints.
|       Fire Island National Seashore is a barrier island on the Atlantic Coast of Long Island (Suffolk County, New York) that consists of beach, dune, maritime forest, and back-barrier marsh habitats. `r as.character(str_to_title(english(site_descriptions$year_site_plot_count$FIIS$site_count)))` sites were monitored biannually across `r as.character(english(site_descriptions$year_site_plot_count$FIIS$year_count))` sampling events between `r site_descriptions$year_site_plot_count$FIIS$min_year` to `r site_descriptions$year_site_plot_count$FIIS$max_year` at a total of `r site_descriptions$year_site_plot_count$FIIS$plot_count` plots (Figure 1c), with the exception of site F6 which was not measured in 2013.
|       Gateway National Recreation Area consists of three units including the Jamaica Bay unit in Brooklyn (New York), the Staten Island unit (New York), and the Sandy Hook unit (Monmouth County, New Jersey), however only the Sandy Hook unit was sampled as part of the NCBN salt marsh vegetation monitoring protocol. The Sandy Hook unit consists of a sand spit with beach, dune, and back-barrier marsh habitats. `r as.character(str_to_title(english(site_descriptions$year_site_plot_count$GATE$site_count)))` sites were monitored biannually across `r as.character(english(site_descriptions$year_site_plot_count$GATE$year_count))` sampling events between `r site_descriptions$year_site_plot_count$GATE$min_year` to `r site_descriptions$year_site_plot_count$GATE$max_year` at a total of `r site_descriptions$year_site_plot_count$GATE$plot_count` plots (Figure 1d). However, note that only site one site - `r site_descriptions$site_year_list$GATE$a2014$site_list` - was measured in 2014.
|       George Washington Birthplace National Monument sits at the confluence of Popes Creek and the Potomac River (Westmoreland County, Virginia) and includes wetland habitats such as coastal hardwood forests, beaches, dunes, and marshes. Only one site was measured biannually across `r as.character(english(site_descriptions$year_site_plot_count$GEWA$year_count))` sampling events between `r site_descriptions$year_site_plot_count$GEWA$min_year` to `r site_descriptions$year_site_plot_count$GEWA$max_year` at a total of `r site_descriptions$year_site_plot_count$GEWA$plot_count` plots (Figure 1e).
|       Sagamore Hill National Historic Site is located adjacent to Cold Spring Harbor on the Cove Neck Peninsula in eastern Long Island (New York). Coastal wetland habitats in the park include coastal forests, dunes, and salt marshes. Only one site was measured biannually across `r as.character(english(site_descriptions$year_site_plot_count$SAHI$year_count))` sampling events between `r site_descriptions$year_site_plot_count$SAHI$min_year` to `r site_descriptions$year_site_plot_count$SAHI$max_year` at a total of `r site_descriptions$year_site_plot_count$SAHI$plot_count` plots (Figure 1f).
|       Note that parks will be referred to with their respective four-letter unit codes throughout the remainder of the text (Table 1). Additional details of the sampling design used at each park are presented in Table 1.
&nbsp;

![Figure.1 Map of salt marsh monitoring sites at each of the six NCBN parks.](veg_nekton_site_map.jpg)
&nbsp;

```{r Table 1, echo=FALSE, message=FALSE, warning=FALSE}

veg_joined$plot_veg_cover %>%
  group_by(UnitCode) %>%
  summarise(site_count = n_distinct(UniqueID),
            min_year = min(as.numeric(Year_chr)),
            max_year = max(as.numeric(Year_chr)),
            sample_events = n_distinct(Year_chr),
            years_sampled = toString(unique(sort(Year_chr))),
            sites = toString(unique(sort(stri_extract(UniqueID, regex = "(?<=_).*"))))) %>% 
  mutate(full_park_name = case_when(
    UnitCode == "ASIS" ~ "Assateague Island National Seashore",
    #UnitCode == "CACO" ~ "Cape Cod National Seashore",
    UnitCode == "COLO" ~ "Colonial National Historical Park",
    UnitCode == "FIIS" ~ "Fire Island National Seashore",
    UnitCode == "GATE" ~ "Gateway National Recreation Area",
    UnitCode == "GEWA" ~ "George Washington Birthplace National Monument",
    UnitCode == "SAHI" ~ "Sagamore Hill National Historic Site"
  ),
  State = case_when(
    UnitCode == "ASIS" ~ "MD, VA",
    #UnitCode == "CACO" ~ "MA",
    UnitCode == "COLO" ~ "VA",
    UnitCode == "FIIS" ~ "NY",
    UnitCode == "GATE" ~ "NJ, NY",
    UnitCode == "GEWA" ~ "VA",
    UnitCode == "SAHI" ~ "NY"
  ),
  plot_count = case_when(
    UnitCode == "ASIS" ~ 450,
    UnitCode == "COLO" ~ 400,
    UnitCode == "FIIS" ~ 450,
    UnitCode == "GATE" ~ 150,
    UnitCode == "GEWA" ~ 50,
    UnitCode == "SAHI" ~ 50
  )) %>%
flextable(., col_keys = c("full_park_name", "UnitCode", "State", "site_count", "sites", "plot_count", "years_sampled", "sample_events")) %>%
  align(., align = "center", part = "all") %>%
  set_table_properties(., width = 1, layout = "autofit") %>%
  add_header_lines(., values = c("Table 1. Site count, plot count, monitoring years, and count of sampling events at each park utilizing the NCBN salt marsh vegetation monitoring protocol.")) %>%
  set_header_labels(., full_park_name = "Park", UnitCode = "Unit Code", State = "Location", site_count = "Number of Sites", sites = "Site List", plot_count = "Number of Plots", years_sampled = "Sample Years", sample_events = "Sampling Events") %>%
  align(., i = 1, align = "left", part = "header") %>%
  border_inner_h(., border = fp_border(color = "transparent"), part = "body") %>%
  padding(., part = "body", padding.top = 3, padding.bottom = 3) 
```

##### **2.2** Additional Analyses of the 2008-2018 Data

|       The salt marsh plant community at each park was assessed by visually estimating the percent cover of each species within 50 replicate 1 m^2^ plots that were randomly established within each of 1-9 sites at each park during each sampling event (Table 1). Prior to analyses, the percent cover of each species in each plot was averaged up to the site-level as outlined in SOP 7 of the NCBN Salt Marsh Vegetation Monitoring Protocol (Rocks and Stevens 2018). Similarly, the site-level frequency of each species was calculated as the number of plots where each species was found divided by the total number of plots that were sampled at each site during each sampling event. Note that error values and error bars reported throughout the text represent standard errors.

##### *2.2.1 Trends in Total Cover, Species Richness, and Unique Species*
|       We first compared changes in the salt marsh plant community over time within the six park units using the following three metrics: mean total plot cover, species richness, and the number of species unique to each park. Mean total plot cover was calculated as the site-level mean of the sum of the cover of all species in each plot. Trends in mean total plot cover for each park were estimated using beta regression models with a log-log link where the independent variable was time since the first sampling event and the dependent variable was the sum cover of all species in each plot averaged up to the site-level in each year. Species richness was calculated as the total number of distinct species found at each site during each sampling event. Similarly, the number of unique species at each park was calculated as the count of species at a park that were not found at the other five parks at each site during each sampling event. Trends in species richness and the count of unique species for each park were estimated using generalized linear models with a poisson error distribution with a log link and an offset for the total number of plots measured within each site during each sampling event, where the independent variable was time since the first sampling event and the dependent variable was either species richness or the count of unique species at each site in each year.

##### *2.2.2 Trends in Specific Species of Interest to Park Resource Managers*
|       In order to understand the changes occurring in specific species that may be important to park resource managers, we identified species that were either 1) classified as endangered, rare, threatened, or vulnerable at the federal level or by the respective state(s) in which each park was located, 2) classified as either "management concern" or "exploitation concern" in NPSpecies, or 3) considered invasive, noxious, or prohibited by the respective state(s) in which each park was located. Federally threatened and endangered species were identified based on the U.S. Fish and Wildlife Service's 2024 species list (Department of the Interior, Fish and Wildlife Service, 50 CFR Part 17, Docket No. FWS-HQ-ES-2023-0018; FXES1113090FEDR-245-FF09E23000, RIN 1018-BF88). State-level threatened and endangered species and invasive species were identified based on the sources shown in Appendix 1. For each of the species that were identified using these three criteria, we estimated trends in the mean cover and frequency for each park using generalized linear models with a quasi-binomial error distribution with a log link and weights for the total number of plots measured within each site during each sampling event where the independent variable was time since the first sampling event and the dependent variable was either site-level mean cover or frequency.

##### *2.2.3 Trends in Species' Salinity Tolerance*
|       Since salinity is known to be a key factor controlling plant community composition in coastal wetlands, we also compared changes over time in the count (i.e., richness), frequency, and mean percent cover of species with low, medium, and high salinity tolerance at each park. We used the salinity tolerance categories from the USDA plants database to categorize the salinity tolerance of each species as either low (\< 0.5 ppt), medium (0.5 to 18 ppt), or high (\> 18 ppt). Note that there were several species (n = 47 out of `r n_distinct(veg_cleaned$plot_perc_cover$SciName_cor)`) that did not have salinity tolerance classifications in the USDA plants database. The salinity tolerance of each species is shown in the species list for each park in Appendix 3. We estimated trends in the count of species in each salinity category at each park using generalized linear models with a poisson error distribution with a log link and an offset for the total number of plots measured within each site during each sampling event, where the independent variable was time since the first sampling event and the dependent variable was the total site-level count of species in each salinity tolerance category. Trends in the frequency or mean cover of species in each salinity tolerance category at each park were estimated using generalized linear models with a quasi-binomial error distribution with a log link and weights for the total number of plots measured within each site during each sampling event, where the independent variable was time since the first sampling event and the dependent variable was either site-level frequency or mean percent cover. 

##### *2.2.4 Analyses of Community Composition*
|       Finally, we compared changes in plant community composition over time at each park using permutational multivariate analysis of variance using distance matrices (ADONIS) via the 'adonis2' function from the R package 'vegan' where the independent variable was the sample year and the dependent variable was the site-level cover of each species. Although an analysis of similarities (a.k.a. ANOSIM) was recommended for trend analysis in the original NCBN salt marsh vegetation monitoring protocol, we opted to use the ADONIS model since ANOSIM can potentially confound the differences between groups with the dispersion within groups (Warton et al., 2012). For parks where the ADONIS model detected a significant difference between years, we used post-hoc pairwise comparisons with Benjamini and Hochberg corrections (Benjamini and Hochberg 1995) via the function 'pairwise.adonis' in the R package 'pairwiseAdonis' to find the year-pairs with significant differences. Finally, we used the 'kruskal.test' function from the R package 'stats' to find the species with significantly different mean percent cover between the year pairs identified in the previous pairwise comparisons.
 

#### **3. Results**

##### **3.1** Total Plot Cover & Species Richness

```{r Total Cover, echo=FALSE, message=FALSE, warning=FALSE}

total_cover <- list(
  "total_cover_df" = veg_joined$plot_veg_cover %>%
  group_by(EventID, UniqueID, UnitCode, Year_chr) %>%
  summarise(mean_year_plot_total_cover = mean(total_percent_cover, na.rm = TRUE)) %>%
  group_by(UniqueID, UnitCode, Year_chr) %>%
  summarise(mean_year_site_total_cover = mean(mean_year_plot_total_cover, na.rm = TRUE)) %>% 
  group_by(UnitCode, Year_chr) %>%
  summarise(mean_year_total_cover = mean(mean_year_site_total_cover, na.rm = TRUE),
            se_year_total_cover = sd(mean_year_site_total_cover)/sqrt(length(mean_year_site_total_cover))),
  
  "total_cov_mods" = veg_joined$plot_veg_cover %>% # beta regression for total cover
  group_by(EventID, UniqueID, UnitCode, Year_chr) %>%
  summarise(mean_year_plot_total_cover = mean(total_percent_cover, na.rm = TRUE)) %>%
  group_by(UniqueID, UnitCode, Year_chr) %>%
  summarise(mean_year_site_total_cover = mean(mean_year_plot_total_cover, na.rm = TRUE)) %>%
  mutate(mean_year_site_total_cover = if_else(mean_year_site_total_cover > 100, 100, mean_year_site_total_cover)) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         beta_cover = mean_year_site_total_cover/100) %>%
  filter(UnitCode != "GEWA") %>%
  nest() %>%
  mutate(beta_mod = map(data, ~betareg(beta_cover ~ year_num, data = .x, link = "loglog")), # https://www.andrewheiss.com/blog/2021/11/08/beta-regression-guide/#a-beta-regression
         null_mod = map(data, ~betareg(beta_cover ~ 1, data = .x, link = "loglog")),
         summary_null = map(null_mod, ~summary(.x)),
         summary_mod = map(beta_mod, ~summary(.x)),
         pval = map_dbl(summary_mod, ~.x$coefficients[[1]][[8]])) %>%
  mutate(int = map_dbl(summary_mod, ~.x$coefficients[[1]][[1]]),
         b1 =  map_dbl(summary_mod, ~.x$coefficients[[1]][[2]]),
         b1_se = map_dbl(summary_mod, ~.x$coefficients[[1]][[4]]), 
         change_cover = map2_dbl(int, b1, ~plogis(.x + .y) - plogis(.x))*100,
         change_cover_se = map2_dbl(int, b1_se, ~plogis(.x + .y) - plogis(.x))*100,
         r2 = map_dbl(summary_mod, ~.x$pseudo.r.squared),
         chisq_calc = map2_dbl(summary_null, summary_mod, ~ -2 * (.x$loglik - .y$loglik)),
         LR_chisq = format_chi(chisq_calc), 
         format_p = format_pval(pval)
  ),
 
  "plot_lims" = list(
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(0,0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(0,0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y")
    )
  )

total_cover[["plot_betas"]] <- total_cover$total_cov_mods %>%
  filter(pval < 0.05) %>%
    mutate(min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
           min_date_num = map(data, ~min(.x$year_num)-(1)),
           max_date_num = map(data, ~max(.x$year_num)+(2)),
           nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
           pred = map2(beta_mod, nd, ~data.frame(bind_cols(nd, "mean_year_total_cover" = predict(.x, newdata = .y, type = "response")) %>% mutate(mean_year_total_cover = mean_year_total_cover * 100)))
    ) %>%
    select(UnitCode, pred, min_date, min_date_num, max_date_num) %>%
    unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
    mutate(Year = as.Date(min_date) + (year_num*365.25))

total_cover[["results"]] <- total_cover$total_cover_df %>%
  group_by(UnitCode) %>%
  summarise(mean_total_cover = mean(mean_year_total_cover, na.rm = TRUE),
              se_total_cover = sd(mean_year_total_cover)/sqrt(length(mean_year_total_cover))) %>%
  rowwise() %>%
  mutate(mean_se_text = paste0(round(mean_total_cover, 0), "% (± ", round(se_total_cover, 0), ")")) %>%
  left_join(., total_cover$total_cov_mods, by = "UnitCode") %>%
  rowwise() %>%
  mutate(change_cover_se_text = paste0(round(change_cover, 1), " ± ", round(change_cover_se, 1), "%/yr"),
         change_cover_lab = paste0("Total cover: ", round(change_cover, 1), " ± ", round(change_cover_se, 1), "%/yr"),
        ) %>%
  select(-c(data, beta_mod, null_mod, summary_mod, summary_null)) %>%
  split(.$UnitCode)
```

```{r Species richness, message=FALSE, warning=FALSE, include=FALSE}

species_richness <- list(
  
  "site_species_richness_per_yr" = veg_joined$plot_veg_cover %>% # site-level species richness in each year
    group_by(UniqueID, UnitCode, Year_chr) %>%
    summarise(site_richness = n_distinct(SciName_cor)) %>%
    # add in plot counts for each site in each year for use in regression
    left_join(.,
              veg_cleaned$plot_perc_cover %>%
                ungroup() %>%
                select(UnitCode, UniqueID, Year_chr, EventID) %>%
                group_by(UnitCode, UniqueID, Year_chr) %>%
                summarise(plot_count = n_distinct(EventID)),
              by = c("UnitCode", "UniqueID", "Year_chr")),
  
  "total_park_species_richness" = veg_joined$plot_veg_cover %>% # total park-level species richness across all years
    group_by(UnitCode) %>%
    summarise(plot_num = n_distinct(EventID),
              site_num = n_distinct(UniqueID),
              total_richness = n_distinct(SciName_cor)) %>%
    ungroup() %>% 
    split(.$UnitCode) %>% 
    map(., ~pull(., total_richness))
)

species_richness[["park_species_richness_per_yr"]] <- species_richness$site_species_richness_per_yr %>% # park-level species richness in each year (for plotting)
  group_by(UnitCode, Year_chr) %>%
  summarise(total_richness = mean(site_richness, na.rm = TRUE),
            se_richness = sd(site_richness)/sqrt(length(site_richness)))

species_richness[["species_richness_mods"]] <- species_richness$site_species_richness_per_yr %>% # poisson glm for species richness
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr), 
         year_num = as.numeric(year-min(year))) %>%
  nest()  %>%
  mutate(pois_mod = map(data, ~glm(site_richness ~ year_num + offset(log(plot_count)), family = "poisson", data = .x)), # https://stats.stackexchange.com/questions/237963/how-to-formulate-the-offset-of-a-glm
         dispersion = map(pois_mod, ~AER::dispersiontest(.x, trafo = 1)), # test for overdispersion
         summary_mod = map(pois_mod, ~summary(.x)),
         null_mod = map(data, ~glm(site_richness ~ 1 + offset(log(plot_count)), family = "poisson", data = .x)),
         summary_null = map(null_mod, ~summary(.x)),
         chisq_calc = map2_dbl(null_mod, pois_mod, ~lmtest::lrtest(.x, .y)$`Chisq`[[2]]),
         LR_chisq = format_chi(chisq_calc),, 
         pval = map_dbl(summary_mod, ~coef(.x)[8]),
         b1 =  map_dbl(summary_mod, ~coef(.x)[2]),
         b1_se = map_dbl(summary_mod, ~coef(.x)[4]), 
         change_count = map_dbl(b1, ~(exp(.x*1)-1)*100), # https://stats.stackexchange.com/questions/344291/interpreting-poisson-regression-coefficients
         change_count_se = map_dbl(b1_se, ~abs((exp(.x*1)-1)*100)),
         format_p = format_pval(pval)
  )

species_richness[["richness_plot_betas"]] <- species_richness$species_richness_mods %>%
  filter(pval < 0.05) %>%
  mutate(pois_mod_no_offset = map(data, ~glm(site_richness ~ year_num, family = "poisson", data = .x)),
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(pois_mod_no_offset, nd, ~data.frame(bind_cols(nd, "site_richness" = predict(.x, newdata = .y, type = "response")) %>% mutate(site_richness = as.numeric(site_richness))))) %>%
  dplyr::select(UnitCode, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         richness_metric = "total richness")

species_richness[["results"]] <- species_richness$park_species_richness_per_yr %>%
  group_by(UnitCode) %>%
  summarise(mean_richness = round(mean(total_richness), 0),
            se_richness = signif(sd(total_richness)/sqrt(length(total_richness)), 1)) %>%
  mutate(mean_se_text = if_else(se_richness < 10, 
                                paste0(mean_richness, " ± ", signif(se_richness, 1), " species"),
                                paste0(mean_richness, " ± ", signif(se_richness, 2), " species"))) %>%
  left_join(., species_richness$species_richness_mods, by = "UnitCode") %>%
  ungroup() %>%
  mutate(change_count_se_text = paste0(round(change_count, 0), " ± ", signif(change_count_se, 1), "% sp/yr"),
         change_count_lab = paste0("Richness: ", change_count_se_text)) %>%
  split(.$UnitCode)
```

```{r Unique species, message=FALSE, warning=FALSE, include=FALSE}

unique_species <- list(
  
  "park_unique_species" = veg_joined$plot_veg_cover %>% # list of unique species found in each park (i.e., species not found in any other parks)
    ungroup() %>%
    select(UnitCode, SciName_cor) %>%
    unique() %>%
    group_by(SciName_cor) %>%
    reframe(parks = as.list(unique(UnitCode))) %>%
    group_by(SciName_cor) %>%
    mutate(park_count = length(parks)) %>%
    filter(park_count == 1) %>%
    unnest(parks) %>%
    select("UnitCode" = parks, SciName_cor, park_count),
  
  "park_unique_species_count" = veg_joined$plot_veg_cover %>% # park-level count of unique species across all years
    ungroup() %>%
    select(UnitCode, SciName_cor) %>%
    unique() %>%
    group_by(SciName_cor) %>%
    reframe(parks = as.list(unique(UnitCode))) %>%
    group_by(SciName_cor) %>%
    mutate(park_count = length(parks)) %>%
    filter(park_count == 1) %>%
    unnest(parks) %>%
    select("UnitCode" = parks, SciName_cor, park_count) %>%
    group_by(UnitCode) %>%
    summarise(n_unique = n_distinct(SciName_cor)) %>% 
    ungroup() %>% 
    split(.$UnitCode) %>% 
    map(., ~pull(., n_unique)),
  
  "site_unique_species_count_per_year" = veg_joined$plot_veg_cover %>% # site-level count of unique species in each year
    ungroup() %>%
    select(UniqueID, UnitCode, Year_chr, SciName_cor) %>%
    unique() %>%
    left_join(., veg_joined$plot_veg_cover %>% # unique species found in each park (i.e., species not found in any other parks)
                ungroup() %>%
                select(UniqueID, UnitCode, SciName_cor) %>%
                unique() %>%
                group_by(SciName_cor) %>%
                reframe(parks = as.list(unique(UnitCode))) %>%
                group_by(SciName_cor) %>%
                mutate(park_count = length(parks)) %>%
                filter(park_count == 1) %>%
                unnest(parks) %>%
                select("UnitCode" = parks, SciName_cor, park_count), 
              by = c("UnitCode", "SciName_cor")) %>%
    replace_na(list(park_count = 0)) %>%
    group_by(UniqueID, UnitCode, Year_chr) %>%
    summarise(site_n_unique = sum(park_count)) %>%
    group_by(UnitCode) %>%
    nest() %>%
    #  add in 0s for sites where no unique species were found in a particular year 
    mutate(data = map(data, ~pivot_wider(.x, names_from = "Year_chr", values_from = "site_n_unique", values_fill = 0) %>%
                        pivot_longer(., cols = -c("UniqueID"), names_to = "Year_chr", values_to = "site_n_unique") %>%
                        mutate(year = as.numeric(Year_chr),
                               year_num = as.numeric(year-min(year))))) %>% 
    unnest() %>%
    # add in plot counts for each site in each year for use in regression
    left_join(.,
              veg_cleaned$plot_perc_cover %>%
                ungroup() %>%
                select(UnitCode, UniqueID, Year_chr, EventID) %>%
                group_by(UnitCode, UniqueID, Year_chr) %>%
                summarise(plot_count = n_distinct(EventID)),
              by = c("UnitCode", "UniqueID", "Year_chr")) %>%
    filter(!is.na(plot_count)),
  
  "all_yrs_species" = veg_joined$site_veg_frq %>% # species that were found in every year at each park
    group_by(UnitCode, Year_chr, SciName_cor) %>%
    summarise(mean_frq = mean(frq, na.rm = TRUE)) %>%
    group_by(UnitCode, Year_chr) %>%
    arrange(UnitCode, SciName_cor, Year_chr) %>%
    group_by(UnitCode, SciName_cor) %>%
    mutate(n_years = n(),
           all_years = case_when(UnitCode == "ASIS" & n_years >= 6 ~ TRUE,
                                 UnitCode == "COLO" & n_years >= 5 ~ TRUE,
                                 UnitCode == "FIIS" & n_years >= 5 ~ TRUE,
                                 UnitCode == "GATE" & n_years >= 5 ~ TRUE,
                                 UnitCode == "GEWA" & n_years >= 3 ~ TRUE,
                                 UnitCode == "SAHI" & n_years >= 5 ~ TRUE,
                                 T ~ FALSE)) %>%
    ungroup() %>%
    filter(all_years == TRUE) %>%
    select(UnitCode, SciName_cor) %>%
    distinct(),
  
  "plot_x_lims" = list(
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04,0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04,0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(0, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(0, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y")
    ),
  
  "plot_y_lims" = list(
    scale_y_continuous(expand = expansion(mult = c(0.05,0.4)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis()),
    scale_y_continuous(expand = expansion(mult = c(0.05,0.4)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis()),
    scale_y_continuous(expand = expansion(mult = c(0.05,0.4)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis()),
    scale_y_continuous(expand = expansion(mult = c(0.05,1)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis()),
    scale_y_continuous(expand = expansion(mult = c(0.05,1.1)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis()),
    scale_y_continuous(expand = expansion(mult = c(0.05,0.4)), limits = c(0,NA), name = "Park-level species richness (n)", labels = function(x) sprintf("%0.0f", x), sec.axis = dup_axis())
    )
)

unique_species[["park_unique_species_count_per_year"]] <- unique_species$site_unique_species_count_per_year %>% # park-level count of unique species in each year for plotting
  group_by(UnitCode, Year_chr) %>%
  summarise(n_unique = mean(site_n_unique, na.rm = TRUE),
            se_n_unique = sd(site_n_unique)/sqrt(length(site_n_unique)))

unique_species[["unique_species_mods"]] = unique_species$site_unique_species_count_per_year %>% # poisson glm for species richness
  group_by(UnitCode) %>%
  nest() %>%
  mutate(pois_mod = map(data, ~glm(site_n_unique ~ year_num + offset(log(plot_count)), family = "poisson", data = .x)), # https://stats.stackexchange.com/questions/237963/how-to-formulate-the-offset-of-a-glm
         dispersion = map(pois_mod, ~AER::dispersiontest(.x, trafo = 1)), # test for overdispersion
         summary_mod = map(pois_mod, ~summary(.x)),
         null_mod = map(data, ~glm(site_n_unique ~ 1 + offset(log(plot_count)), family = "poisson", data = .x)),
         summary_null = map(null_mod, ~summary(.x)),
         chisq_calc = map2_dbl(null_mod, pois_mod, ~lmtest::lrtest(.x, .y)$`Chisq`[[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coef(.x)[8]),
         b1 =  map_dbl(summary_mod, ~coef(.x)[2]),
         b1_se = map_dbl(summary_mod, ~coef(.x)[4]), 
         change_count = map_dbl(b1, ~(exp(.x*1)-1)*100), # https://stats.stackexchange.com/questions/344291/interpreting-poisson-regression-coefficients
         change_count_se = map_dbl(b1_se, ~abs((exp(.x*1)-1)*100)),
         format_p = format_pval(pval)
  )

unique_species[["unique_plot_betas"]] <- unique_species$unique_species_mods %>%
  filter(pval < 0.05) %>%
  mutate(pois_mod_no_offset = map(data, ~glm(site_n_unique ~ year_num, family = "poisson", data = .x)),
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(pois_mod_no_offset, nd, ~data.frame(bind_cols(nd, "site_n_unique" = predict(.x, newdata = .y, type = "response")) %>% mutate(site_n_unique = as.numeric(site_n_unique))))) %>%
  dplyr::select(UnitCode, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         richness_metric = "n_unique")

unique_species[["results"]] <- unique_species$park_unique_species_count_per_year %>%
  group_by(UnitCode) %>%
  summarise(mean_n_unique = mean(n_unique),
            se_n_unique = signif(sd(n_unique)/sqrt(length(n_unique)), 1)) %>%
  mutate(mean_se_text = if_else(se_n_unique < 1, 
                                paste0(signif(mean_n_unique, 1), " ± ", signif(se_n_unique, 1), " species"),
                                paste0(signif(mean_n_unique, 1), " ± ", signif(se_n_unique, 2), " species"))) %>%
  left_join(., unique_species$unique_species_mods, by = "UnitCode") %>%
  ungroup() %>%
  mutate(change_count_se_text = paste0(round(change_count, 0), " ± ", signif(change_count_se, 1), "% sp/yr"),
         change_count_lab = paste0("Unique sp: ", change_count_se_text)) %>%
  split(.$UnitCode)

unique_species[["park_unique_species_text"]] <- unique_species$park_unique_species %>% 
  group_by(UnitCode) %>% 
  arrange(SciName_cor) %>%
  nest() %>% 
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
    paste0("*",.x$SciName_cor,"*"),
    paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>% 
  ungroup() %>% 
  dplyr::select(-data)

unique_species[["all_yrs_species_text"]] <- unique_species$all_yrs_species %>% 
  group_by(UnitCode) %>% 
  arrange(SciName_cor) %>%
  nest() %>% 
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
    paste0("*",.x$SciName_cor,"*"),
    paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>% 
  ungroup() %>% 
  dplyr::select(-data)
```

##### *3.1.1 Total Plot Cover & Species Richness: ASIS*

|       At ASIS, mean total plot cover over the entire study period was `r total_cover$results$ASIS$mean_se_text` (Table 2). Mean total plot cover at ASIS remained unchanged between `r study_years$ASIS$min_year` to `r study_years$ASIS$max_year` (Figure 2a). A total of `r species_richness$total_park_species_richness$ASIS` species were identified across the entire study period at ASIS. Total park-level species richness at ASIS remained unchanged over the study period (mean: `r species_richness$results$ASIS$mean_se_text`; Figure 3a). There were `r as.character(english(unique_species$park_unique_species_count$ASIS))` species that were unique to ASIS (Table 3). The count of unique species at ASIS remained unchanged over the study period (mean: `r unique_species$results$ASIS$mean_se_text`; Figure 3a). Notably, `r as.character(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "ASIS") %>% pluck("count")))` species were found in at least one plot during every sampling event at ASIS, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "ASIS") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at ASIS is provided in Appendix 3a.

##### *3.1.2 Total Plot Cover & Species Richness: COLO*

|       At COLO, mean total plot cover across the entire study period was `r total_cover$results$COLO$mean_se_text` (Table 2). Average total plot cover at COLO declined at a rate of `r total_cover$results$COLO$change_cover_se_text` between `r study_years$COLO$min_year` to `r study_years$COLO$max_year` (*p* *`r total_cover$results$COLO$format_p`*; Figure 2b). A total of `r species_richness$total_park_species_richness$COLO` species were identified across the entire study period at COLO. Total park-level species richness at COLO remained unchanged over the study period (mean: `r species_richness$results$COLO$mean_se_text`; Figure 3b). There were `r unique_species$park_unique_species_count$COLO` species that were unique to COLO (Table 3). The count of unique species at COLO remained unchanged over the study period (mean: `r unique_species$results$COLO$mean_se_text`; Figure 3b). `r as.character(str_to_title(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "COLO") %>% pluck("count"))))` species were found in at least one plot during every sampling event at COLO, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "COLO") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at COLO is provided in Appendix 3b.

##### *3.1.3 Total Plot Cover & Species Richness: FIIS*

|       At FIIS, mean total plot cover across the entire study period was `r total_cover$results$FIIS$mean_se_text` (Table 2). Average total plot cover at FIIS declined at a rate of `r total_cover$results$FIIS$change_cover_se_text` between `r study_years$FIIS$min_year` to `r study_years$FIIS$max_year` (*p* `r total_cover$results$FIIS$format_p`; Figure 2c). A total of `r species_richness$total_park_species_richness$FIIS` species were identified across the entire study period at FIIS. Total park-level species richness at FIIS remained unchanged over the study period (mean: `r species_richness$results$FIIS$mean_se_text`; Figure 3c). There were `r unique_species$park_unique_species_count$FIIS` species that were unique to FIIS (Table 3). The count of unique species at FIIS remained unchanged over the study period (mean: `r unique_species$results$FIIS$mean_se_text`; Figure 3c). `r as.character(str_to_title(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "FIIS") %>% pluck("count"))))` species were found in at least one plot during every sampling event at FIIS, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "FIIS") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at FIIS is provided in Appendix 3c.

##### *3.1.4 Total Plot Cover & Species Richness: GATE*

|        At GATE, mean total plot cover over the entire study period was `r total_cover$results$GATE$mean_se_text` (Table 2). Average total plot cover at GATE remained unchanged between `r study_years$GATE$min_year` to `r study_years$GATE$max_year` (Figure 2d). A total of `r species_richness$total_park_species_richness$GATE` species were identified across the entire study period at GATE. Total park-level species richness at GATE increased at a rate of  `r species_richness$results$GATE$change_count_se_text` between `r study_years$GATE$min_year` to `r study_years$GATE$max_year` (*p* `r species_richness$results$GATE$format_p`; mean: `r species_richness$results$GATE$mean_se_text`; Figure 3d). There were `r unique_species$park_unique_species_count$GATE` species that were unique to GATE (Table 3). The count of unique species at GATE increased at a rate of `r unique_species$results$GATE$change_count_se_text` over the study period (*p* `r unique_species$results$GATE$format_p`; mean: `r unique_species$results$GATE$mean_se_text`; Figure 3d). `r as.character(str_to_title(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "GATE") %>% pluck("count"))))` species were found in at least one plot during every sampling event at GATE, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "GATE") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at GATE is provided in Appendix 3d.

##### *3.1.5 Total Plot Cover & Species Richness: GEWA*

|       At GEWA, mean total plot cover across the entire study period was `r total_cover$results$GEWA$mean_se_text` (Table 2). The rate of change in mean total plot cover at GEWA could not be estimated since there were only three sampling events between `r study_years$GEWA$min_year` to `r study_years$GEWA$max_year`. A total of `r species_richness$total_park_species_richness$GEWA` species were identified across the entire study period at GEWA. Total park-level species richness at GEWA decreased at a rate of `r species_richness$results$GEWA$change_count_se_text` over the study period (*p* `r species_richness$results$GEWA$format_p`; mean: `r species_richness$results$GEWA$mean_se_text`; Figure 3e). There were `r unique_species$park_unique_species_count$GEWA` species that were unique to GEWA (Table 3). The count of unique species at GEWA decreased at a rate of `r unique_species$results$GEWA$change_count_se_text` over the study period (*p* `r unique_species$results$GEWA$format_p`; mean: `r unique_species$results$GEWA$mean_se_text`; Figure 3e). `r as.character(str_to_title(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "GEWA") %>% pluck("count"))))` species were found in at least one plot during every sampling event as GEWA, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "GEWA") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at GEWA is provided in Appendix 3e.

##### *3.1.6 Total Plot Cover & Species Richness: SAHI*

|       At SAHI, mean total plot cover across the entire study period was `r total_cover$results$SAHI$mean_se_text` (Table 2). Average total plot cover at SAHI remained unchanged between `r study_years$SAHI$min_year` to `r study_years$SAHI$max_year` (Figure 2f). A total of `r species_richness$total_park_species_richness$SAHI` species were identified across the entire study period at SAHI. Total park-level species richness at SAHI remained unchanged over the study period (mean: `r species_richness$results$SAHI$mean_se_text`; Figure 3f). There were `r unique_species$park_unique_species_count$SAHI` species that were unique to SAHI (Table 3). The count of unique species at SAHI remained unchanged over the study period (mean: `r unique_species$results$SAHI$mean_se_text`; Figure 3f). `r as.character(str_to_title(english(unique_species$all_yrs_species %>% group_by(UnitCode) %>% summarise(count = n_distinct(SciName_cor)) %>% filter(UnitCode == "SAHI") %>% pluck("count"))))` species were found in at least one plot during every sampling event as SAHI, including `r unique_species$all_yrs_species_text %>% filter(UnitCode == "SAHI") %>% unlist("sp_list") %>% pluck("sp_list")`. A list of all species found at SAHI is provided in Appendix 3f.
&nbsp;

```{r Table 2, echo=FALSE, fig.height=3, fig.width=7.1, message=FALSE, warning=FALSE, out.height=3, out.width=7.1}
total_cover$results %>%
  bind_rows() %>%
  mutate(mean_total_cover = as.character(round(mean_total_cover, 0)),
    rate_total_cover = if_else(format_p == "ns" | is.na(format_p), 
                                      "-", 
                                      as.character(round(change_cover, 1)))) %>%
  select(UnitCode, mean_total_cover, rate_total_cover) %>%

  left_join(., species_richness$total_park_species_richness %>% 
              bind_cols() %>%
              pivot_longer(., cols = everything(), names_to = "UnitCode", values_to = "total_sp_richness"),
            by = c("UnitCode")) %>%
  left_join(., species_richness$results %>%
              bind_rows(),
            by = c("UnitCode")) %>%
  mutate(rate_sp_richness = if_else(pval > 0.05, "-", as.character(round(change_count)))) %>%
  select(UnitCode, mean_total_cover, rate_total_cover, total_sp_richness, mean_richness, rate_sp_richness) %>%
  
  left_join(., unique_species$park_unique_species_count %>%
              bind_cols() %>%
              pivot_longer(., cols = everything(), names_to = "UnitCode", values_to = "total_unique"),
            by = c("UnitCode")) %>%
  left_join(., unique_species$results %>%
              bind_rows(),
            by = c("UnitCode")) %>%
  mutate(mean_n_unique = if_else(mean_n_unique < 1, as.character(round(mean_n_unique, 1)), as.character(round(mean_n_unique))),
         rate_unique = if_else(pval > 0.05, "-", as.character(round(change_count)))) %>%
  select(UnitCode, mean_total_cover, rate_total_cover, total_sp_richness, mean_richness, rate_sp_richness, total_unique, mean_n_unique, rate_unique) %>%
  
  flextable(., col_keys = c("UnitCode", "mean_total_cover", "rate_total_cover", "col1", "total_sp_richness", "mean_richness", "rate_sp_richness", "col2", "total_unique", "mean_n_unique", "rate_unique")) %>%
  set_header_labels(., UnitCode = "Park", mean_total_cover = "Mean\n(%)", rate_total_cover =  "Rate of change (%/yr)", col1 = "", total_sp_richness = "Total (n)", mean_richness = "Mean (n)", rate_sp_richness = "Rate of change\n(% of sps/yr)", col2 = "",total_unique = "Total\n(n)", mean_n_unique = "Mean\n(n)", rate_unique = "Rate of change\n(% of sps/yr)") %>%
  add_header_row(., values = c("Park", "Total Cover", "", "Species Richness", "", "Unique Species"), colwidths = c(1, 2, 1, 3, 1, 3)) %>% 
  add_header_row(., values = "Table 2. Total cover, species richness, and count of unique species at each park. Note that only rates of change that were significantly different from 0 are shown.", colwidths = 11) %>%
  merge_at(i = c(2,3), j = c(1), part = "header") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  color(i = ~rate_total_cover != "-", j = 3, color = "red", part = "body") %>%
  color(i = ~rate_sp_richness != "-" & rate_sp_richness < 0, j = 7, color = "red", part = "body") %>%
  color(i = ~rate_sp_richness != "-" & rate_sp_richness > 0, j = 7, color = "forestgreen", part = "body") %>%
  color(i = ~rate_unique != "-" & rate_unique < 0, j = 11, color = "red", part = "body") %>%
  color(i = ~rate_unique != "-" & rate_unique > 0, j = 11, color = "forestgreen", part = "body") %>%
  width(j = 1:11, width = c(0.2, 0.5, 0.9, 0.2, 0.45, 0.5, 0.9, 0.2, 0.45, 0.5, 1)) %>%
  border_inner_h(part = "body", border = fp_border(color = "grey", width = 1)) %>%
  fontsize(size = 10, part = "all")
```
&nbsp;

```{r Table 3, echo=FALSE, message=FALSE, warning=FALSE}
unique_species$park_unique_species %>% 
  group_by(UnitCode) %>% 
  arrange(UnitCode, SciName_cor) %>%
  nest() %>% 
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
    paste0("*",.x$SciName_cor,"*"),
    paste0("*", .x$SciName_cor, "*", " sps.")), and = ""))) %>% 
  ungroup() %>% 
  dplyr::select(-data) %>%
  unnest() %>%
  flextable(., col_keys = c("UnitCode", "sp_list")) %>%
  set_header_labels(., UnitCode = "Park", sp_list = "Unique Species") %>%
  add_header_row(., values = "Table 3. Species that were unique to each park. Species labeled with sps. could not be identified beyond the genus level.", colwidths = 2) %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  align(align = "left", part = "body", j = 2) %>%
  merge_v(j = 1) %>%
  fontsize(size = 10, part = "all") %>% 
  colformat_md() %>%
  width(j = 1:2, width = c(1, 6)) %>%
  border_inner_h(part = "body", border = fp_border(color = "grey", width = 1))
```
&nbsp;

```{r Figure 2, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=6.5, out.height=5, out.width=6.5}
ggdraw(total_cover$total_cover_df %>%
         mutate(Year = as.Date(paste0(Year_chr, "-01-01"))) %>%
         ggplot(., aes(x = Year, y = mean_year_total_cover, color = UnitCode)) +
         geom_line(data = total_cover$plot_betas, aes(x = Year, y = mean_year_total_cover), color = "black", size = 0.7) +
         geom_line(show.legend = F) +
         geom_errorbar(aes(ymin = mean_year_total_cover - se_year_total_cover, ymax = mean_year_total_cover + se_year_total_cover), color = "black") +
         geom_point(aes(fill = UnitCode), show.legend = F, shape = 21, color = "black", size = 2) +
         geom_text(data = . %>%
                     ungroup() %>%
                     distinct(UnitCode) %>%
                     mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                            f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
                   aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
                   hjust = -0.2, vjust = 2, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
         geom_text(data = total_cover$results %>%
                     bind_rows() %>%
                     filter(pval < 0.05), 
                   aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_cover_lab), 
                   hjust = -0.05, vjust = 3.95, size = 3.5, family = "serif", inherit.aes = F) +
         # geom_text(data = total_cover$total_cov_mods %>%
         #             filter(pval < 0.05) %>%
         #             mutate(f = map_chr(r2_lab, function(x) deparse(bquote(italic(.("r")^plain("2")~plain(.("="))~plain(.(x))))))),
         #           aes(x = structure(-Inf, class = "Date"), y = Inf, label = f),
         #           hjust = -0.2, vjust = 4, size = 3.5, family = "serif", parse = T, inherit.aes = F) +
         scale_color_manual(values = color_pals$park_pal) +
         scale_fill_manual(values = color_pals$park_pal) +
         lemon::facet_rep_wrap(~UnitCode, scales = "free") +
         scale_y_continuous(limits = c(0,160), breaks = seq(0,150, by = 25), labels = c("0", "", "50", "", "100", "", "150"), name = "Average total plot cover (%)", sec.axis = dup_axis()) +
         ggh4x::facetted_pos_scales(x = total_cover$plot_lims) +
         labs(caption = bquote(bold("Figure 2.")~"Average total plot cover at each park.")) +
         lfeheR::theme(base_size = 12) +
         theme(
           text = element_text(family = "serif", size = 12),
           legend.position = "none",
           axis.title.y = element_text(margin = margin(r = 10, unit = "pt")),
           panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
           strip.text = element_blank(),
           plot.caption = element_text(size = 12, hjust = -0.1, color = "transparent")
         ),
       ylim = c(-0.15,1)) +
  draw_label(bquote(bold("Figure 2.")~"Average total plot cover at each park. Black lines in panels B and C represent the rate"), fontfamily = "serif", x = 0.02, y = 0.04, size = 12, hjust = 0) +
  draw_label(bquote(plain("of change in mean total plot cover at COLO and FIIS, respectively. The rate of change in mean")), fontfamily = "serif", x = 0.02, y = -0.01, size = 12, hjust = 0) +
  draw_label(bquote(plain("total plot cover was either not significant (i.e., rate of change = 0 %/yr) for ASIS, GATE, and SAHI,")), fontfamily = "serif", x = 0.02, y = -0.06, size = 12, hjust = 0) +
  draw_label(bquote(plain("or, in the case of GEWA, could not be estimated since there were only 3 sampling events.")), fontfamily = "serif", x = 0.02, y = -0.11, size = 12, hjust = 0) 
```

 

```{r Fig 3, echo=FALSE, fig.height=5, fig.width=6.5, message=FALSE, warning=FALSE, out.height=5, out.width=6.5}
ggdraw(species_richness$park_species_richness_per_yr %>%
         left_join(., unique_species$park_unique_species_count_per_year, by = c("UnitCode", "Year_chr")) %>%
         pivot_longer(., cols = c(total_richness, n_unique), names_to = "richness_metric", values_to = "richness") %>%
         mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
                richness = if_else(is.na(richness), 0, richness),
                se = if_else(richness_metric == "total_richness", se_richness, se_n_unique)) %>%
         ungroup() %>%
         ggplot(., aes(x = Year, y = richness, color = UnitCode, fill = UnitCode, group = richness_metric)) +
         geom_line(data = species_richness$richness_plot_betas, aes(x = Year, y = site_richness), color = "black", size = 0.7) +
         geom_line(data = unique_species$unique_plot_betas, aes(x = Year, y = site_n_unique),
                   color = "black", size = 0.7) +
         geom_errorbar(aes(x = Year, ymin = richness - se, ymax = richness + se), color = "black") +
         geom_line(show.legend = F) +
         geom_point(aes(shape = richness_metric), show.legend = T, size = 2, color = "black") +
         geom_text(data = . %>%
                     ungroup() %>%
                     distinct(UnitCode) %>%
                     mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                            f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
                   aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
                   hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
         geom_text(data = species_richness$results %>%
                     bind_rows() %>%
                     filter(pval < 0.05), 
                   aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_count_lab), 
                   hjust = -0.05, vjust = 3.95, size = 3.5, family = "serif", inherit.aes = F) +
         geom_text(data = unique_species$results %>%
                     bind_rows() %>%
                     filter(pval < 0.05), 
                   aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_count_lab), 
                   hjust = -0.05, vjust = 5.5, size = 3.5, family = "serif", inherit.aes = F) +
         scale_color_manual(values = color_pals$park_pal) +
         scale_fill_manual(values = color_pals$park_pal) +
         scale_shape_manual(values = c(21, 23), breaks = c("total_richness", "n_unique"), labels = c("Total park-level species richness   ", "Unique species count")) +
         lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = F) +
         ggh4x::facetted_pos_scales(x = unique_species$plot_x_lims, y = unique_species$plot_y_lims) +
         scale_x_date(date_labels = "'%y", sec.axis = dup_axis()) +
         guides(color = "none", fill = "none") +
         labs(caption = bquote(bold("Figure 3.")~"Park-level species richness (circle points) and count of species unique to each park (diamond points).")) +
         lfeheR::theme(base_size = 12) +
         theme(
           text = element_text(family = "serif", size = 12),
           legend.position = "bottom",
           legend.title = element_blank(),
           legend.key = element_blank(),
           legend.margin = margin(t = -10, unit = "pt"),
           axis.title.y = element_text(margin = margin(r = 10, unit = "pt")),
           panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
           strip.text = element_blank(),
           plot.caption = element_text(size = 12, hjust = 0, color = "transparent")
         ),
       ylim = c(-0.2,1)) +
  draw_label(bquote(bold("Figure 3.")~"Total park-level species richness (circles) and count of species unique to each park"), x = 0.02, y = 0.04, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote("(diamonds). Black lines in panels D and E represent the rate of change in total park-level species"), x = 0.02, y = -0.01, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote("richness and the count of unique species at GATE and GEWA, respectively. The rate of change in"), fontfamily = "serif", x = 0.02, y = -0.06, size = 12, hjust = 0) +
  draw_label(bquote("total park-level species richness and count of unique species was not significant (i.e., rate of change ="), fontfamily = "serif", x = 0.02, y = -0.11, size = 12, hjust = 0) +
  draw_label(bquote("0 % sp/yr) at ASIS, COLO, FIIS, and SAHI."), fontfamily = "serif", x = 0.02, y = -0.16, size = 12, hjust = 0)
```
 
##### **3.2** Changes in Species Cover and Frequency
```{r Changes in Species Cover and Frequency, message=FALSE, warning=FALSE, include=FALSE}

species_change <- list(
  
  "cover_mods" = veg_cleaned$site_perc_cover  %>% # logistic regression with binomial distribution for cover of each species
    ungroup() %>%
    left_join(., 
              veg_cleaned$plot_perc_cover %>% 
                ungroup() %>% 
                select(UnitCode, UniqueID, Year_chr, EventID) %>% 
                group_by(UnitCode, UniqueID, Year_chr) %>% 
                summarise(plot_count = n_distinct(EventID)),
              by = c("UnitCode", "UniqueID", "Year_chr")) %>%
    group_by(UnitCode) %>%
    mutate(year = as.numeric(Year_chr),
           year_num = as.numeric(year-min(year)),
           binom_mean_site_cover = mean_site_cover/100) %>%
    group_by(UnitCode, SciName_cor) %>%
    nest() %>%
    mutate(binom_mod = map(data, ~glm(binom_mean_site_cover ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), 
           summary_mod = map(binom_mod, ~summary(.x)),
           pval = map_dbl(summary_mod, ~coefficients(.x)[[8]])) %>%
    filter(pval < 0.05) %>%
    mutate(chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
           LR_chisq = format_chi(chisq_calc),
           b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
           b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
           margs = map2(binom_mod, data, ~margins_summary(model = .x, data = .y, unit_ses = TRUE)), # https://stackoverflow.com/questions/63680030/estimating-the-average-marginal-effect-of-binary-and-continuous-coefficients-in
           change_cover = map_dbl(margs, ~.x$AME*100),
           change_cover_se = map_dbl(margs, ~.x$SE*100),
           format_p = format_pval(pval)
    ),
  
  "frq_mods" = veg_cleaned$site_frq  %>% # logistic regression with binomial distribution for frq of each species
    ungroup() %>%
    left_join(., 
              veg_cleaned$plot_perc_cover %>% 
                ungroup() %>% 
                select(UnitCode, UniqueID, Year_chr, EventID) %>% 
                group_by(UnitCode, UniqueID, Year_chr) %>% 
                summarise(plot_count = n_distinct(EventID)),
              by = c("UnitCode", "UniqueID", "Year_chr")) %>%
    group_by(UnitCode) %>%
    mutate(year = as.numeric(Year_chr),
           year_num = as.numeric(year-min(year)),
           binom_mean_site_frq = frq/100) %>%
    group_by(UnitCode, SciName_cor) %>%
    nest() %>%
    mutate(binom_mod = map(data, ~glm(binom_mean_site_frq ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
           summary_mod = map(binom_mod, ~summary(.x)),
           pval = map_dbl(summary_mod, ~coefficients(.x)[[8]])) %>%
    filter(pval < 0.05) %>%
    mutate(chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
           LR_chisq = format_chi(chisq_calc),
           
           int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
           b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
           b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]),
           margs = map2(binom_mod, data, ~margins_summary(model = .x, data = .y, unit_ses = TRUE)), # https://stackoverflow.com/questions/63680030/estimating-the-average-marginal-effect-of-binary-and-continuous-coefficients-in
           change_frq = map_dbl(margs, ~.x$AME*100),
           change_frq_se = map_dbl(margs, ~.x$SE*100),
           format_p = format_pval(pval)
    )
)

species_change[["cover_plot_betas"]] <- species_change$cover_mods %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "cover" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         cover = cover * 100)

species_change[["frq_plot_betas"]] <- species_change$frq_mods  %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "frq" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         frq = frq * 100)

species_change[["results"]] <- veg_cleaned$park_perc_cover %>%
  left_join(., veg_cleaned$park_frq, by = c("UnitCode", "Year_chr", "SciName_cor")) %>%
  rename(., "mean_park_frq" = mean_frq) %>%
  group_by(UnitCode, SciName_cor) %>%
  summarise(mean_cover = format_sps(mean(mean_park_cover)),
            mean_frq = format_sps(mean(mean_park_frq)),
            se_cover = format_sps(sd(mean_park_cover)/sqrt(length(mean_park_cover))),  
            se_frq = format_sps(sd(mean_park_frq)/sqrt(length(mean_park_frq)))) %>%
  mutate(mean_se_text_cover = paste0(mean_cover, " ± ", se_cover, "%"),
         mean_se_text_frq = paste0(mean_frq, " ± ", se_frq, "% of plots")) %>%
  left_join(., species_change$cover_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_cover" = LR_chisq, "pval_cover" = pval, "format_p_cover" = format_p, "cover_rate" = change_cover, "cover_rate_se" = change_cover_se), by = c("UnitCode", "SciName_cor")) %>%
  left_join(., species_change$frq_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_frq" = LR_chisq, "pval_frq" = pval, "format_p_frq" = format_p, "frq_rate" = change_frq, "frq_rate_se" = change_frq_se), by = c("UnitCode", "SciName_cor")) %>%
  filter(!is.na(LR_chisq_cover) | !is.na(LR_chisq_frq)) %>%
  ungroup() %>%
  mutate(change_cover = map(cover_rate, ~format_sps(.x)),
         change_cover_se = map(cover_rate_se, ~format_sps(.x)),
         change_cover_se_text = paste0(change_cover, " ± ", change_cover_se, "%/yr"),
         change_cover_lab_sp = if_else(pval_cover < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_cover_se_text),
                                     NA),
         change_frq = map(frq_rate, ~format_sps(.x)),
         change_frq_se = map(frq_rate_se, ~format_sps(.x)),
         change_frq_se_text  = paste0(change_frq, " ± ", change_frq_se, "% plots/yr"),
         change_frq_lab_sp = if_else(pval_frq < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_frq_se_text),
                                     NA)
         ) %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

species_change[["change_species_text"]] <- species_change$cover_mods %>%
  ungroup() %>%
  select(UnitCode, SciName_cor) %>%
  bind_rows(., 
            species_change$frq_mods %>%
              ungroup() %>% 
              select(UnitCode, SciName_cor),
            .id = "id") %>%
  mutate(id = if_else(id == 1, "cover", "frq")) %>%
  group_by(UnitCode, id) %>%
  nest() %>%
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                           paste0("*", .x$SciName_cor, "*"),
                                                           paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>%
  ungroup() %>%
  dplyr::select(-data) %>%
  super_split(UnitCode, id)
```

```{r Table 4, echo=FALSE, message=FALSE, warning=FALSE}
species_change$results %>%
  list_flatten() %>%
  list_rbind() %>%
  mutate(sci_name = if_else(lengths(strsplit(SciName_cor, "\\_+")) > 1,
           str_to_sentence(str_replace(SciName_cor, "_", " ")),
           paste0(str_to_sentence(str_replace(SciName_cor, "_", " "))," sps.")),
         cover_rate = if_else(!is.na(pval_cover), as.character(unlist(change_cover)), "-"),
         frq_rate = if_else(!is.na(pval_frq), as.character(unlist(change_frq)), "-")) %>% 
  ungroup() %>%
  select(UnitCode, sci_name, mean_cover, cover_rate, mean_frq, frq_rate) %>%
  
  flextable(., col_keys = c("UnitCode", "sci_name", "mean_cover", "cover_rate", "dummy1", "mean_frq", "frq_rate")) %>%
  set_header_labels(., UnitCode = "Park", sci_name = "Species", mean_cover = "Mean\n(%)", cover_rate = "Rate of change\n(%/yr)", dummy1 = "", mean_frq = "Mean\n(% of plots)", frq_rate = "Rate of change\n(% of plots/yr)") %>%
  add_header_row(., values = c("Park", "Species", "Cover", "", "Frequency"), colwidths = c(1, 1, 2, 1, 2)) %>% 
  add_header_row(., values = "Table 4. Mean percent cover and frequency of species with rates of change that were significantly different from 0 at each park.", colwidths = 7) %>%
  merge_at(i = c(2,3), j = 1, part = "header") %>%
  merge_at(i = c(2,3), j = 2, part = "header") %>%
  merge_v(j = 1, part = "body") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  mk_par(j = "sci_name", value = as_paragraph(as_i(sci_name))) %>%
  color(i = ~cover_rate != "-" & cover_rate < 0, j = 4, color = "red", part = "body") %>%
  color(i = ~cover_rate != "-" & cover_rate > 0, j = 4, color = "forestgreen", part = "body") %>%
  color(i = ~frq_rate != "-" & frq_rate < 0, j = 7, color = "red", part = "body") %>%
  color(i = ~frq_rate != "-" & frq_rate > 0, j = 7, color = "forestgreen", part = "body") %>%
  width(j = 1:7, width = c(0.5, 2, 0.6, 0.9, 0.4, 0.6, 0.9)) %>%
  fontsize(size = 10, part = "all") %>%
  hline(i = c(7,15,23,27,50), border = fp_border(color = "grey", width = 1)) %>%
  fix_border_issues()
```

##### **3.2** Threatened, Endangered, & Rare Species

```{r TE and Rare species, message=TRUE, warning=TRUE, include=FALSE}

rare_te_species <- list(
  "fed_te_species_cover" = veg_cleaned$plot_perc_cover %>% # federal TE species
    filter(!is.na(fed_TE)),
  
  "state_te_species_cover" = veg_cleaned$park_perc_cover %>% # cover of species considered TE by each state
    filter(!is.na(`State Status`)) %>%
    ungroup(),
  
  "state_te_species_frq" = veg_cleaned$park_frq %>% # frq of species considered TE by each state
    filter(!is.na(`State Status`)), 
  
  "plot_lims_x" = list(
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2009-01-01"), as.Date("2019-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y")
  ),
  
  "plot_lims_y_cover" = list(
    scale_y_continuous(limits = c(0, 3.25), breaks = c(0,1,2,3), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of state\nT&E species (%)"),
    scale_y_continuous(limits = c(0, 6.5), breaks = c(0,2,4,6), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of state\nT&E species (%)"),
    scale_y_continuous(limits = c(0, 6.5), breaks = c(0,2,4,6), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of state\nT&E species (%)")
    ),
  
  "plot_lims_y_frq" = list(
    scale_y_continuous(limits = c(0, 13), breaks = seq(0,12, by = 3), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of state\nT&E species (% of plots)"),
    scale_y_continuous(limits = c(0, 20), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of state\nT&E species (% of plots)"),
    scale_y_continuous(limits = c(0, 32), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of state\nT&E species (% of plots)")
    )
)

rare_te_species[["state_te_species_cover_mods"]] <- veg_cleaned$site_perc_cover  %>% # logistic regression with binomial distribution for state-level rare/TE species cover
  filter(!is.na(`State Status`)) %>%
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_cover = mean_site_cover/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_cover ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), 
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)), # https://stackoverflow.com/questions/63680030/estimating-the-average-marginal-effect-of-binary-and-continuous-coefficients-in
         change_cover = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_cover_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

rare_te_species[["state_te_species_frq_mods"]] <- veg_cleaned$site_frq  %>% # logistic regression with binomial distribution for state-level rare/TE species frq
  filter(!is.na(`State Status`)) %>%
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_frq = frq/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_frq ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_frq = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_frq_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

rare_te_species[["cover_plot_betas"]] <- rare_te_species$state_te_species_cover_mods  %>%
  filter(pval < 0.05) %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "cover" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         cover = cover * 100)

rare_te_species[["frq_plot_betas"]] <- rare_te_species$state_te_species_frq_mods  %>%
  filter(pval < 0.05) %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "frq" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         frq = frq * 100)

rare_te_species[["results"]] <- rare_te_species$state_te_species_cover %>%
  left_join(., rare_te_species$state_te_species_frq, by = c("UnitCode", "Year_chr", "SciName_cor")) %>%
  rename(., "mean_park_frq" = mean_frq) %>%
  group_by(UnitCode, SciName_cor) %>%
  summarise(mean_cover = format_sps(mean(mean_park_cover)),
            mean_frq = format_sps(mean(mean_park_frq)),
            se_cover = format_sps(sd(mean_park_cover)/sqrt(length(mean_park_cover))),  
            se_frq = format_sps(sd(mean_park_frq)/sqrt(length(mean_park_frq)))) %>%
  mutate(mean_se_text_cover = paste0(mean_cover, " ± ", se_cover, "%"),
         mean_se_text_frq = paste0(mean_frq, " ± ", se_frq, "% of plots")) %>%
  left_join(., rare_te_species$state_te_species_cover_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_cover" = LR_chisq, "pval_cover" = pval, "format_p_cover" = format_p, "cover_rate" = change_cover, "cover_rate_se" = change_cover_se), by = c("UnitCode", "SciName_cor")) %>%
  left_join(., rare_te_species$state_te_species_frq_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_frq" = LR_chisq, "pval_frq" = pval, "format_p_frq" = format_p, "frq_rate" = change_frq, "frq_rate_se" = change_frq_se), by = c("UnitCode", "SciName_cor")) %>%
  ungroup() %>%
  mutate(change_cover = map(cover_rate, ~format_sps(.x)),
         change_cover_se = map(cover_rate_se, ~format_sps(.x)),
         change_cover_se_text = paste0(change_cover, " ± ", change_cover_se, "%/yr"),
         change_cover_lab_sp = if_else(pval_cover < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_cover_se_text),
                                     NA),
         change_frq = map(frq_rate, ~format_sps(.x)),
         change_frq_se = map(frq_rate_se, ~format_sps(.x)),
         change_frq_se_text  = paste0(change_frq, " ± ", change_frq_se, "% plots/yr"),
         change_frq_lab_sp = if_else(pval_frq < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_frq_se_text),
                                     NA)
         ) %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

rare_te_species[["rare_te_species_text"]] <- rare_te_species$state_te_species_cover %>%
  ungroup() %>%
  select(UnitCode, SciName_cor, `State Status`) %>%
  bind_rows(., rare_te_species$state_te_species_cover %>%
              ungroup() %>%
              select(UnitCode, SciName_cor, `State Status`)) %>%
  group_by(UnitCode, `State Status`) %>%
  unique() %>%
  mutate(status = case_when(
    str_sub(`State Status`, 5) == "R" ~ "rare",
    str_sub(`State Status`, 5) == "T" ~ "threatened",
    str_sub(`State Status`, 5) == "V" ~ "vulnerable",
    str_sub(`State Status`, 5) == "E" ~ "endangered"
  ),
  state = str_sub(`State Status`, 1, 2),
  state_status_text = if_else(UnitCode != "GATE", status, paste0(status, ": ", state))) %>%
  group_by(UnitCode) %>%
  arrange(SciName_cor) %>%
  nest() %>%
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                           paste0("*", .x$SciName_cor, "*", " (", .x$state_status_text, ")"),
                                                           paste0("an unidentified ", "*", .x$SciName_cor, "*", " species", " (", .x$state_status_text, ")"))))) %>%
  ungroup() %>%
  dplyr::select(-data)
```

|       None of the species found at any of the parks were considered federally threatened or endangered as of January 2025 (Department of the Interior, Fish and Wildlife Service, 50 CFR Part 17, Docket No. FWS-HQ-ES-2023-0018; FXES1113090FEDR-245-FF09E23000, RIN 1018-BF88). A total of `r as.character(english(rare_te_species$state_te_species_cover %>% ungroup() %>% select(SciName_cor) %>% n_distinct()))` species were considered endangered, rare, threatened, or vulnerable at the state level and were found in either FIIS, GATE, or SAHI. None of the species found at either ASIS, COLO, or GEWA were considered endangered, rare, threatened, or vulnerable at the state level.

##### *3.2.1 Endangered, Rare, Threatened, & Vulnerable Species: FIIS*

|       At FIIS, a total of `r as.character(english(rare_te_species$results$FIIS %>% bind_rows() %>% n_distinct(.$SciName_cor)))` species were considered threatened or vulnerable by the State of New York (Table 4), including `r rare_te_species[["rare_te_species_text"]] %>% filter(UnitCode == "FIIS") %>% unlist("sp_list") %>% pluck("sp_list")`. *Limonium carolinianum* was found during every sampling event at FIIS although both the mean cover (mean: `r rare_te_species$results$FIIS$limonium_carolinianum$mean_se_text_cover`; Figure 4a) and frequency (mean: `r rare_te_species$results$FIIS$limonium_carolinianum$mean_se_text_frq`; Figure 4d) remained unchanged over the study period. *Salicornia bigelovii* was found in only a single plot in 2009. The mean cover (mean: `r rare_te_species$results$FIIS$salicornia_bigelovii$mean_se_text_cover`; Figure 4a) remained unchanged, whereas the frequency of *Salicornia bigelovii* decreased at a rate of `r rare_te_species$results$FIIS$salicornia_bigelovii$change_frq_se_text` 
 (*p* `r rare_te_species$results$FIIS$salicornia_bigelovii$format_p_frq`; mean: `r rare_te_species$results$FIIS$salicornia_bigelovii$mean_se_text_frq`; Figure 4d). *Thelypteris palustris* was only found during 2009 and 2011 at FIIS. The mean cover (mean: `r rare_te_species$results$FIIS$thelypteris_palustris$mean_se_text_cover`; Figure 4a) remained unchanged, whereas the frequency of *Thelypteris palustris* decreased at a rate of `r rare_te_species$results$FIIS$thelypteris_palustris$change_frq_se_text` (*p* `r rare_te_species$results$FIIS$thelypteris_palustris$format_p_frq`; mean: `r rare_te_species$results$FIIS$thelypteris_palustris$mean_se_text_frq`; Figure 4d).

##### *3.2.2 Endangered, Rare, Threatened, & Vulnerable Species: GATE*

|       At GATE, a total of `r as.character(english(rare_te_species$results$GATE %>% bind_rows() %>% n_distinct(.$SciName_cor)))` species were considered endangered, rare, threatened, or vulnerable by either New York or New Jersey, including `r rare_te_species[["rare_te_species_text"]] %>% filter(UnitCode == "GATE") %>% unlist("sp_list") %>% pluck("sp_list")` (Table 4). *Cenchrus tribuloides* was found in only a single plot in 2018. Both the mean cover (mean: `r rare_te_species$results$GATE$cenchrus_tribuloides$mean_se_text_cover`; Figure 4b) and frequency (mean: `r rare_te_species$results$GATE$cenchrus_tribuloides$mean_se_text_frq`; Figure 4e) of *Cenchrus tribuloides* remained unchanged over the study period. *Limonium carolinianum* was found during every sampling event at GATE although both the mean cover (mean: `r rare_te_species$results$GATE$limonium_carolinianum$mean_se_text_cover`; Figure 4b) and frequency (mean: `r rare_te_species$results$GATE$limonium_carolinianum$mean_se_text_frq`; Figure 4e) of *Limonium carolinianum* remained unchanged over the study period. *Myrica gale* was found in only a single plot in 2018. Both the mean cover (mean: `r rare_te_species$results$GATE$myrica_gale$mean_se_text_cover`; Figure 4b) and frequency (mean: `r rare_te_species$results$GATE$myrica_gale$mean_se_text_frq`; Figure 4e) of *Myrica gale* remained unchanged over the study period. *Opuntia humifusa* was found in only a single plot in 2018. Both the mean cover (mean: `r rare_te_species$results$GATE$opuntia_humifusa$mean_se_text_cover`; Figure 4b) and frequency (mean: `r rare_te_species$results$GATE$opuntia_humifusa$mean_se_text_frq`; Figure 4e) of *Opuntia humifusa* remained unchanged over the study period. The mean cover of *Salicornia bigelovii* decreased at a rate of `r rare_te_species$results$GATE$salicornia_bigelovii$change_cover_se_text` (*p* `r rare_te_species$results$GATE$salicornia_bigelovii$format_p_frq`; mean: `r rare_te_species$results$GATE$salicornia_bigelovii$mean_se_text_cover`; Figure 4b), and the frequency decreased at a rate of `r rare_te_species$results$GATE$salicornia_bigelovii$change_frq_se_text` (*p* `r rare_te_species$results$GATE$salicornia_bigelovii$format_p_frq`; mean: `r rare_te_species$results$GATE$salicornia_bigelovii$mean_se_text_frq`; Figure 4e). *Suaeda linearis* was found in 10 plots at GATE in 2010, but was not found again in any other years. Both the mean cover (mean: `r rare_te_species$results$GATE$suaeda_linearis$mean_se_text_cover`; Figure 4b) and frequency (mean: `r rare_te_species$results$GATE$suaeda_linearis$mean_se_text_frq`; Figure 4e) of *Suaeda linearis* remained unchanged over the study period.

##### *3.2.3 Endangered, Rare, Threatened, & Vulnerable Species: SAHI*

|       At SAHI, a total of `r as.character(english(rare_te_species$results$SAHI %>% bind_rows() %>% n_distinct(.$SciName_cor)))` species were considered threatened or endangered by the State of New York, including `r rare_te_species[["rare_te_species_text"]] %>% filter(UnitCode == "SAHI") %>% unlist("sp_list") %>% pluck("sp_list")` (Table 4). Notably, *Limonium carolinianum* was found during every sampling event at SAHI. However, both the mean cover (mean: `r rare_te_species$results$SAHI$limonium_carolinianum$mean_se_text_cover`; Figure 4c), and frequency (mean: `r rare_te_species$results$SAHI$limonium_carolinianum$mean_se_text_frq`; Figure 4f) of *Limonium carolinianum* remained unchanged over the study period. *Panicum amarum* was found in 2009, 2015, and 2017 at SAHI. Both the mean cover (mean: `r rare_te_species$results$SAHI$panicum_amarum$mean_se_text_cover`; Figure 4c) and frequency (mean: `r rare_te_species$results$SAHI$panicum_amarum$mean_se_text_frq`; Figure 4f) of *Panicum amarum* remained unchanged over the study period.
&nbsp;

```{r Table 4, echo=FALSE, message=FALSE, warning=FALSE}
rare_te_species$results %>%
  list_flatten() %>%
  list_rbind() %>%
  mutate(sci_name = str_to_sentence(str_replace(SciName_cor, "_", " ")),
         cover_rate = if_else(pval_cover < 0.05, as.character(unlist(change_cover)), "-"),
         frq_rate = if_else(pval_frq < 0.05, as.character(unlist(change_frq)), "-")) %>%
  left_join(., rare_te_species$state_te_species_cover %>%
              select(UnitCode, SciName_cor, "state_stat" = `State Status`) %>%
              distinct(),
            by = c("UnitCode", "sci_name" = "SciName_cor")) %>%
  mutate(state = str_sub(state_stat, 1, 2),
         status = case_when(str_sub(state_stat, -1) == "V" ~ "Vulnerable",
                            str_sub(state_stat, -1) == "T" ~ "Threatened",
                            str_sub(state_stat, -1) == "E" ~ "Endangered",
                            str_sub(state_stat, -1) == "R" ~ "Rare"),
         state_status = paste0(status, " (", state, ")")) %>%
  ungroup() %>%
  select(UnitCode, sci_name, state_status, mean_cover, cover_rate, mean_frq, frq_rate) %>%
  add_row(UnitCode = c("ASIS", "COLO"), sci_name = "-", state_status = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-", .before = 1) %>%
  add_row(UnitCode = "GEWA", sci_name = "-", state_status = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-", .before = 12) %>%
  flextable(., col_keys = c("UnitCode", "sci_name", "state_status", "mean_cover", "cover_rate", "mean_frq", "frq_rate")) %>%
  set_header_labels(., UnitCode = "Park", sci_name = "Species", state_status =  "State Status", mean_cover = "Mean\n(%)", cover_rate = "Rate of change\n(%/yr)", mean_frq = "Mean\n(% of plots)", frq_rate = "Rate of change\n(% of plots/yr)") %>%
  add_header_row(., values = c("Park", "Species", "State Status", "Cover", "Frequency"), colwidths = c(1, 1, 1, 2, 2)) %>% 
  add_header_row(., values = "Table 4. Mean percent cover and frequency of species that were considered endangered, rare, threatened, or vulnerable by the state where each park is located. None of the species found at either ASIS, COLO, or GEWA were considered endangered, rare, threatened, or vulnerable at the state level. Note that only rates of change that were significantly different from 0 are shown.", colwidths = 7) %>%
  merge_at(i = c(2,3), j = 1, part = "header") %>%
  merge_at(i = c(2,3), j = 2, part = "header") %>%
  merge_at(i = c(2,3), j = 3, part = "header") %>%
  merge_v(j = 1, part = "body") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  mk_par(j = "sci_name", value = as_paragraph(as_i(sci_name))) %>%
  color(i = ~cover_rate != "-", j = 5, color = "red", part = "body") %>%
  color(i = ~frq_rate != "-", j = 7, color = "red", part = "body") %>%
  width(j = 1:7, width = c(0.55, 1.5, 1.2, 0.59, 0.9, 0.8, 1)) %>%
  fontsize(size = 10, part = "all") %>%
  hline(i = c(1,2,5,11,12), border = fp_border(color = "grey", width = 1)) %>%
  fix_border_issues()
```
&nbsp;

```{r State TE species plot, echo=FALSE, fig.height=5.2, fig.width=6.5, message=FALSE, warning=FALSE, out.height=5.2, out.width=6.5}

rare_te_plot <- function(...){
  rare_te_cover_plot <- rare_te_species$state_te_species_cover %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    mutate(n_years = n_distinct(Year_chr)) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_park_cover)) +
    geom_line(data = rare_te_species$cover_plot_betas %>% 
                mutate(SciName_lab = paste0(SciName_cor, "   ")), 
              aes(x = Year, y = cover, color = SciName_lab), linetype = "dashed", size = 0.7)+
    geom_errorbar(aes(ymin = mean_park_cover - se_park_cover, ymax = mean_park_cover + se_park_cover, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    geom_text(data = rare_te_species$results$GATE$salicornia_bigelovii, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_cover_lab_sp), 
              hjust = -0.05, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T) +
    ggh4x::facetted_pos_scales(x = rare_te_species$plot_lims_x, y = rare_te_species$plot_lims_y_cover) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      axis.title.x.bottom = element_blank(),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  rare_te_frq_plot <- rare_te_species$state_te_species_frq %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    mutate(n_years = n_distinct(Year_chr)) %>%
    filter(n_years > 1) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_frq)) +
    geom_line(data = rare_te_species$frq_plot_betas %>% 
                mutate(SciName_lab = paste0(SciName_cor, "   ")), 
              aes(x = Year, y = frq, color = SciName_lab), linetype = "dashed", size = 0.7)+
    geom_errorbar(aes(ymin = mean_frq - se_frq, ymax = mean_frq + se_frq, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[4:6], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    geom_text(data = rare_te_species$results$FIIS$salicornia_bigelovii, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp), 
              hjust = -0.05, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
     geom_text(data = rare_te_species$results$FIIS$thelypteris_palustris, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp), 
              hjust = -0.05, vjust = 4.75, size = 3.5, family = "serif", inherit.aes = F) +
    geom_text(data = rare_te_species$results$GATE$salicornia_bigelovii, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp), 
              hjust = -0.05, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T) +
    ggh4x::facetted_pos_scales(x = rare_te_species$plot_lims_x, y = rare_te_species$plot_lims_y_frq) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.x.bottom = element_blank(),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  rare_te_legend <- get_legend(
    ggplot(veg_cleaned$plot_perc_cover 
           %>% filter(SciName_cor %in% c("Cenchrus tribuloides", "Limonium carolinianum", "Myrica gale","Opuntia humifusa", "Panicum amarum", "Salicornia bigelovii", "Suaeda linearis", "Thelypteris palustris")), 
           aes(x = Year_chr, y = PercentCover), group = SciName_cor) +
      geom_line(aes(color = SciName_cor)) +
      geom_point(aes(fill = SciName_cor), shape = 21, size = 2, color = "black") +
      guides(color = guide_legend(title = "Species:", nrow = 3), fill = guide_legend(title = "Species:", nrow = 3)) +
      lfeheR::theme(base_size = 12) +
      theme(
        text = element_text(family = "serif", size = 12),
        legend.key = element_rect(color = "transparent"),
        legend.key.spacing.y = unit(0,"cm"),
        legend.text = element_text(face = "italic"),
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "transparent")
      )
  )
  
  ggdraw() +
    draw_plot(plot_grid(rare_te_cover_plot + theme(legend.position = "none"), rare_te_frq_plot + theme(legend.position = "none"), nrow = 2, align = "vh"), y = 0.36, height = 0.64) +
    draw_label("Year", x = 0.525, y = 0.35, fontfamily = "serif", size = 12, hjust = 0) +
    draw_plot(rare_te_legend, y = -0.24, height = 1) +
    draw_label(bquote(bold("Figure 4.")~"Average mean cover (a, b, and c) and frequency (d, e, and f) of state-level endangered,"), x = 0.02, y = 0.15, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("rare, threatened, or vulnerable species at FIIS, GATE, and SAHI. Dashed lines represent significant"), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("rates of change in mean mean cover or frequency. Species abbreviations are as follows:"), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("SABI ="~italic("Salicornia bigelovii")~"and THPA ="~italic("Thelypteris palustris")*"."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12) 
}

rare_te_plot()
```

 

##### **3.3** Species of Management Concern

```{r NPSpecies highlighted, message=FALSE, warning=FALSE, include=FALSE}
manage_species <- list(
  
  "manage_species_cover" = veg_cleaned$park_perc_cover %>%
    rename("NPS_Tags" = `NPS Tags`) %>%
    filter(!is.na(NPS_Tags)),
  
  "manage_species_frq" = veg_cleaned$park_frq %>%
    rename("NPS_Tags" = `NPS Tags`) %>%
    filter(!is.na(NPS_Tags)),
  
  "plot_lims_x" = list(
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2009-01-01"), as.Date("2019-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y")
  ),
  
  "plot_lims_y_cover" = list(
    scale_y_continuous(limits = c(0, 8.5), breaks = seq(0,8, by = 2), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of managed\nspecies (%)"),
    scale_y_continuous(limits = c(0, 8.5), breaks = seq(0,8, by = 2), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of managed\nspecies (%)"),    
    scale_y_continuous(limits = c(0, 12.5), breaks = seq(0,12, by = 3), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of managed\nspecies (%)"),
    scale_y_continuous(limits = c(0, 6.5), breaks = seq(0,6, by = 2), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of managed\nspecies (%)")
    ),
  
  "plot_lims_y_frq" = list(
    scale_y_continuous(limits = c(0, 32), breaks = seq(0,30, by = 10), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of managed\nspecies (% of plots)"),
    scale_y_continuous(limits = c(0, 32), breaks = seq(0,30, by = 10), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of managed\nspecies (% of plots)"),
    scale_y_continuous(limits = c(0, 25), breaks = seq(0,27, by = 5), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of managed\nspecies (% of plots)"),
    scale_y_continuous(limits = c(0, 4.5), breaks = seq(0,4, by = 1), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of managed\nspecies (% of plots)")
    )
)

manage_species[["manage_species_cover_mods"]] <- veg_cleaned$site_perc_cover %>% # logistic regression with binomial distribution for NPSpecies cover
  rename("NPS_Tags" = `NPS Tags`) %>%
  filter(!is.na(NPS_Tags)) %>%  
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_cover = mean_site_cover/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_cover ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_cover = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_cover_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

manage_species[["manage_species_frq_mods"]] <- veg_cleaned$site_frq %>% # logistic regression with binomial distribution for NPSpecies frq
  rename("NPS_Tags" = `NPS Tags`) %>%
  filter(!is.na(NPS_Tags)) %>%    
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_frq = frq/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_frq ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_frq = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_frq_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

manage_species[["cover_plot_betas"]] <- manage_species$manage_species_cover_mods  %>%
  filter(pval < 0.05) %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = if_else(UnitCode == "GATE",
                                map(data, ~min(.x$year_num)-(2)),
                                map(data, ~min(.x$year_num)-(1))),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "cover" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         cover = cover * 100)

manage_species[["cover_plot_betas"]] <- manage_species$manage_species_cover_mods  %>%
  filter(pval < 0.05) %>%
  mutate(
         min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = map(data, ~min(.x$year_num)-(1)),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "cover" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         cover = cover * 100)

manage_species[["frq_plot_betas"]] <- manage_species$manage_species_frq_mods %>% 
  filter(pval < 0.05) %>%
  mutate(min_date = map(data, ~as.Date(paste0(min(.x$year), "-01-01"))-(0.4*365.25)),
         min_date_num = if_else(UnitCode == "GATE",
                                map(data, ~min(.x$year_num)-(2)), 
                                map(data, ~min(.x$year_num)-(1))),
         max_date_num = map(data, ~max(.x$year_num)+(2)),
         nd = map2(min_date_num, max_date_num, ~data.frame("year_num" = seq(.x, .y, by = 0.5))),
         pred = map2(binom_mod, nd, ~data.frame(bind_cols(nd, "frq" = predict(.x, newdata = .y, type = "response"))))
  ) %>%
  select(UnitCode, SciName_cor, pred, min_date, min_date_num, max_date_num) %>%
  unnest(cols = c(pred, min_date, min_date_num, max_date_num)) %>%
  mutate(Year = as.Date(min_date) + (year_num*365.25),
         frq = frq * 100)

manage_species[["results"]] <- manage_species$manage_species_cover %>%
  left_join(., manage_species$manage_species_frq, by = c("UnitCode", "Year_chr", "SciName_cor")) %>%
  rename(., "mean_park_frq" = mean_frq) %>%
  group_by(UnitCode, SciName_cor) %>%
  summarise(mean_cover = format_sps(mean(mean_park_cover)),
            mean_frq = format_sps(mean(mean_park_frq)),
            se_cover = format_sps(sd(mean_park_cover)/sqrt(length(mean_park_cover))),  
            se_frq = format_sps(sd(mean_park_frq)/sqrt(length(mean_park_frq)))) %>%
  mutate(mean_se_text_cover = paste0(mean_cover, " ± ", se_cover, "%"),
         mean_se_text_frq = paste0(mean_frq, " ± ", se_frq, "% of plots")) %>%
  left_join(., manage_species$manage_species_cover_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_cover" = LR_chisq, "pval_cover" = pval, "format_p_cover" = format_p, "cover_rate" = change_cover, "cover_rate_se" = change_cover_se), by = c("UnitCode", "SciName_cor")) %>%
  left_join(., manage_species$manage_species_frq_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_frq" = LR_chisq, "pval_frq" = pval, "format_p_frq" = format_p, "frq_rate" = change_frq, "frq_rate_se" = change_frq_se), by = c("UnitCode", "SciName_cor")) %>%
  ungroup() %>%
  mutate(change_cover = map(cover_rate, ~format_sps(.x)),
         change_cover_se = map(cover_rate_se, ~format_sps(.x)),
         change_cover_se_text = paste0(change_cover, " ± ", change_cover_se, "%/yr"),
         change_cover_lab_sp = if_else(pval_cover < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_cover_se_text),
                                     NA),
         change_frq = map(frq_rate, ~format_sps(.x)),
         change_frq_se = map(frq_rate_se, ~format_sps(.x)),
         change_frq_se_text  = paste0(change_frq, " ± ", change_frq_se, "% plots/yr"),
         change_frq_lab_sp = if_else(pval_frq < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_frq_se_text),
                                     NA)
         ) %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

manage_species[["manage_species_text"]] <- manage_species$manage_species_cover %>%
  ungroup() %>%
  select(UnitCode, SciName_cor, NPS_Tags) %>%
  group_by(UnitCode, NPS_Tags) %>%
  unique() %>%
  arrange(SciName_cor) %>%
  nest() %>%
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                           paste0("*", .x$SciName_cor, "*"),
                                                           paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>%
  ungroup() %>%
  dplyr::select(-data)
```

|       A total of `r manage_species$manage_species_cover %>% pluck("SciName_cor") %>% n_distinct()` species were noted as "management priority" and/or "exploitation concern" in NPSpecies and were found in either COLO, FIIS, GATE, or SAHI. None of the species found at either ASIS or GEWA were noted with these labels.

##### *3.3.1 Species of Management Concern: COLO*

|       At COLO, only a single species - `r manage_species[["manage_species_text"]] %>% filter(UnitCode == "COLO") %>% unlist("sp_list") %>% pluck("sp_list")` - was noted as "management priority" in NPSpecies. *Phragmites australis* was found in every year at COLO, although both the mean cover (`r manage_species$results$COLO$phragmites_australis$mean_se_text_cover`; Figure 5a) and frequency (`r manage_species$results$COLO$phragmites_australis$mean_se_text_frq`; Figure 5c) remained unchanged over the study period (Table 5).

##### *3.3.2 Species of Management Concern: FIIS*

|       At FIIS, `r as.character(english(manage_species$manage_species_cover %>% filter(UnitCode == "FIIS" & NPS_Tags == "Management Priority") %>% ungroup() %>% distinct(SciName_cor) %>% nrow()))` species were noted as "management priority" in NPSpecies including `r manage_species[["manage_species_text"]] %>% filter(UnitCode == "FIIS" & NPS_Tags == "Management Priority") %>% unlist("sp_list") %>% pluck("sp_list")` (Table 5). Additionally, `r as.character(english(manage_species$manage_species_cover %>% filter(UnitCode == "FIIS" & NPS_Tags != "Management Priority") %>% ungroup() %>% distinct(SciName_cor) %>% nrow()))` species at FIIS were noted as both "management priority" and "exploitation concern" including `r manage_species[["manage_species_text"]] %>% filter(UnitCode == "FIIS" & NPS_Tags == "Exploitation Concern, Management Priority") %>% unlist("sp_list") %>% pluck("sp_list")` (Table 5). *Elaeagnus umbellata* was only found during a single sampling event in 2015. Both the mean cover (mean: `r manage_species$results$FIIS$elaeagnus_umbellata$mean_se_text_cover`; Figure 5b) and frequency (mean: `r manage_species$results$FIIS$elaeagnus_umbellata$mean_se_text_frq`; Figure 5d) of *Elaeagnus umbellata* remained unchanged over the study period. *Limonium carolinianum* was found in every year at FIIS, although both the mean cover (mean: `r manage_species$results$FIIS$limonium_carolinianum$mean_se_text_cover`; Figure 5b) and frequency (mean: `r manage_species$results$FIIS$limonium_carolinianum$mean_se_text_frq`; Figure 5d) remained unchanged over the study period. *Morella pensylvanica* was only found during a single sampling event in 2011. The mean cover (mean: `r manage_species$results$FIIS$morella_pensylvanica$mean_se_text_cover`; Figure 5b) and frequency (mean: `r manage_species$results$FIIS$morella_pensylvanica$mean_se_text_frq`; Figure 5d) of *Morella pensylvanica* remained unchanged over the study period. *Phragmites australis* was found in every year at FIIS, although both the mean cover (mean: `r manage_species$results$FIIS$phragmites_australis$mean_se_text_cover`; Figure 5b) and frequency (mean: `r manage_species$results$FIIS$phragmites_australis$mean_se_text_frq`; Figure 5d) remained unchanged over the study period. *Salicornia bigelovii* was only found during a single sampling event in 2011. The mean cover remained unchanged over the study period (mean: `r manage_species$results$FIIS$salicornia_bigelovii$mean_se_text_cover`; Figure 5b), whereas the frequency of *Salicornia bigelovii* decreased at a rate of `r manage_species$results$FIIS$salicornia_bigelovii$change_frq_se_text` (*p* `r manage_species$results$FIIS$salicornia_bigelovii$format_p_frq`; mean: `r manage_species$results$FIIS$salicornia_bigelovii$mean_se_text_frq`; Figure 5d). *Thelypteris palustris* was only found during two sampling events at FIIS between `r study_years$FIIS$min_year` to `r study_years$FIIS$max_year`. The mean cover of *Thelypteris palustris* remained unchanged over the study period (mean: `r manage_species$results$FIIS$thelypteris_palustris$mean_se_text_cover`; Figure 5b), whereas the frequency decreased at a rate of `r manage_species$results$FIIS$thelypteris_palustris$change_frq_se_text` (*p* `r manage_species$results$FIIS$thelypteris_palustris$format_p_frq`; mean: `r manage_species$results$FIIS$thelypteris_palustris$mean_se_text_frq`; Figure 5d).
&nbsp;

```{r Table 5, echo=FALSE, message=FALSE, warning=FALSE}
manage_species$results %>%
  list_flatten() %>%
  list_rbind() %>%
  mutate(sci_name = str_to_sentence(str_replace(SciName_cor, "_", " ")),
         cover_rate = if_else(pval_cover < 0.05, as.character(unlist(change_cover)), "-"),
         frq_rate = if_else(pval_frq < 0.05, as.character(unlist(change_frq)), "-")) %>%
  left_join(., manage_species$manage_species_cover %>%
              ungroup() %>%
              select(UnitCode, SciName_cor, NPS_Tags) %>%
              distinct(),
            by = c("UnitCode", "sci_name" = "SciName_cor")) %>%
  mutate(nps_label = case_when(NPS_Tags == "Management Priority" ~ "MP",
                               NPS_Tags == "Exploitation Concern, Management Priority" ~ "MP/EC")) %>%
  ungroup() %>%
  select(UnitCode, sci_name, nps_label, mean_cover, cover_rate, mean_frq, frq_rate) %>%
  add_row(UnitCode = c("ASIS"), sci_name = "-", nps_label = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-", .before = 1) %>%
  add_row(UnitCode = "GEWA", sci_name = "-", nps_label = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-", .before = 12) %>%
  flextable(., col_keys = c("UnitCode", "sci_name", "nps_label", "mean_cover", "cover_rate", "mean_frq", "frq_rate")) %>%
  set_header_labels(., UnitCode = "Park", sci_name = "Species", nps_label =  "NPSpecies Label", mean_cover = "Mean\n(%)", cover_rate = "Rate of change\n(%/yr)", mean_frq = "Mean\n(% of plots)", frq_rate = "Rate of change\n(% of plots/yr)") %>%
  add_header_row(., values = c("Park", "Species", "NPS Label", "Cover", "Frequency"), colwidths = c(1, 1, 1, 2, 2)) %>% 
  add_header_row(., values = "Table 5. Mean percent cover and frequency of species noted as \"management priority\" and/or \"exploitation concern\" in NPSpecies. None of the species found at either ASIS or GEWA were noted with these labels. Note that only rates of change that were significantly different from 0 are shown.", colwidths = 7) %>%
  merge_at(i = c(2,3), j = 1, part = "header") %>%
  merge_at(i = c(2,3), j = 2, part = "header") %>%
  merge_at(i = c(2,3), j = 3, part = "header") %>%
  merge_v(j = 1, part = "body") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  mk_par(j = "sci_name", value = as_paragraph(as_i(sci_name))) %>%
  color(i = ~cover_rate != "-", j = 5, color = "red", part = "body") %>%
  color(i = ~frq_rate != "-", j = 7, color = "red", part = "body") %>%
  width(j = 1:7, width = c(0.55, 1.5, 1.2, 0.59, 0.9, 0.8, 1)) %>%
  fontsize(size = 10, part = "all") %>%
  hline(i = c(1,2,8,11,12,16), border = fp_border(color = "grey", width = 1)) %>%
  fix_border_issues()
```
&nbsp;

```{r Species of Management Concern plot 1, echo=FALSE, fig.height=5.5, fig.width=5.25, message=FALSE, warning=FALSE, out.height=5.5, out.width=5.25}

manage_plot1 <- function(...){
  manage_cover_plot <- manage_species$manage_species_cover %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    filter(UnitCode %in% c("COLO", "FIIS")) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_park_cover)) +
    geom_errorbar(aes(ymin = mean_park_cover - se_park_cover, ymax = mean_park_cover + se_park_cover, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = manage_species$plot_lims_x[1:2], y = manage_species$plot_lims_y_cover[1:2]) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      axis.title.x.bottom = element_blank(),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  manage_frq_plot <- manage_species$manage_species_frq %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    filter(UnitCode %in% c("COLO", "FIIS")) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_frq)) +
    geom_line(data = manage_species$frq_plot_betas %>%
                filter(UnitCode %in% c("COLO", "FIIS")) %>%
                mutate(SciName_lab = paste0(SciName_cor, "   ")),
              aes(x = Year, y = frq, color = SciName_lab), linetype = "dashed", size = 0.7) +
    geom_errorbar(aes(ymin = mean_frq - se_frq, ymax = mean_frq + se_frq, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[3:4], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
     geom_text(data = manage_species$results$FIIS$salicornia_bigelovii, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp), 
              hjust = -0.05, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
     geom_text(data = manage_species$results$FIIS$thelypteris_palustris, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp), 
              hjust = -0.05, vjust = 4.75, size = 3.5, family = "serif", inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = manage_species$plot_lims_x[1:2], y = manage_species$plot_lims_y_frq[1:2]) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.x.bottom = element_blank(),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  manage_legend <- get_legend(
    ggplot(veg_cleaned$plot_perc_cover %>% 
             filter(SciName_cor %in% c("Elaeagnus umbellata", "Limonium carolinianum", "Morella pensylvanica", "Phragmites australis", "Salicornia bigelovii", "Thelypteris palustris")),
           aes(x = Year_chr, y = PercentCover), group = SciName_cor) +
      geom_line(aes(color = SciName_cor)) +
      geom_point(aes(fill = SciName_cor), shape = 21, size = 2, color = "black") +
      guides(color = guide_legend(title = "Species:", nrow = 3), fill = guide_legend(title = "Species:", nrow = 3)) +
      lfeheR::theme(base_size = 12) +
      theme(
        text = element_text(family = "serif", size = 12),
        legend.key = element_rect(color = "transparent"),
        legend.key.spacing.y = unit(0,"cm"),
        legend.text = element_text(face = "italic"),
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "transparent")
      )
  )
  
  ggdraw() +
    draw_plot(plot_grid(manage_cover_plot + theme(legend.position = "none"), manage_frq_plot + theme(legend.position = "none"), nrow = 2, align = "vh"), y = 0.38, height = 0.62) +
    draw_label("Year", x = 0.525, y = 0.37, fontfamily = "serif", size = 12, hjust = 0) +
    draw_plot(manage_legend, y = -0.22, height = 1) +
    draw_label(bquote(bold("Figure 5.")~"Average mean cover (a and b) and frequency (c and d) of species"), x = 0.02, y = 0.19, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("of management concern within NPSpecies at COLO and FIIS. Dashed lines"), x = 0.02, y = 0.15, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("represent significant rates of change in mean cover or frequency."), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("Species abbreviations are as follows: SABI ="~italic("Salicornia bigelovii")~"and THPA ="), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote(italic("Thelypteris palustris")*"."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
}

manage_plot1()
```

##### *3.3.3 Species of Management Concern: GATE*

|       At GATE, `r as.character(english(manage_species$results$GATE %>% bind_rows() %>% n_distinct("SciName_cor")))` species were noted as "management priority", including `r manage_species[["manage_species_text"]] %>% filter(UnitCode == "GATE" & NPS_Tags == "Management Priority") %>% unlist("sp_list") %>% pluck("sp_list")` (Table 5). *Artemisia vulgaris* was found during 2014, 2016, and 2018 at GATE. Both the mean cover (mean: `r manage_species$results$GATE$artemisia_vulgaris$mean_se_text_cover`; Figure 6a) and frequency (mean: `r manage_species$results$GATE$artemisia_vulgaris$mean_se_text_frq`; Figure 6c) of *Artemisia vulgaris* remained unchanged over the study period. *Cenchrus tribuloides* was only found during 2018 at GATE. Both the mean cover (mean: `r manage_species$results$GATE$cenchrus_tribuloides$mean_se_text_cover`; Figure 6a) and frequency (mean: `r manage_species$results$GATE$cenchrus_tribuloides$mean_se_text_frq`; Figure 6c) of *Cenchrus tribuloides* remained unchanged over the study period. *Iva frustescens* was found in every year at GATE. The mean cover decreased at a rate of `r manage_species$results$GATE$iva_frutescens$change_cover_se_text` (*p* `r manage_species$results$GATE$iva_frutescens$format_p_cover`; mean: `r manage_species$results$GATE$iva_frutescens$mean_se_text_cover`; Figure 6a), whereas the frequency (mean: `r manage_species$results$GATE$iva_frutescens$mean_se_text_frq`; Figure 6c) of *Iva frustescens* remained unchanged over the study period. *Lonicera japonica* was found during only two sampling events at GATE in 2012 and 2018. The mean cover (mean: `r manage_species$results$GATE$lonicera_japonica$mean_se_text_cover`; Figure 6a) and frequency (mean: `r manage_species$results$GATE$lonicera_japonica$mean_se_text_cover`; Figure 6c) of *Lonicera japonica* remained unchanged over the study period. *Phragmites australis* was found during only two sampling events at GATE in 2012 and 2016. The mean cover (mean: `r manage_species$results$GATE$phragmites_australis$mean_se_text_cover`; Figure 6a) and frequency (mean: `r manage_species$results$GATE$phragmites_australis$mean_se_text_frq`; Figure 6c) of *Phragmites australis* remained unchanged over the study period. *Salicornia bigelovii* was found during only two sampling events at GATE in 2010 and 2012. The mean cover of *Salicornia bigelovii* decreased at a rate of `r manage_species$results$GATE$salicornia_bigelovii$change_cover_se_text` (*p* `r manage_species$results$GATE$salicornia_bigelovii$format_p_cover`; mean: `r manage_species$results$GATE$salicornia_bigelovii$mean_se_text_cover`; Figure 6a) and the frequency decreased at a rate of `r manage_species$results$GATE$salicornia_bigelovii$change_frq_se_text` (*p* `r manage_species$results$GATE$salicornia_bigelovii$format_p_frq`; mean: `r manage_species$results$GATE$salicornia_bigelovii$mean_se_text_frq`; Figure 6c) over the study period. *Suaeda linearis* was only found during 2010 at GATE. The mean cover (mean: `r manage_species$results$GATE$suaeda_linearis$mean_se_text_cover`; Figure 6a) and frequency (mean: `r manage_species$results$GATE$suaeda_linearis$mean_se_text_frq`; Figure 6c) of *Suaeda  linearis* remained unchanged over the study period.

##### *3.3.4 Species of Management Concern: SAHI*

|       At SAHI, only a single species - *Panicum amarum* - was noted as "management priority" in NPSpecies (Table 5). Both the mean cover (`r manage_species$results$SAHI$panicum_amarum$mean_se_text_cover`; Figure 5d) and frequency (`r manage_species$results$SAHI$panicum_amarum$mean_se_text_frq`; Figure 5h) of *Panicum amarum* remained unchanged over the study period.
&nbsp;

```{r Species of Management Concern plot 2, echo=FALSE, fig.height=5.5, fig.width=6.05, message=FALSE, warning=FALSE, out.height=5.5, out.width=6.05}
manage_plot2 <- function(...){
  manage_cover_plot <- manage_species$manage_species_cover %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    filter(UnitCode %in% c("GATE", "SAHI")) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_park_cover)) +
    geom_line(data = manage_species$cover_plot_betas %>%
                filter(UnitCode %in% c("GATE", "SAHI")) %>%
                mutate(SciName_lab = paste0(SciName_cor, "   ")),
              aes(x = Year, y = cover, color = SciName_lab), linetype = "dashed", size = 0.7) +
    geom_errorbar(aes(ymin = mean_park_cover - se_park_cover, ymax = mean_park_cover + se_park_cover, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    geom_text(data = manage_species$results$GATE$iva_frutescens, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_cover_lab_sp), 
              hjust = -1, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
    geom_text(data = manage_species$results$GATE$salicornia_bigelovii, 
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_cover_lab_sp), 
              hjust = -1, vjust = 4.75, size = 3.5, family = "serif", inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = manage_species$plot_lims_x[3:4], y = manage_species$plot_lims_y_cover[3:4]) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      axis.title.x.bottom = element_blank(),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  manage_frq_plot <- manage_species$manage_species_frq %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    mutate(n_years = n_distinct(Year_chr)) %>%
    filter(n_years > 1 & UnitCode %in% c("GATE", "SAHI")) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_frq)) +
    geom_line(data = manage_species$frq_plot_betas %>%
                filter(UnitCode %in% c("GATE", "SAHI")) %>%
                mutate(SciName_lab = paste0(SciName_cor, "   ")),
              aes(x = Year, y = frq, color = SciName_lab), linetype = "dashed", size = 0.7) +
    geom_errorbar(aes(ymin = mean_frq - se_frq, ymax = mean_frq + se_frq, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[3:n()], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    geom_text(data = manage_species$results$GATE$salicornia_bigelovii,
              aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_frq_lab_sp),
              hjust = -0.05, vjust = 3.25, size = 3.5, family = "serif", inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = manage_species$plot_lims_x[3:4], y = manage_species$plot_lims_y_frq[3:4]) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.x.bottom = element_blank(),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  manage_legend <- get_legend(
    ggplot(veg_cleaned$plot_perc_cover %>% 
             filter(SciName_cor %in% c("Artemisia vulgaris", "Cenchrus tribuloides", "Iva frutescens", "Lonicera japonica", "Panicum amarum", "Phragmites australis", "Salicornia bigelovii", "Suaeda linearis")),
           aes(x = Year_chr, y = PercentCover), group = SciName_cor) +
      geom_line(aes(color = SciName_cor)) +
      geom_point(aes(fill = SciName_cor), shape = 21, size = 2, color = "black") +
      guides(color = guide_legend(title = "Species:", nrow = 3), fill = guide_legend(title = "Species:", nrow = 3)) +
      lfeheR::theme(base_size = 12) +
      theme(
        text = element_text(family = "serif", size = 12),
        legend.key = element_rect(color = "transparent"),
        legend.key.spacing.y = unit(0,"cm"),
        legend.text = element_text(face = "italic"),
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "transparent")
      )
  )
  
  ggdraw() +
    draw_plot(plot_grid(manage_cover_plot + theme(legend.position = "none"), manage_frq_plot + theme(legend.position = "none"), nrow = 2, align = "vh"), y = 0.36, height = 0.64) +
    draw_label("Year", x = 0.525, y = 0.35, fontfamily = "serif", size = 12, hjust = 0) +
    draw_plot(manage_legend, y = -0.24, height = 1) +
    draw_label(bquote(bold("Figure 6.")~"Average mean cover (a and b) and frequency (d and e) of species of management"), x = 0.02, y = 0.15, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("concern within NPSpecies at GATE and SAHI. Dashed lines represent significant rates of"), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("change in mean cover or frequency. Species abbreviations are as follows:"), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("IVFR ="~italic("Iva frutescens")~"and SABI ="~italic("Salicornia bigelovii")*"."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12) 
}

manage_plot2()
```

 

##### **3.4** Invasive, Noxious & Prohibited Species

```{r Invasive species, message=TRUE, warning=TRUE, include=FALSE}

invasive_species <- list(
  "inv_species_cover" = veg_cleaned$park_perc_cover %>%
    mutate(is_invasive = case_when(if_any(starts_with("invasive_"), ~ .x == "T") ~ "T")) %>%
    filter(is_invasive == "T"),
  
  "inv_species_frq" = veg_cleaned$park_frq %>%
    mutate(is_invasive = case_when(if_any(starts_with("invasive_"), ~ .x == "T") ~ "T")) %>%
    filter(is_invasive == "T"),

  "plot_lims_x" = list(
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2008-01-01"), as.Date("2018-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y"),
    scale_x_date(limits = c(as.Date("2009-01-01"), as.Date("2019-01-01")), expand = c(.04, 0), sec.axis = dup_axis(), date_labels = "'%y")
  ),
  
  "plot_lims_y_cover" = list(
    scale_y_continuous(limits = c(0, 3.2), breaks = seq(0,3, by = 1), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of invasive\nspecies (%)"),
    scale_y_continuous(limits = c(0, 8.5), breaks = seq(0,8, by = 2), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of invasive\nspecies (%)"),    
    scale_y_continuous(limits = c(0, 6.2), breaks = seq(0,6, by = 2), expand = c(.04, 0), sec.axis = dup_axis(), name = "Cover of invasive\nspecies (%)")
    ),
  
  "plot_lims_y_frq" = list(
    scale_y_continuous(limits = c(0, 3.2), breaks = seq(0,3, by = 1), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of invasive\nspecies (% of plots)"),
    scale_y_continuous(limits = c(0, 25), breaks = seq(0,30, by = 10), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of invasive\nspecies (% of plots)"),
    scale_y_continuous(limits = c(0, 10.5), breaks = seq(0,9, by = 3), expand = c(.04, 0), sec.axis = dup_axis(), name = "Freq. of invasive\nspecies (% of plots)")
    )
)

invasive_species[["inv_species_cover_mods"]] <- veg_cleaned$site_perc_cover %>% # logistic regression with binomial distribution for invasive species cover
  mutate(is_invasive = case_when(if_any(starts_with("invasive_"), ~ .x == "T") ~ "T")) %>%
  filter(is_invasive == "T") %>% 
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_cover = mean_site_cover/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_cover ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         LR_chisq = format(round(map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]), 2), nsmall = 2),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_cover = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_cover_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

invasive_species[["inv_species_frq_mods"]] <- veg_cleaned$site_frq %>% # logistic regression with binomial distribution for invasive species frq
  mutate(is_invasive = case_when(if_any(starts_with("invasive_"), ~ .x == "T") ~ "T")) %>%
  filter(is_invasive == "T") %>% 
  ungroup() %>%
  left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_frq = frq/100) %>%
  group_by(UnitCode, SciName_cor) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_frq ~ year_num, data = .x, weights = plot_count, family = "quasibinomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_frq = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_frq_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         format_p = format_pval(pval)
         )

invasive_species[["results"]] <- invasive_species$inv_species_cover %>%
  left_join(., invasive_species$inv_species_frq, by = c("UnitCode", "Year_chr", "SciName_cor")) %>%
  rename(., "mean_park_frq" = mean_frq) %>%
  group_by(UnitCode, SciName_cor) %>%
  summarise(mean_cover = format_sps(mean(mean_park_cover)),
            mean_frq = format_sps(mean(mean_park_frq)),
            se_cover = format_sps(sd(mean_park_cover)/sqrt(length(mean_park_cover))),  
            se_frq = format_sps(sd(mean_park_frq)/sqrt(length(mean_park_frq)))) %>%
  mutate(mean_se_text_cover = paste0(mean_cover, " ± ", se_cover, "%"),
         mean_se_text_frq = paste0(mean_frq, " ± ", se_frq, "% of plots")) %>%
  left_join(., invasive_species$inv_species_cover_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_cover" = LR_chisq, "pval_cover" = pval, "format_p_cover" = format_p, "cover_rate" = change_cover, "cover_rate_se" = change_cover_se), by = c("UnitCode", "SciName_cor")) %>%
  left_join(., invasive_species$inv_species_frq_mods %>%
              select(UnitCode, SciName_cor, "LR_chisq_frq" = LR_chisq, "pval_frq" = pval, "format_p_frq" = format_p, "frq_rate" = change_frq, "frq_rate_se" = change_frq_se), by = c("UnitCode", "SciName_cor")) %>%
  ungroup() %>%
  mutate(change_cover = map(cover_rate, ~format_sps(.x)),
         change_cover_se = map(cover_rate_se, ~format_sps(.x)),
         change_cover_se_text = paste0(change_cover, " ± ", change_cover_se, "%/yr"),
         change_cover_lab_sp = if_else(pval_cover < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_cover_se_text),
                                     NA),
         change_frq = map(frq_rate, ~format_sps(.x)),
         change_frq_se = map(frq_rate_se, ~format_sps(.x)),
         change_frq_se_text  = paste0(change_frq, " ± ", change_frq_se, "% plots/yr"),
         change_frq_lab_sp = if_else(pval_frq < 0.05,
                                     paste0(str_to_upper(gsub("(([A-Za-z]{2})[a-z& ]*)", "\\2", str_to_title(SciName_cor))),": ", change_frq_se_text),
                                     NA)
         ) %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

invasive_species[["inv_cover_results_text"]] <- invasive_species$inv_species_cover_mods %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

invasive_species[["inv_frq_results_text"]] <- invasive_species$inv_species_frq_mods %>%
  mutate(SciName_cor = janitor::make_clean_names(SciName_cor, allow_dupes = TRUE)) %>%
  super_split(UnitCode, SciName_cor)

invasive_species[["invasive_species_text"]] <- invasive_species$inv_species_cover %>%
  ungroup() %>%
  select(UnitCode, SciName_cor, is_invasive) %>%
  group_by(UnitCode) %>%
  unique() %>%
  arrange(SciName_cor) %>%
  nest() %>%
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                           paste0("*", .x$SciName_cor, "*"),
                                                           paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>%
  ungroup() %>%
  dplyr::select(-data)
```

|       A total of `r as.character(english(invasive_species$inv_species_cover %>% pluck("SciName_cor") %>% n_distinct()))` species were considered invasive, noxious, or prohibited within their respective states and were found in either COLO, FIIS, or GATE. No invasive species were found at either ASIS, GEWA, or SAHI. Notably, *Phragmites australis* was found in multiple years at both FIIS and GATE (Figure 6).

##### *3.4.1 Invasive Species: COLO*

|       At COLO, only a single species - *Najas minor* - was considered invasive by the Virginia Department of Conservation and Recreation (Table 6), and was only found at a single plot in 2016. Both the mean cover (`r invasive_species$results$COLO$najas_minor$mean_se_text_cover`; Figure 7a) and frequency (`r invasive_species$results$COLO$najas_minor$mean_se_text_frq`; Figure 7c) of *Najas minor* remained unchanged over the study period.

##### *3.4.2 Invasive Species: FIIS*

|       At FIIS, `r as.character(english(invasive_species$results$FIIS %>% bind_rows() %>% n_distinct("SciName_cor")))` species, including `r invasive_species[["invasive_species_text"]] %>% filter(UnitCode == "FIIS") %>% unlist("sp_list") %>% pluck("sp_list")` were considered invasive by the state of New York (Table 6). *Elaeagnus umbellata* was only found in 2015 at FIIS. Both the mean cover (mean: `r invasive_species$results$FIIS$elaeagnus_umbellata$mean_se_text_cover`; Figure 7b) and frequency (mean: `r invasive_species$results$FIIS$elaeagnus_umbellata$mean_se_text_frq`; Figure 7d) of *Elaeagnus umbellata* remained unchanged over the study period. *Phragmites australis* was found in every year at FIIS although both the mean cover (mean: `r invasive_species$results$FIIS$phragmites_australis$mean_se_text_cover`; Figure 7b) and frequency (mean: `r invasive_species$results$FIIS$phragmites_australis$mean_se_text_frq`; Figure 7d) of *Phragmites australis* remained unchanged over the study period. *Polygonum perfoliatum* was only found in 2015 at FIIS. Both the mean cover (mean: `r invasive_species$results$FIIS$polygonum_perfoliatum$mean_se_text_cover`; Figure 7b) and frequency (mean: `r invasive_species$results$FIIS$polygonum_perfoliatum$mean_se_text_frq`; Figure 7d) of *Polygonum perfoliatum* remained unchanged over the study period.

##### *3.4.3 Invasive Species: GATE*

|       At GATE, `r as.character(english(invasive_species$results$GATE %>% bind_rows() %>% n_distinct("SciName_cor")))` species, including `r invasive_species[["invasive_species_text"]] %>% filter(UnitCode == "GATE") %>% unlist("sp_list") %>% pluck("sp_list")` were considered invasive by the state of New York (Table 6). *Artemisia vulgaris* was found in 2014, 2016, and 2018 at GATE. Both the mean cover (mean: `r invasive_species$results$GATE$artemisia_vulgaris$mean_se_text_cover`; Figure 7c) and frequency (mean: `r invasive_species$results$GATE$artemisia_vulgaris$mean_se_text_frq`; Figure 7e) of *Artemisia vulgaris* remained unchanged over the study period. *Lonicera japonica* was only found in 2012 and 2018 at GATE. Both the mean cover (mean: `r invasive_species$results$GATE$lonicera_japonica$mean_se_text_cover`; Figure 7c) and frequency (mean: `r invasive_species$results$GATE$lonicera_japonica$mean_se_text_frq`; Figure 7e) of *Lonicera japonica* remained unchanged over the study period. *Rubus phoenicolasius* was only found at a single plot in 2018. Both the mean cover (mean: `r invasive_species$results$GATE$rubus_phoenicolasius$mean_se_text_cover`; Figure 7c) and frequency (mean: `r invasive_species$results$GATE$rubus_phoenicolasius$mean_se_text_frq`; Figure 7e) of *Rubus phoenicolasius* remained unchanged over the study period.
&nbsp;

```{r Table 6, echo=FALSE, message=FALSE, warning=FALSE}
invasive_species$results %>%
  list_flatten() %>%
  list_rbind() %>%
  mutate(sci_name = str_to_sentence(str_replace(SciName_cor, "_", " ")),
         cover_rate = if_else(pval_cover < 0.05, as.character(unlist(change_cover)), "-"),
         frq_rate = if_else(pval_frq < 0.05, as.character(unlist(change_frq)), "-")) %>%
  ungroup() %>%
  select(UnitCode, sci_name, mean_cover, cover_rate, mean_frq, frq_rate) %>%
  add_row(UnitCode = c("ASIS"), sci_name = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-", .before = 1) %>%
  add_row(UnitCode = c("GEWA", "SAHI"), sci_name = "-", mean_cover = "-", cover_rate = "-", mean_frq = "-", frq_rate = "-") %>%
  flextable(., col_keys = c("UnitCode", "sci_name", "mean_cover", "cover_rate", "mean_frq", "frq_rate")) %>%
  set_header_labels(., UnitCode = "Park", sci_name = "Species", mean_cover = "Mean\n(%)", cover_rate = "Rate of change\n(%/yr)", mean_frq = "Mean\n(% of plots)", frq_rate = "Rate of change\n(% of plots/yr)") %>%
  add_header_row(., values = c("Park", "Species", "Cover", "Frequency"), colwidths = c(1, 1, 2, 2)) %>% 
  add_header_row(., values = "Table 6. Mean percent cover and frequency of species that were considered invasive, noxious, or prohibited by the state where each park is located. None of the species found at either ASIS, GEWA, or COLO were considered invasive, noxious, or prohibited at the state level. Note that only rates of change that were significantly different from 0 are shown.", colwidths = 6) %>%
  merge_at(i = c(2,3), j = 1, part = "header") %>%
  merge_at(i = c(2,3), j = 2, part = "header") %>%
  merge_v(j = 1, part = "body") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  mk_par(j = "sci_name", value = as_paragraph(as_i(sci_name))) %>%
  color(i = ~cover_rate != "-", j = 4, color = "red", part = "body") %>%
  color(i = ~frq_rate != "-", j = 6, color = "red", part = "body") %>%
  width(j = 1:6, width = c(0.5, 1.5, 0.5, 0.9, 0.7, 0.9)) %>%
  fontsize(size = 10, part = "all") %>%
  hline(i = c(1,2,5,9,10), border = fp_border(color = "grey", width = 1)) %>%
  fix_border_issues()
```
&nbsp;

```{r Figure 7, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.25, fig.height=5, out.width=6.25, out.height=5}

invasive_plot <- function(...){
  invasive_cover_plot <- invasive_species$inv_species_cover %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_park_cover)) +
    geom_errorbar(aes(ymin = mean_park_cover - se_park_cover, ymax = mean_park_cover + se_park_cover, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = invasive_species$plot_lims_x, y = invasive_species$plot_lims_y_cover) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.x.bottom = element_blank(),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
  invasive_frq_plot <- invasive_species$inv_species_frq %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_lab = paste0(SciName_cor, "   ")) %>%
    group_by(UnitCode, SciName_cor) %>%
    arrange(UnitCode) %>%
    ggplot(., aes(x = Year, y = mean_frq)) +
    geom_errorbar(aes(ymin = mean_frq - se_frq, ymax = mean_frq + se_frq, group = SciName_lab), color = "black", width = 100) +
    geom_line(aes(color = SciName_lab)) +
    geom_point(aes(fill = SciName_lab), shape = 21, size = 2, color = "black") +
    geom_text(data = . %>%
                ungroup() %>%
                distinct(UnitCode) %>%
                mutate(letter = paste0("(",LETTERS[4:6], ")"),
                       f = pmap_chr(list(letter, UnitCode), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.2, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    lemon::facet_rep_wrap(~UnitCode, scales = "free", repeat.tick.labels = T, nrow = 1) +
    ggh4x::facetted_pos_scales(x = invasive_species$plot_lims_x, y = invasive_species$plot_lims_y_frq) +
    guides(color = guide_legend(title = "Species:"), fill = guide_legend(title = "Species:")) +
    lfeheR::theme(base_size = 12) +
    theme(
      text = element_text(family = "serif", size = 12),
      axis.title.y.left = element_text(margin = margin(0,10,0,0,"pt")),
      axis.title.x.bottom = element_blank(),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.direction = "horizontal",
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
  
 invasive_legend <- get_legend(
    ggplot(veg_cleaned$plot_perc_cover %>% 
             filter(SciName_cor %in% c("Artemisia vulgaris", "Elaeagnus umbellata", "Lonicera japonica", "Najas minor", "Phragmites australis", "Polygonum perfoliatum", "Rubus phoenicolasius")), 
           aes(x = Year_chr, y = PercentCover), group = SciName_cor) +
      geom_line(aes(color = SciName_cor)) +
      geom_point(aes(fill = SciName_cor), shape = 21, size = 2, color = "black") +
      guides(color = guide_legend(title = "Species:", nrow = 3), fill = guide_legend(title = "Species:", nrow = 3)) +
      lfeheR::theme(base_size = 12) +
      theme(
        text = element_text(family = "serif", size = 12),
        legend.key = element_rect(color = "transparent"),
        legend.key.spacing.y = unit(0,"cm"),
        legend.text = element_text(face = "italic"),
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "transparent")
      )
  )
  
  ggdraw() +
    draw_plot(plot_grid(invasive_cover_plot + theme(legend.position = "none"), invasive_frq_plot + theme(legend.position = "none"), nrow = 2, align = "vh"), y = 0.29, height = 0.71) +
    draw_label("Year", x = 0.525, y = 0.27, fontfamily = "serif", size = 12, hjust = 0) +
    draw_plot(invasive_legend, y = -0.32, height = 1) +
    draw_label(bquote(bold("Figure 7.")~"Mean cover (a, b, and c) and frequency (d, e, and f) of invasive"), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
    draw_label(bquote("species at COLO, FIIS, and GATE."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
}

invasive_plot()
```

 

##### **3.5** Salinity Tolerance

```{r Salinity tolerance, echo=FALSE, message=FALSE, warning=FALSE}

sal_class <- function(x) {
  x %>%
    mutate(SalinityCode = case_when(SalinityCode == "high >18 ppt" ~ "High",
                                    SalinityCode == "medium 0.5-18 ppt" ~ "Medium",
                                    SalinityCode == "low <0.5 ppt" ~ "Low", 
                                    SalinityCode == "unknown" | SalinityCode == "no" ~ NA, 
                                    T ~ SalinityCode),
           SalinityTolerance = case_when(SalinityTolerance == "" ~ NA,
                                         SalinityTolerance == "None" ~ NA,
                                         T ~ SalinityTolerance)) %>%
    mutate(sal_code = if_else(is.na(SalinityTolerance) & !is.na(SalinityCode), SalinityCode, SalinityTolerance))
}

salinity <- list(
  
  "sal_category_count_per_park" = veg_cleaned$site_frq %>% # count of species in each salinity category in each park
    ungroup() %>%
    sal_class(.) %>%
    mutate(sal_code = if_else(is.na(sal_code), "unknown", sal_code)) %>%
    group_by(UnitCode, sal_code) %>%
    summarise(sp_count = n_distinct(SciName_cor)) %>%
    super_split(UnitCode, sal_code),
  
  "sal_category_sps_list" = veg_cleaned$site_frq %>% # count of species in each salinity category in each park
    ungroup() %>%
    sal_class(.) %>%
    mutate(sal_code = if_else(is.na(sal_code), "unknown", sal_code)) %>% 
    group_by(UnitCode, sal_code) %>%
    distinct(SciName_cor) %>%
    arrange(SciName_cor) %>%
    nest() %>%
    mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                             paste0("*",.x$SciName_cor,"*"),
                                                             paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>% 
    ungroup() %>% 
    dplyr::select(-data),
  
  "site_sal_count" = veg_cleaned$site_frq %>% 
    ungroup() %>%
    sal_class(.) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code) %>%
    filter(!is.na(sal_code)) %>%
    # the following lines were used to add in 0's for salinity categories were no species were found at a site in a particular year
    mutate(f = if_else(frq == 0, "a", "b")) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code, f) %>%
    summarise(site_species_count = n_distinct(SciName_cor)) %>%
    mutate(site_species_count2 = if_else(f == "a", 0, site_species_count)) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code) %>%
    summarise(site_species_count = sum(site_species_count2)) %>%
    ungroup() %>%
    add_row(., UnitCode = "SAHI", UniqueID = "SAHI_SAG1", sal_code = "Low", Year_chr = c("2009", "2011", "2013", "2015", "2017"), site_species_count = 0) %>%
    # add in plot counts to be used in regressions
    left_join(.,
            veg_cleaned$plot_perc_cover %>%
              ungroup() %>%
              select(UnitCode, UniqueID, Year_chr, EventID) %>%
              group_by(UnitCode, UniqueID, Year_chr) %>%
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")),
  
  "site_sal_frq" = veg_cleaned$plot_perc_cover %>% 
    ungroup() %>%
    select(EventID, UniqueID, UnitCode, Year_chr, SciName_cor, SalinityCode, SalinityTolerance) %>%
    sal_class(.) %>%
    select(-c(SalinityCode, SalinityTolerance)) %>%
    group_by(UniqueID, UnitCode, Year_chr) %>%
    mutate(total_site_plots = n_distinct(EventID)) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code) %>%
    mutate(total_site_present = n_distinct(EventID)) %>%
    mutate(site_frq = total_site_present/total_site_plots) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code) %>%
    summarise(mean_site_frq = mean(site_frq)*100) %>%
    filter(!is.na(sal_code)) %>%
    # the following lines were used to add in 0's for salinity categories where no species were found at a site in a particular year
    group_by(UnitCode) %>%
    nest() %>%
    mutate(df = map(data, ~pivot_wider(.x, names_from = "Year_chr", values_from = "mean_site_frq", values_fill = 0)),
           df2 = case_when(UnitCode == "ASIS" ~ map(df, ~add_row(.x, UniqueID = c("ASIS_A3", "ASIS_A3", "ASIS_A4", "ASIS_A4", "ASIS_A9", "ASIS_A8", "ASIS_A8"), sal_code = c("Medium", "Low", "Medium", "Low", "Low", "Medium", "Low"))),
                           UnitCode == "FIIS" ~ map(df, ~add_row(.x, UniqueID = "FIIS_F6", sal_code = c("Medium", "Low"))),
                           UnitCode == "GATE" ~ map(df, ~add_row(.x, UniqueID = "GATE_GSH3", sal_code = "Low")),
                           UnitCode == "SAHI" ~ map(df, ~add_row(.x, UniqueID = "SAHI_SAG1", sal_code = "Low")),
                           T ~ df),
           df3 = map(df2, ~pivot_longer(.x, cols = -c(UniqueID, sal_code), names_to = "Year_chr", values_to = "mean_site_frq") %>%
                       mutate(mean_site_frq = if_else(is.na(mean_site_frq), 0, mean_site_frq)))) %>%
    ungroup() %>%
    select(-c(data, df, df2)) %>%
    unnest() %>%
    left_join(.,
            veg_cleaned$plot_perc_cover %>%
              ungroup() %>%
              select(UnitCode, UniqueID, Year_chr, EventID) %>%
              group_by(UnitCode, UniqueID, Year_chr) %>%
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
    filter(!is.na(plot_count)),
  
  "site_sal_cover" = veg_cleaned$site_perc_cover %>% 
    ungroup() %>%
    select(UniqueID, UnitCode, Year_chr, SciName_cor, SalinityCode, SalinityTolerance, mean_site_cover) %>%
    sal_class(.) %>%
    filter(!is.na(sal_code)) %>%
    group_by(UniqueID, UnitCode, Year_chr, sal_code) %>%
    summarise(mean_site_cover = sum(mean_site_cover)) %>%
    group_by(UnitCode) %>%
    nest() %>%
    mutate(df = map(data, ~pivot_wider(.x, names_from = "Year_chr", values_from = "mean_site_cover", values_fill = 0) %>%
             pivot_longer(., cols = -c(UniqueID, sal_code), names_to = "Year_chr", values_to = "mean_site_cover"))) %>%
    ungroup() %>%
    select(-c(data)) %>%
    unnest() %>%
    left_join(., 
            veg_cleaned$plot_perc_cover %>% 
              ungroup() %>% 
              select(UnitCode, UniqueID, Year_chr, EventID) %>% 
              group_by(UnitCode, UniqueID, Year_chr) %>% 
              summarise(plot_count = n_distinct(EventID)),
            by = c("UnitCode", "UniqueID", "Year_chr")) %>%
    filter(!is.na(plot_count)) %>%
    ungroup() %>%
    add_row(., UnitCode = "SAHI", UniqueID = "SAHI_SAG1", sal_code = "Low", Year_chr = c("2009", "2011", "2013", "2015", "2017"), mean_site_cover = 0, plot_count = c(50, 40, 45, 46, 44))
)

salinity[["sal_count_mods"]] <- salinity$site_sal_count %>%
  filter(!(UnitCode== "SAHI" & sal_code == "Low")) %>%
  filter(!(UnitCode == "GEWA" & sal_code == "High")) %>%
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year))) %>%
  group_by(UnitCode, sal_code) %>%
  nest() %>%
  mutate(pois_mod = map(data, ~glm(site_species_count ~ year_num + offset(log(plot_count)), family = "poisson", data = .x)),
         dispersion = map(pois_mod, ~AER::dispersiontest(.x, trafo = 1)), # test for overdispersion
         summary_mod = map(pois_mod, ~summary(.x)),
         null_mod = map(data, ~glm(site_species_count ~ 1 + offset(log(plot_count)), family = "poisson", data = .x)),
         summary_null = map(null_mod, ~summary(.x)),
         chisq_calc = map2_dbl(null_mod, pois_mod, ~lmtest::lrtest(.x, .y)$`Chisq`[[2]]),
         LR_chisq = format_chi(chisq_calc),, 
         pval = map_dbl(summary_mod, ~coef(.x)[8]),
         b1 =  map_dbl(summary_mod, ~coef(.x)[2]),
         b1_se = map_dbl(summary_mod, ~coef(.x)[4]), 
         change_count = map_dbl(b1, ~(exp(.x*1)-1)*100), # https://stats.stackexchange.com/questions/344291/interpreting-poisson-regression-coefficients
         change_count_se = map_dbl(b1_se, ~abs((exp(.x*1)-1)*100)),
         format_p = format_pval(pval),
         sal_code_plot_lab = if_else(sal_code == "Medium", "Med", sal_code),
         change_count_lab = paste0(sal_code_plot_lab, ": ", format_sps(change_count), " ± ", format_sps(change_count_se), "% sp/yr"),
         change_count_text = paste0(format_sps(change_count), " ± ", format_sps(change_count_se), "% of species/year"),
         vjust = case_when(sal_code == "Medium" & UnitCode == "ASIS" ~ 3.25,
                           T ~ NA_real_
                           )
  )

salinity[["sal_frq_mods"]] <- salinity$site_sal_frq %>% 
  filter(!(UnitCode == "SAHI" & sal_code %in% c("High", "Low"))) %>% # couldn't run model for SAHI since high salinity was 100% frq in all years and low salinity was 0 % frq in all years
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_frq = mean_site_frq/100) %>%
  group_by(UnitCode, sal_code) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_frq ~ year_num, data = .x, weights = plot_count, family = "binomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc),
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_frq = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_frq_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         r2 = map_dbl(summary_mod, ~1-.x$deviance/.x$null.deviance), #https://www.statology.org/glm-r-squared/
         sal_code_plot_lab = if_else(sal_code == "Medium", "Med", sal_code),
         change_frq_lab = paste0(sal_code_plot_lab, ": ", format_sps(change_frq), " ± ", format_sps(change_frq_se), "% plots/yr"),
         change_count_text = paste0(format_sps(change_frq), " ± ", format_sps(change_frq_se), "% of plots/year"),
         format_p = format_pval(pval),
         preds = map(binom_mod, ~data.frame(predict(.x, type = "response")*100)),
         vjust = case_when((sal_code == "High" & pval < 0.05) | (UnitCode == "ASIS" & sal_code == "Medium") | (UnitCode == "FIIS" & sal_code == "Medium") ~ 3.25,
                           UnitCode %in% c("COLO") & sal_code == "Medium" ~ 4.75,
                           UnitCode == "COLO" & sal_code == "Low" ~ 6.25,
                           T ~ NA_real_
                           )
         )

salinity[["sal_cover_mods"]] <- salinity$site_sal_cover %>% 
  filter(!(UnitCode == "SAHI" & sal_code %in% c("Low"))) %>% # couldn't run model for SAHI since high salinity was 100% frq in all years and low salinity was 0 % frq in all years
  group_by(UnitCode) %>%
  mutate(year = as.numeric(Year_chr),
         year_num = as.numeric(year-min(year)),
         binom_mean_site_cover = mean_site_cover/100) %>%
  group_by(UnitCode, sal_code) %>%
  nest() %>%
  mutate(binom_mod = map(data, ~glm(binom_mean_site_cover ~ year_num, data = .x, weights = plot_count, family = "binomial")), #https://stats.stackexchange.com/questions/623503/how-to-interpret-binomial-glm-coefficient-w-proportion-as-outcome?rq=1
         summary_mod = map(binom_mod, ~summary(.x)),
         chisq_calc = map_dbl(binom_mod, ~stats::drop1(.x, scope = ~year_num, test = "Chisq")[[4]][[2]]),
         LR_chisq = format_chi(chisq_calc), 
         pval = map_dbl(summary_mod, ~coefficients(.x)[[8]]),
         int = map_dbl(summary_mod, ~coefficients(.x)[[1]]),
         b1 =  map_dbl(summary_mod, ~coefficients(.x)[[2]]),
         b1_se = map_dbl(summary_mod, ~coefficients(.x)[[4]]), 
         margs = map2(binom_mod, data, ~margins::margins(model = .x, data = .y, unit_ses = TRUE)),
         change_cover = map_dbl(margs, ~mean(.x$dydx_year_num)*100),
         change_cover_se = map_dbl(margs, ~mean(.x$SE_dydx_year_num)*100),
         r2 = map_dbl(summary_mod, ~1-.x$deviance/.x$null.deviance), #https://www.statology.org/glm-r-squared/
         sal_code_plot_lab = if_else(sal_code == "Medium", "Med", sal_code),
         change_cover_lab = paste0(sal_code_plot_lab, ": ", format_sps(change_cover), " ± ", format_sps(change_cover_se), "%/yr"),
         change_count_text = paste0(format_sps(change_cover), " ± ", format_sps(change_cover_se), "%/yr"),
         format_p = format_pval(pval),
         preds = map(binom_mod, ~data.frame(predict(.x, type = "response")*100)),
         vjust = case_when(sal_code == "High" & pval < 0.05 ~ 3.25,
                           (UnitCode %in% c("COLO", "GEWA") & sal_code == "Medium") | (UnitCode == "FIIS" & sal_code == "Low") ~ 4.75,
                           UnitCode == "COLO" & sal_code == "Low" ~ 6.25,
                           T ~ NA_real_
                           )
         )

salinity[["park_sal_count"]] <- salinity$site_sal_count %>% # park-level mean count per year in each park - for bar labels on plots
  group_by(UnitCode, Year_chr, sal_code) %>%
  summarise(species_count = mean(site_species_count, na.rm = TRUE)) %>%
  mutate(value_label = if_else(round(species_count) < 2, NA, round(species_count)))

salinity[["park_sal_frq"]] <- salinity$site_sal_frq %>% # park-level mean frq per year in each park - for bar labels on plots
  group_by(UnitCode, Year_chr, sal_code) %>%
  summarise(mean_frq = mean(mean_site_frq, na.rm = TRUE)) %>%
  mutate(value_label = if_else(round(mean_frq) < 10, NA, round(mean_frq)))

salinity[["park_sal_cover"]] <- salinity$site_sal_cover %>% # park-level mean cover per year in each park - for bar labels on plots
  group_by(UnitCode, Year_chr, sal_code) %>%
  summarise(mean_cover = mean(mean_site_cover, na.rm = TRUE)) %>%
  mutate(value_label = if_else(round(mean_cover) < 10, NA, round(mean_cover))) 

salinity[["sal_mean_count_all_yrs"]] <- salinity$park_sal_count %>% # yearly mean count of each salinity category in each park
  group_by(UnitCode, sal_code) %>%
  summarise(yearly_mean_park_count = format_sps(mean(species_count)),
            yearly_se_park_count = format_sps(sd(species_count)/sqrt(length(species_count)))) %>%
  mutate(mean_se_count = paste0(yearly_mean_park_count, " ± ", yearly_se_park_count, " species")) %>%
  super_split(UnitCode, sal_code)

salinity[["sal_mean_frq_all_yrs"]] <- salinity$park_sal_frq %>% # yearly mean frq of each salinity category in each park
  group_by(UnitCode, sal_code) %>%
  summarise(yearly_mean_frq = format_sps(mean(mean_frq)),
            yearly_se_frq = format_sps(sd(mean_frq)/sqrt(length(mean_frq)))) %>%
  mutate(mean_se_frq = if_else(UnitCode == "SAHI" & sal_code == "High", 
                               paste0(yearly_mean_frq, "% of plots"), 
                               paste0(yearly_mean_frq, " ± ", yearly_se_frq, "% of plots"))) %>%
  super_split(UnitCode, sal_code)

salinity[["sal_mean_cover_all_yrs"]] <- salinity$park_sal_cover %>% # yearly mean cover of each salinity category in each park
  group_by(UnitCode, sal_code) %>%
  summarise(yearly_mean_park_cover = format_sps(mean(mean_cover)),
            yearly_se_park_cover = format_sps(sd(mean_cover)/sqrt(length(mean_cover)))) %>%
  mutate(mean_se_cover = paste0(yearly_mean_park_cover, " ± ", yearly_se_park_cover, "%")) %>%
  super_split(UnitCode, sal_code)

salinity[["sal_count_results_text"]] <- salinity$sal_count_mods %>%
  super_split(UnitCode, sal_code)

salinity[["sal_frq_results_text"]] <- salinity$sal_frq_mods %>%
  super_split(UnitCode, sal_code)

salinity[["sal_cover_results_text"]] <- salinity$sal_cover_mods %>%
  super_split(UnitCode, sal_code)
```

```{r Table 7, echo=FALSE, message=FALSE, warning=FALSE}
salinity$sal_category_count_per_park %>%
  list_flatten() %>%
  list_rbind() %>%
  filter(sal_code != "unknown") %>%
  ungroup() %>%
  add_row(UnitCode = c("SAHI"), sal_code = "Low", sp_count = 0) %>%
  left_join(., salinity$sal_mean_count_all_yrs %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code")) %>%
  left_join(., salinity$sal_count_results_text %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code")) %>%
  left_join(., salinity$sal_mean_frq_all_yrs %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code")) %>%
  left_join(., salinity$sal_frq_results_text %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code"), suffix = c("_count", "_frq")) %>%
  left_join(., salinity$sal_mean_cover_all_yrs %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code")) %>%
  left_join(., salinity$sal_cover_results_text %>%
              list_flatten() %>%
              list_rbind(),
            by = c("UnitCode", "sal_code")) %>%
  select(UnitCode, sal_code, sp_count, yearly_mean_park_count, pval_count, change_count, yearly_mean_frq, pval_frq, change_frq, yearly_mean_park_cover, pval, change_cover) %>%
  mutate(change_count = if_else(pval_count > 0.05 | is.na(change_count), "-", format(round(change_count), nsmall = 0)),
         change_frq = if_else(pval_frq > 0.05 | is.na(change_frq), "-", as.character(signif(change_frq,1))),
         change_cover = if_else(pval > 0.05 | is.na(change_cover), "-", as.character(signif(change_cover,1)))) %>%
  select(-c(pval_count, pval_frq, pval)) %>%
  mutate(sal_code = factor(sal_code, levels = c("Low", "Medium", "High"))) %>%
  arrange(UnitCode, sal_code) %>%
  flextable(., col_keys = c("UnitCode", "sal_code", "sp_count", "yearly_mean_park_count", "change_count", "col1", "yearly_mean_frq", "change_frq", "col2", "yearly_mean_park_cover", "change_cover")) %>%
  set_header_labels(., UnitCode = "Park", sal_code = "Salinity Tolerance", sp_count = "Count\n(n)", yearly_mean_park_count = "Mean\n(n)", change_count = "Rate of change\n(% of sps/yr)", yearly_mean_frq = "Mean\n(% of plots)", change_frq = "Rate of change\n(% of plots/yr)", yearly_mean_park_cover = "Mean\n(%)", change_cover = "Rate of change\n(%/yr)") %>%
  add_header_row(., values = c("Park", "Salinity Tolerance", "Count", "", "Frequency", "", "Cover"), colwidths = c(1, 1, 3, 1, 2, 1, 2)) %>% 
  add_header_row(., values = "Table 7. Total count, frequency, and mean percent cover of species in each salinity tolerance category at each park. Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Note that only rates of change that were significantly different from 0 are shown.", colwidths = 11) %>%
  merge_at(i = c(2,3), j = 1, part = "header") %>%
  merge_at(i = c(2,3), j = 2, part = "header") %>%
  merge_v(j = 1, part = "body") %>%
  align(align = "center", part = "all") %>%
  align(align = "left", part = "header", i = 1) %>%
  color(i = ~change_count != "-", j = 5, color = "red", part = "body") %>%
  color(i = ~change_frq != "-" & as.numeric(change_frq) < 0, j = 8, color = "red", part = "body") %>%
  color(i = ~change_frq != "-" & as.numeric(change_frq) > 0, j = 8, color = "forestgreen", part = "body") %>%
  color(i = ~change_cover != "-" & as.numeric(change_cover) < 0, j = 11, color = "red", part = "body") %>%
  color(i = ~change_cover != "-" & as.numeric(change_cover) > 0, j = 11, color = "forestgreen", part = "body") %>%
  width(j = 1:11, width = c(0.5, 1, 0.4, 0.4, 1, 0.2, 0.7, 1, 0.2, 0.4, 1)) %>%
  fontsize(size = 10, part = "all") %>%
  hline(i = c(3,6,9,12,15), border = fp_border(color = "grey", width = 1)) %>%
  fix_border_issues() 
```


```{r Salinity plot, message=FALSE, warning=FALSE, include=FALSE}
salinity_plot <- function(park) {
  
  sal_count <- salinity$park_sal_count %>%
    filter(UnitCode == park)
  
  sal_frq <- salinity$park_sal_frq %>%
    filter(UnitCode == park)
  
  sal_cover <- salinity$park_sal_cover %>%
    filter(UnitCode == park)
  
  labfun <- function(metric_df, metric_name) {
    f <- metric_df %>%
      ungroup() %>%
      mutate(sal = factor(case_when(
        sal_code == "High" ~ "High (>18 ppt)   ",
        sal_code == "Medium" ~ "Medium (0.5-18 ppt)   ",
        sal_code == "Low" ~ "Low (<0.5 ppt)   ",
        T ~ NA
      ), levels = c("High (>18 ppt)   ", "Medium (0.5-18 ppt)   ", "Low (<0.5 ppt)   ")),
      Year = as.Date(paste0(Year_chr, "-01-01"))) %>%
      filter(!is.na(sal))
  }
  
  sal_count2 <- labfun(metric_df = sal_count, metric_name = "species_count")
  sal_frq2 <- labfun(metric_df = sal_frq, metric_name = "mean_frq")
  sal_cover2 <- labfun(metric_df = sal_cover, metric_name = "mean_cover")
  
  ggfun <- function(metric_df2, metric_name, park_name = park){
    
    if(metric_name == "species_count") {
      mod_df <- salinity$sal_count_mods %>%
        mutate(change_lab = change_count_lab) %>%
        filter(UnitCode == park_name)
      letter_lab <- "(A)"
      metric_lab <- "Species count (n)"
      value_text_size <- 3.5
      max_y <- 17
      y_breaks <- seq(0,15, by = 5)
      if(park_name == "GEWA") {
        max_y <- 42
        y_breaks <- seq(0,40, by = 10)
      } else if(park_name == "GATE") {
        max_y <- 19
      }
    } else if(metric_name == "mean_frq") {
      mod_df <- salinity$sal_frq_mods %>%
        mutate(change_lab = change_frq_lab) %>%
        filter(UnitCode == park_name)
      letter_lab <- "(B)"
      metric_lab <- "Freq. (% of plots)"
      value_text_size <- 3.5
      if(park_name == "ASIS") {
        max_y <- 140
        y_breaks <- seq(0, 120, by = 30)
      } else if(park_name == "COLO"){
        max_y <- 296
        y_breaks <- seq(0, 250, by = 50)
      } else if(park_name == "FIIS"){
        max_y <- 149
        y_breaks <- seq(0, 140, by = 30)
      } else if(park_name == "GATE"){
        max_y <- 145
        y_breaks <- seq(0, 120, by = 30)
      } else if(park_name == "GEWA"){
        max_y <- 245
        y_breaks <- seq(0, 200, by = 50)
      } else if(park_name == "SAHI"){
        max_y <- 132
        y_breaks <- seq(0, 120, by = 30)
      }
    } else if(metric_name == "mean_cover") {
      mod_df <- salinity$sal_cover_mods %>%
        mutate(change_lab = change_cover_lab) %>%
        filter(UnitCode == park_name)
      letter_lab <- "(C)"
      metric_lab <- "Cover (%)"
      value_text_size <- 3.5
      max_y <- 110
      y_breaks <- seq(0,100, by = 25)
      if(park_name == "COLO"){
        max_y <- 120
      } else if(park_name == "GEWA"){
        max_y <- 160
        y_breaks <- seq(0,150, by = 50)
      }
    }
    
    if(park_name == "ASIS") {
      pal <- color_pals$asis_pal[c(1,5,9)]
    } else if(park_name == "COLO") {
      pal <- color_pals$colo_pal[c(1,5,8)]
    } else if(park_name == "FIIS") {
      pal <- color_pals$fiis_pal[c(1,5,9)]
    } else if(park_name == "GATE") {
      pal <- color_pals$gate_pal
    } else if(park_name == "GEWA") {
      pal <- monochromeR::generate_palette("#118ab2", modification = "go_lighter", n_colors = 3)
    } else if(park_name == "SAHI") {
      pal <- monochromeR::generate_palette("#073b4c", modification = "go_lighter", n_colors = 3)
    }
    
    if(park_name == "SAHI") {
      value_text_color <- "white"
    } else {
      value_text_color <- "black"
    }
    
    park_lab <- paste0(park_name, ":")
    
    if(metric_name == "mean_frq"){
      x_title_color <- "black"
    } else {
      x_title_color <- "transparent"
    }
     
    metric_df2 %>%
      ggplot(., aes(x = Year, y = eval(sym(metric_name)))) +
      geom_col(aes(fill = sal), color = "black") +
      geom_text(aes(label = value_label, group = sal), color = value_text_color, position = position_stack(vjust = 0.5), size = value_text_size, family = "serif", show.legend = FALSE) +
      {if(metric_name == "species_count") 
          geom_text(data = mod_df %>%
                      filter(pval < 0.05),
                    aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_lab, vjust = vjust), hjust = -0.05, size = 3.5, family = "serif", inherit.aes = FALSE)
        else if(metric_name == "mean_frq")
          geom_text(data = mod_df %>% 
                      filter(pval < 0.05), 
                    aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_lab, vjust = vjust), hjust = -0.05, size = 3.5, family = "serif", inherit.aes = FALSE)
        else if(metric_name == "mean_cover")
          geom_text(data = mod_df %>% 
                      filter(pval < 0.05),
                    aes(x = structure(-Inf, class = "Date"), y = Inf, label = change_lab, vjust = vjust), hjust = -0.05, size = 3.5, family = "serif", inherit.aes = FALSE)} +
      annotate("text", label = deparse(bquote(bold(.(letter_lab)))), x = structure(-Inf, class = "Date"), y = Inf, hjust = -0.3, vjust = 1.5, size = 3.5, fontface = "bold", family = "serif", parse = T) +
      scale_fill_manual(values = pal, name = "Salinity tolerance:") +
      scale_x_date(date_breaks = "2 year", date_labels = "'%y") +
      scale_y_continuous(limits = c(0,max_y), breaks = y_breaks, expand = c(0,0), name = metric_lab, sec.axis = dup_axis()) +
      guides(fill = guide_legend(reverse = TRUE)) +
      theme(
        text = element_text(size = 12, family = "serif", color = "black"),
        panel.border = element_rect(color = "black", fill = NA),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.ticks.length.x = unit(0, "pt"),
        axis.ticks.length.y = unit(-4, "pt"),
        axis.title.y.right = element_blank(),
        axis.title.y.left = element_text(size = 12, margin = margin(r = 5, unit = "pt")),
        axis.text.y.left = element_text(size = 12, color = "black"),
        axis.title.x = element_text(size = 12, color = x_title_color),
        axis.text.y.right = element_blank(),
        axis.text.x = element_text(size = 12, color = "black"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.direction = "horizontal",
        legend.background = element_rect(fill = "transparent")
      )
  }
  
  count_plot <- ggfun(metric_df2 = sal_count2, metric_name = "species_count")
  frq_plot <- ggfun(metric_df2 = sal_frq2, metric_name = "mean_frq") +
    theme(legend.position = "none")
  cover_plot <- ggfun(metric_df2 = sal_cover2, metric_name = "mean_cover") +
    theme(legend.position = "none")
  
  legend <- cowplot::get_legend(count_plot)
  count_plot <- count_plot + theme(legend.position = "none")
  
  ggdraw(plot_grid(plot_grid(count_plot, frq_plot, cover_plot, nrow = 1, byrow = T),
                   plot_grid(NULL, legend, NULL, nrow = 1, byrow = T, rel_widths = c(0.1, 1, 0.1)),
                   rel_heights = c(1,0.06), nrow = 2))
}
```

##### *3.5.1 Salinity Tolerance: ASIS*
|       At ASIS, there were `r salinity$sal_category_count_per_park$ASIS$Low %>% pluck("sp_count")`, `r salinity$sal_category_count_per_park$ASIS$Medium %>% pluck("sp_count")`, and `r salinity$sal_category_count_per_park$ASIS$unknown %>% pluck("sp_count")` species classified as low, medium, and high salinity tolerance (respectively) and `r salinity$sal_category_count_per_park$ASIS$unknown %>% pluck("sp_count")` species that were missing salinity tolerance data (Table 7, Appendix 3a). The count of species with low salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$ASIS$Low$mean_se_count`) and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$ASIS$High$mean_se_count`) remained unchanged over the study period, whereas the count of species with medium salinity tolerance decreased at a rate of `r salinity$sal_count_results_text$ASIS$Medium$change_count_text` (*p* `r salinity$sal_count_results_text$ASIS$Medium$format_p`; mean: `r salinity$sal_mean_count_all_yrs$ASIS$Medium$mean_se_count`) (Figure 8a). The frequency of species with low salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$ASIS$Low$mean_se_frq`) and high salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$ASIS$High$mean_se_frq`) remained unchanged over the study period at ASIS, whereas the frequency of species with medium salinity tolerance decreased at a rate of `r salinity$sal_frq_results_text$ASIS$Medium$change_count_text` (*p* `r salinity$sal_frq_results_text$ASIS$Medium$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$ASIS$Medium$mean_se_frq`) (Figure 8b). The mean cover of species with low salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$ASIS$Low$mean_se_cover`) and medium salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$ASIS$Medium$mean_se_cover`) remained unchanged over the study period at ASIS, whereas the mean cover of species with high salinity tolerance decreased at a rate of `r salinity$sal_cover_results_text$ASIS$High$change_count_text` (*p* `r salinity$sal_cover_results_text$ASIS$High$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$ASIS$High$mean_se_cover`) (Figure 8c).

```{r Figure 8, echo=FALSE, fig.height=4, fig.width=6.5, message=FALSE, warning=FALSE, out.height=4, out.width=6.5}
ggdraw(salinity_plot(park = "ASIS"), ylim = c(-0.25,1)) +
  draw_label(bquote(bold("Figure 8.")~"ASIS (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that count"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 2 and frequency and cover values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0)
```

 

##### *3.5.2 Salinity Tolerance: COLO*
|       At COLO, there were `r salinity$sal_category_count_per_park$COLO$Low %>% pluck("sp_count")`, `r salinity$sal_category_count_per_park$COLO$Medium %>% pluck("sp_count")`, and `r salinity$sal_category_count_per_park$COLO$High %>% pluck("sp_count")` species classified as low, medium, and high salinity tolerance (respectively) and `r salinity$sal_category_count_per_park$COLO$unknown %>% pluck("sp_count")` species that were missing salinity tolerance data (Table 7, Appendix 3b). The count of species with low (mean: `r salinity$sal_mean_count_all_yrs$COLO$Low$mean_se_count`), medium (mean: `r salinity$sal_mean_count_all_yrs$COLO$Medium$mean_se_count`), and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$COLO$High$mean_se_count`) remained unchanged over the study period (Figure 9a). The frequency of species with low salinity tolerance at COLO increased at a rate of `r salinity$sal_frq_results_text$COLO$Low$change_count_text` (*p* `r salinity$sal_frq_results_text$COLO$Low$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$COLO$Low$mean_se_frq`) (Figure 9b). The frequency of species with medium salinity tolerance at COLO increased at a rate of `r salinity$sal_frq_results_text$COLO$Medium$change_count_text` (*p* `r salinity$sal_frq_results_text$COLO$Medium$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$COLO$Medium$mean_se_frq`) (Figure 9b). The frequency of species with high salinity tolerance at COLO decreased at a rate of `r salinity$sal_frq_results_text$COLO$High$change_count_text` (*p* `r salinity$sal_frq_results_text$COLO$High$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$COLO$High$mean_se_frq`) (Figure 9b). The mean cover of species with low salinity tolerance at COLO increased at a rate of `r salinity$sal_cover_results_text$COLO$Low$change_count_text` (*p* `r salinity$sal_cover_results_text$COLO$Low$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$COLO$Low$mean_se_cover`) (Figure 9c). The mean cover of species with medium salinity tolerance at COLO increased at a rate of `r salinity$sal_cover_results_text$COLO$Medium$change_count_text` (*p* `r salinity$sal_cover_results_text$COLO$Medium$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$COLO$Medium$mean_se_cover`) (Figure 9c). The mean cover of species with high salinity tolerance at COLO decreased at a rate of `r salinity$sal_cover_results_text$COLO$High$change_count_text` (*p* `r salinity$sal_cover_results_text$COLO$High$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$COLO$High$mean_se_cover`) (Figure 9c).

```{r Figure 9, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, fig.height=4, out.width=6.5, out.height=4}
ggdraw(salinity_plot(park = "COLO"), ylim = c(-0.25,1)) +
  draw_label(bquote(bold("Figure 9.")~"COLO (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that count"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 2 and frequency and cover values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0)
```

 

##### *3.5.3 Salinity Tolerance: FIIS*
|       At FIIS, there were `r salinity$sal_category_count_per_park$FIIS$Low %>% pluck("sp_count")`, `r salinity$sal_category_count_per_park$FIIS$Medium %>% pluck("sp_count")`, and `r salinity$sal_category_count_per_park$FIIS$High %>% pluck("sp_count")` species classified as low, medium, and high salinity tolerance (respectively) and `r salinity$sal_category_count_per_park$FIIS$unknown %>% pluck("sp_count")` species that were missing salinity tolerance data (Table 7, Appendix 3c). The count of species with low (mean: `r salinity$sal_mean_count_all_yrs$FIIS$Low$mean_se_count`), medium (mean: `r salinity$sal_mean_count_all_yrs$FIIS$Medium$mean_se_count`), and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$FIIS$High$mean_se_count`) remained unchanged over the study period (Figure 10a). The frequency of species with low salinity tolerance at FIIS remained unchanged over the study period (mean: `r salinity$sal_mean_frq_all_yrs$FIIS$Low$mean_se_frq`) (Figure 10b). The frequency of species with medium salinity tolerance at FIIS decreased at a rate of `r salinity$sal_frq_results_text$FIIS$Medium$change_count_text` (*p* `r salinity$sal_frq_results_text$FIIS$Medium$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$FIIS$Medium$mean_se_frq`) (Figure 10b). The frequency of species with high salinity tolerance at FIIS increased at a rate of `r salinity$sal_frq_results_text$FIIS$High$change_count_text` (*p* `r salinity$sal_frq_results_text$FIIS$High$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$FIIS$High$mean_se_frq`) (Figure 10b). The mean cover of species with low salinity tolerance at FIIS decreased at a rate of `r salinity$sal_cover_results_text$FIIS$Low$change_count_text` (*p* `r salinity$sal_cover_results_text$FIIS$Low$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$FIIS$Low$mean_se_cover`) (Figure 10c). The mean cover of species with medium salinity tolerance at FIIS remained unchanged over the study period (mean: `r salinity$sal_mean_cover_all_yrs$FIIS$Medium$mean_se_cover`) (Figure 10c). The mean cover of species with high salinity tolerance at FIIS decreased at a rate of `r salinity$sal_cover_results_text$FIIS$High$change_count_text` (*p* `r salinity$sal_cover_results_text$FIIS$High$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$FIIS$High$mean_se_cover`) (Figure 10c).

```{r Figure 10, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, fig.height=4, out.width=6.5, out.height=4}
ggdraw(salinity_plot(park = "FIIS"), ylim = c(-0.25,1)) +
  draw_label(bquote(bold("Figure 10.")~"FIIS (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that count"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 2 and frequency and cover values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0)
```

 

##### *3.5.4 Salinity Tolerance: GATE*
|       At GATE, there were `r salinity$sal_category_count_per_park$GATE$Low %>% pluck("sp_count")`, `r salinity$sal_category_count_per_park$GATE$Medium %>% pluck("sp_count")`, and `r salinity$sal_category_count_per_park$GATE$High %>% pluck("sp_count")` species classified as low, medium, and high salinity tolerance (respectively) and `r salinity$sal_category_count_per_park$GATE$unknown %>% pluck("sp_count")` species that were missing salinity tolerance data (Table 7, Appendix 3d). The count of species with low (mean: `r salinity$sal_mean_count_all_yrs$GATE$Low$mean_se_count`), medium (mean: `r salinity$sal_mean_count_all_yrs$GATE$Medium$mean_se_count`), and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$GATE$High$mean_se_count`) remained unchanged over the study period (Figure 11a). The frequency of species with low salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$GATE$Low$mean_se_frq`) and medium salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$GATE$Medium$mean_se_frq`) remained unchanged over the study period at GATE, whereas the frequency of species with high salinity tolerance decreased at a rate of `r salinity$sal_frq_results_text$GATE$High$change_count_text` (*p* `r salinity$sal_frq_results_text$GATE$High$format_p`; mean: `r salinity$sal_mean_frq_all_yrs$GATE$High$mean_se_frq`) (Figure 11b). The mean cover of species with low salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$GATE$Low$mean_se_cover`) and medium salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$GATE$Medium$mean_se_cover`) remained unchanged over the study period at GATE, whereas the mean cover of species with high salinity tolerance decreased at a rate of `r salinity$sal_cover_results_text$GATE$High$change_count_text` (*p* `r salinity$sal_cover_results_text$GATE$High$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$GATE$High$mean_se_cover`) (Figure 11c). Note that differences between the year 2014 and other years are most likely related to the fact that only 1 site (out of 3) was sampled at GATE in 2014.

```{r Figure 11, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, fig.height=4, out.width=6.5, out.height=4}
ggdraw(salinity_plot(park = "GATE"), ylim = c(-0.25,1)) +
  draw_label(bquote(bold("Figure 11.")~"GATE (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that count"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 2 and frequency and cover values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0)
```

 

##### *3.5.5 Salinity Tolerance: GEWA*
|       At GEWA, there were `r salinity$sal_category_count_per_park$GEWA$Low %>% pluck("sp_count")`, `r salinity$sal_category_count_per_park$GEWA$Medium %>% pluck("sp_count")`, and `r salinity$sal_category_count_per_park$GEWA$High %>% pluck("sp_count")` species classified as low, medium, and high salinity tolerance (respectively) and `r salinity$sal_category_count_per_park$GEWA$unknown %>% pluck("sp_count")` species that were missing salinity tolerance data (Table 7, Appendix 3e). The count of species with low (mean: `r salinity$sal_mean_count_all_yrs$GEWA$Low$mean_se_count`), medium (mean: `r salinity$sal_mean_count_all_yrs$GEWA$Medium$mean_se_count`), and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$GEWA$High$mean_se_count`) remained unchanged over the study period (Figure 12a). The frequency of species with low (mean: `r salinity$sal_mean_frq_all_yrs$GEWA$Low$mean_se_frq`), medium (mean: `r salinity$sal_mean_frq_all_yrs$GEWA$Medium$mean_se_frq`), and high salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$GEWA$High$mean_se_frq`) remained unchanged over the study period at GEWA (Figure 12b). The mean cover of species with low salinity tolerance remained unchanged over the study period at GEWA (mean: `r salinity$sal_mean_cover_all_yrs$GEWA$Low$mean_se_cover`). The mean cover of species with medium salinity tolerance decreased at a rate of `r salinity$sal_cover_results_text$GEWA$Medium$change_count_text` (*p* `r salinity$sal_cover_results_text$GEWA$Medium$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$GEWA$Medium$mean_se_cover`) (Figure 12c). The mean cover of species with high salinity tolerance decreased at a rate of `r salinity$sal_cover_results_text$GEWA$High$change_count_text` (*p* `r salinity$sal_cover_results_text$GEWA$High$format_p`; mean: `r salinity$sal_mean_cover_all_yrs$GEWA$High$mean_se_cover`) (Figure 12c).

```{r Figure 12, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, fig.height=4, out.width=6.5, out.height=4}
ggdraw(salinity_plot(park = "GEWA"), ylim = c(-0.25,1)) +
  draw_label(bquote(bold("Figure 12.")~"GEWA (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that cover"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0) 
```

 

##### *3.5.6 Salinity Tolerance: SAHI*
|       At SAHI, no species with low salinity tolerance were found throughout the entire study period. There were `r salinity$sal_category_count_per_park$SAHI$Medium %>% pluck("sp_count")` species classified as medium salinity tolerance and `r salinity$sal_category_count_per_park$SAHI$High %>% pluck("sp_count")` species classified as high salinity tolerance (Table 7, Appendix 3f). The count of species with medium salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$SAHI$Medium$mean_se_count`) and high salinity tolerance (mean: `r salinity$sal_mean_count_all_yrs$SAHI$High$mean_se_count`) remained unchanged over the study period at SAHI (Figure 13a). The frequency of species with medium salinity tolerance (mean: `r salinity$sal_mean_frq_all_yrs$SAHI$Medium$mean_se_frq`) remained unchanged over the study period at GEWA (Figure 12b). The trend in frequency of high salinity tolerance species at SAHI could not be estimated since frequency was 100% in every year; Figure 13b). The mean cover of species with medium salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$SAHI$Medium$mean_se_cover`) and high salinity tolerance (mean: `r salinity$sal_mean_cover_all_yrs$SAHI$High$mean_se_cover`) remained unchanged over the study period at SAHI (Figure 13c).

```{r Figure 13, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6.5, fig.height=4, out.width=6.5, out.height=4}
ggdraw(salinity_plot(park = "SAHI"), ylim = c(-0.25,1))+
  draw_label(bquote(bold("Figure 13.")~"SAHI (a) species count, (b) frequency, and (c) cover in each salinity tolerance category."), x = 0.02, y = -0.08, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("Rates of change that were significant are shown for each metric/salinity category. Note that count"), x = 0.02, y = -0.14, size = 12, fontfamily = "serif", hjust = 0) +
  draw_label(bquote("values below 2 and frequency and cover values below 10% are not shown."), x = 0.02, y = -0.2, size = 12, fontfamily = "serif", hjust = 0)
```

 

##### **3.7** Community Composition

```{r Community Composition, echo=FALSE, message=FALSE, warning=FALSE}

species_matrix <- veg_cleaned$site_perc_cover %>%
  ungroup() %>%
  select(UniqueID, UnitCode, Year_chr, SciName_cor, mean_site_cover) %>%
  group_by(UniqueID, UnitCode, Year_chr, SciName_cor) %>%
  pivot_wider(., names_from = "SciName_cor", values_from = "mean_site_cover", values_fill = 0) %>%
  ungroup() %>%
  filter(complete.cases(.))

# ADONIS
ado <- function(park){
  
  set.seed(10403)
  
  ado_species <- species_matrix %>%
    arrange(UniqueID, UnitCode, Year_chr) %>%
    filter(UnitCode == park) %>%
    select(-c(UniqueID, UnitCode, Year_chr))
  
  ado_env <- species_matrix %>%
    arrange(UniqueID, UnitCode, Year_chr) %>%
    filter(UnitCode == park) %>%
    select(UniqueID, Year_chr) %>%
    distinct()
  
  ado_mod <- adonis2(ado_species ~ Year_chr, data = ado_env)
  
  if(park == "SAHI") {
    ado_pairwise <- pairwiseAdonis::pairwise.adonis(ado_species, ado_env$Year_chr, p.adjust.m = "fdr") %>%
      filter(p.adjusted < 0.1)
  } else {
    ado_pairwise <- pairwiseAdonis::pairwise.adonis(ado_species, ado_env$Year_chr, p.adjust.m = "fdr") %>%
      filter(p.adjusted < 0.05)
  }
  
  list("species" = ado_species, "env" = ado_env, "mod" = ado_mod, "pairwise" = ado_pairwise)
}

# I ran these 1 at a time because ASIS and FIIS take a long time (~45 min each)
# ado_asis <- ado("ASIS")
# save(ado_asis, file = "./data/derived/adonis/asis_adonis.rda")
# ado_colo <- ado("COLO")
# save(ado_colo, file = "./data/derived/adonis/colo_adonis.rda")
# ado_fiis <- ado("FIIS")
# save(ado_fiis, file = "./data/derived/adonis/fiis_adonis.rda")
# ado_gate <- ado("GATE")
# save(ado_gate, file = "./data/derived/adonis/gate_adonis.rda")
# ado_gewa <- ado("GEWA")
# save(ado_gewa, file = "./data/derived/adonis/gewa_adonis.rda")
# ado_sahi <- ado("SAHI")
# save(ado_sahi, file = "./data/derived/adonis/sahi_adonis.rda")

# load adonis models
adonis_mods <- list.files(here::here("data", "derived", "adonis"), pattern = ".rda", full.names = TRUE) %>%
  map(~get(load(.))) %>%
  set_names(., nm = sort(unique(veg_cleaned$park_perc_cover$UnitCode)))


# SIMPER
# set.seed(10403)
# simper_fun <- function(park){
#   
#   simper_species <- species_matrix %>%
#     arrange(UniqueID, UnitCode, Year_chr) %>%
#     filter(UnitCode == park) %>%
#     select(-c(UniqueID, UnitCode, Year_chr))
#   
#   simper_env <- species_matrix %>%
#     filter(UnitCode == park) %>%
#     select(UniqueID, Year_chr) %>%
#     distinct()
#   
#   simper_mod <- with(simper_env, simper(simper_species, Year_chr, permutations = 999)) 
# }

# I ran these 1 at a time because ASIS and FIIS take a long time
# asis_simper <- simper_fun("ASIS")
# save(asis_simper, file = "./data/derived/simper/asis_simper.rda")
# colo_simper <- simper_fun("COLO")
# save(colo_simper, file = "./data/derived/simper/colo_simper.rda")
# fiis_simper <- simper_fun("FIIS")
# save(fiis_simper, file = "./data/derived/simper/fiis_simper.rda")
# gate_simper <- simper_fun("GATE")
# save(gate_simper, file = "./data/derived/simper/gate_simper.rda")
# gewa_simper <- simper_fun("GEWA")
# save(gewa_simper, file = "./data/derived/simper/gewa_simper.rda")
# sahi_simper <- simper_fun("SAHI")
# save(sahi_simper, file = "./data/derived/simper/sahi_simper.rda")

# load simper models
# simper <- list.files(here::here("data", "derived", "simper"), pattern = ".rda", full.names = TRUE) %>%
#   map(~get(load(.))) %>%
#   set_names(., nm = sort(unique(plot_veg_cover_usda$UnitCode)))


# KRUSKAL - note: kruskal tests were run using 'park_kruskals.R'
# load kruskal test results
kruskal <- list(
  kruskal_mods = list.files(here::here("data", "derived", "kruskal"), pattern = ".rda", full.names = TRUE) %>%
  map(~get(load(.))) %>%
  set_names(., nm = sort(unique(veg_cleaned$park_perc_cover$UnitCode)))
  )

# function to get list of species with significant differences between years
kruskal_species_fun <- function(park) {

  if(park == "ASIS") {
    year_combos <- c(str_replace(adonis_mods$ASIS$pairwise$pairs, " vs ", "_"))
  } else if(park == "COLO") {
    year_combos <- c(str_replace(adonis_mods$COLO$pairwise$pairs, " vs ", "_"))
  } else if(park == "FIIS") {
    year_combos <- c(str_replace(adonis_mods$FIIS$pairwise$pairs, " vs ", "_"))
  } else if(park == "GATE") {
    year_combos <- c(str_replace(adonis_mods$GATE$pairwise$pairs, " vs ", "_"))
  } else if(park == "GEWA") {
    year_combos <- c(str_replace(adonis_mods$GEWA$pairwise$pairs, " vs ", "_"))
  } else if(park == "SAHI") {
    year_combos <- c(str_replace(adonis_mods$SAHI$pairwise$pairs, " vs ", "_"))
  }
  
  year_combo_list <- map_chr(year_combos, ~paste0("mod_p_", .x))
  
  kruskal_len <- adonis_mods %>% pluck(park) %>% pluck("pairwise") %>% nrow()
  
  if(kruskal_len == 0){
    NULL
  } else {
  
    kruskal$kruskal_mods %>%
      pluck(park) %>%
      ungroup() %>%
      select(UnitCode, SciName_cor, year_combo_list) %>%
      unnest() %>%
      pivot_longer(., cols = -c("UnitCode", "SciName_cor"), names_to = "year_pair", values_to = "p_val") %>%
      filter(p_val < 0.05) %>%
      mutate(year_combo = paste0(str_sub(year_pair, 7, 10), " vs ", str_sub(year_pair, 12, 15)))
  }
}

# use the function to get list of species with significant differences between years
kruskal[["kruskal_park_species"]] <- list("ASIS", "COLO", "FIIS", "GATE", "GEWA", "SAHI") %>%
  map(., ~kruskal_species_fun(.x)) %>%
  set_names(., nm = sort(unique(c("ASIS", "COLO", "FIIS", "GATE", "GEWA", "SAHI"))))

kruskal[["kruskal_species_text"]] <- kruskal$kruskal_park_species %>%
  bind_rows() %>%
  ungroup() %>%
  select(UnitCode, SciName_cor) %>%
  group_by(UnitCode) %>%
  unique() %>%
  arrange(SciName_cor) %>%
  nest() %>%
  mutate(sp_list = map(data, ~knitr::combine_words(if_else(lengths(strsplit(.x$SciName_cor, "\\W+")) > 1,
                                                           paste0("*", .x$SciName_cor, "*"),
                                                           paste0("an unidentified ", "*", .x$SciName_cor, "*", " species"))))) %>%
  ungroup() %>%
  dplyr::select(-data)
```

```{r old Adonis plot function, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ado_plot_old <- function(park, second_plot = FALSE){

  include_vector <- adonis_mods %>% pluck(park) %>% pluck("pairwise") %>% pluck("pairs")

  park_cover <- veg_cleaned$site_perc_cover %>% 
    filter(UnitCode == park) %>%
    ungroup() %>%
    select(UniqueID, UnitCode, Year_chr, SciName_cor, mean_site_cover) %>%
    group_by(UniqueID, UnitCode, Year_chr, SciName_cor) %>%
    pivot_wider(., names_from = "SciName_cor", values_from = "mean_site_cover", values_fill = 0) %>%
    pivot_longer(., cols = -c("UniqueID", "UnitCode", "Year_chr"), names_to = "SciName_cor", values_to = "mean_site_cover") %>%
    group_by(UnitCode, Year_chr, SciName_cor) %>%
    summarise(mean_cover = mean(mean_site_cover, na.rm = TRUE)) 
  
  years <- park_cover %>%
    group_by(UnitCode) %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           first_date = as.integer(lubridate::year(min(Year))),
           last_date = as.integer(lubridate::year(max(Year)))) %>%
    ungroup() %>%
    select(first_date, last_date) %>%
    distinct()

  year_list <- as.list(seq(years$first_date, years$last_date, by = 2)) %>% map(., ~as.character(.x))
  
  year_list_combos <- as.data.frame(expand.grid("col1" = year_list, "col2" = year_list))

  df_filter_fun <- function(year1, year2) {
    park_year1 <- park_cover %>% filter(Year_chr == year1)
    park_year2 <- park_cover %>% filter(Year_chr == year2)
    
    park_year1_year2 <- full_join(park_year1, park_year2, by = "SciName_cor") %>%
      mutate(cover_dif = mean_cover.y - mean_cover.x)
    
    return(park_year1_year2)
  } 
  
  df_names <- year_list_combos %>%
    mutate(names = paste0(park, "_", col1, "_", col2)) %>%
    pull(names)

  park_species_difs <- map2(
    year_list_combos$col1, 
    year_list_combos$col2, 
    ~df_filter_fun(year1 = .x, year2 = .y)) %>%
    set_names(., nm = df_names) %>%
    bind_rows() %>%
    mutate(year_combo = paste0(Year_chr.x, " vs ", Year_chr.y))
  
  points_df <- park_species_difs %>% 
    left_join(., kruskal$kruskal_park_species %>% pluck(park), by = c("SciName_cor", "year_combo")) %>% 
    filter(!is.na(p_val)) %>%
    ungroup() %>%
    select(SciName_cor, year_combo, Year_chr.x, mean_cover.x, Year_chr.y, mean_cover.y) %>%
    pivot_longer(., cols = -c(SciName_cor, year_combo), names_to = c(".value", "group"), names_sep ="\\.") %>%
    select(-group) %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_cor_lab = if_else(SciName_cor %in%c("Carex", "Salicornia", "Juncus", "Rumex", "Polygonum"), paste0(SciName_cor, " spp."), SciName_cor))
  
  points_dfb <- points_df %>%
    ungroup() %>%
    select(year_combo, Year_chr, mean_cover, SciName_cor) %>%
    group_by(year_combo, SciName_cor) %>%
    mutate(cover_dif = max(mean_cover)-min(mean_cover)) %>%
    {if (park == "COLO" & second_plot == FALSE) filter(., SciName_cor %in% c("Peltandra virginica", "Polygonum", "Pontederia cordata", "Schoenoplectus pungens", "Spartina alterniflora", "Spartina cynosuroides", "Zizania aquatica"))
      else if (park == "COLO" & second_plot == TRUE) filter(., SciName_cor %in% c("Juncus effusus", "Juncus roemarianus", "Juncus tenuis", "Polygonum punctatum", "Schoenoplectus pungens var. pungens", "Schoenoplectus tabernaemontani", "Typha angustifolia"))
      else .} %>%
    group_by(year_combo) %>%
     # {if (park == "COLO" & second_plot == FALSE) slice_max(., order_by = cover_dif, n = 5)
     #   else if (park == "COLO" & second_plot == TRUE) slice_min(., order_by = cover_dif, n = 5)
     #   else .} %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_cor_lab = if_else(SciName_cor %in%c("Carex", "Salicornia", "Juncus", "Rumex", "Polygonum"), paste0(SciName_cor, " spp."), SciName_cor))
  
  lines_df <- veg_cleaned$site_perc_cover %>%
    filter(UnitCode == park) %>%
    ungroup() %>%
    select(UniqueID, UnitCode, Year_chr, SciName_cor, mean_site_cover) %>%
    pivot_wider(., names_from = "SciName_cor", values_from = "mean_site_cover", values_fill = 0) %>%
    pivot_longer(., cols = -c("UniqueID", "UnitCode", "Year_chr"), names_to = "SciName_cor", values_to = "mean_site_cover") %>%
    group_by(UnitCode, Year_chr, SciName_cor) %>%
    summarise(mean_cover = mean(mean_site_cover, na.rm = TRUE)) %>%
    filter(SciName_cor %in% c(points_dfb %>% pull(SciName_cor) %>% unique())) %>%
    arrange(SciName_cor, Year_chr) %>%
    left_join(., points_dfb %>% select(SciName_cor, year_combo), by = "SciName_cor", relationship = "many-to-many") %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           SciName_cor_lab = if_else(SciName_cor %in%c("Carex", "Salicornia", "Juncus", "Rumex", "Polygonum"), paste0(SciName_cor, " spp."), SciName_cor))
  
  dummy_df <- lines_df %>%
    group_by(year_combo) %>%
    {if (park %in% c("ASIS", "COLO")) mutate(., ylim = max(mean_cover) + 0.2*max(mean_cover))
      else if(park == "GEWA") mutate(., ylim = max(mean_cover) + 0.15*max(mean_cover))
      else mutate(., ylim = max(mean_cover) + 0.40*max(mean_cover))}
  
  if (park == "ASIS"){
    xlims <- c(as.Date("2008-01-01"), as.Date("2018-01-01"))
    xbreaks <- seq.Date(as.Date("2008-01-01"), as.Date("2018-01-01"), by = "2 years")
    legend_col <- 3
  } else if (park == "COLO"){
    xlims <- c(as.Date("2008-01-01"), as.Date("2016-01-01"))
    xbreaks <- seq.Date(as.Date("2008-01-01"), as.Date("2016-01-01"), by = "2 years")
      if(second_plot == FALSE) {
        legend_col <- 3
      } else {
        legend_col <- 2
      }
  } else if (park == "FIIS"){
    xlims <- c(as.Date("2009-01-01"), as.Date("2017-01-01"))
    xbreaks <- seq.Date(as.Date("2009-01-01"), as.Date("2017-01-01"), by = "2 years")
    legend_col <- 3
  } else if (park == "GATE"){
    xlims <- c(as.Date("2010-01-01"), as.Date("2018-01-01"))
    xbreaks <- seq.Date(min(xlims), max(xlims), by = "2 years")
    legend_col <- 3
  } else if (park == "GEWA"){
    xlims <- c(as.Date("2008-01-01"), as.Date("2012-01-01"))
    xbreaks <- seq.Date(as.Date("2008-01-01"), as.Date("2012-01-01"), by = "1 year")
    legend_col <- 3
  } else if (park == "SAHI"){
    xlims <- c(as.Date("2009-01-01"), as.Date("2017-01-01"))
    xbreaks <- seq.Date(min(xlims), max(xlims), by = "2 years")
    legend_col <- 3
  }
  
  ggplot(lines_df, aes(x = Year, y = mean_cover, color = SciName_cor_lab, fill = SciName_cor_lab)) +
    geom_blank(data = dummy_df, aes(x = Year, y = ylim)) +
    geom_line() +
    geom_point(data = points_dfb, aes(x = Year, y = mean_cover,), size = 2, color = "black", shape = 21) +
    geom_text(data = lines_df %>%
                ungroup() %>%
                distinct(year_combo) %>%
                arrange(year_combo) %>%
                mutate(letter = paste0("(",LETTERS[1:n()], ")"),
                       f = pmap_chr(list(letter, year_combo), function(a, b) deparse(bquote(bold(.(a)~plain(.(b))))))),
              aes(x = structure(-Inf, class = "Date"), y =  Inf, label = f),
              hjust = -0.1, vjust = 1.5, size  = 3.5, fontface = "bold", family = "serif", parse = T, inherit.aes = F) +
    lemon::facet_rep_wrap(~year_combo, scales = "free_y") +
    scale_y_continuous(name = "Cover (%)", sec.axis = dup_axis()) +
    scale_x_date(limits = xlims, breaks = xbreaks, date_labels = "'%y", sec.axis = dup_axis()) +
    guides(color = guide_legend(title = "Species:", ncol = legend_col), fill = guide_legend(title = "Species:", ncol = legend_col)) +
    lfeheR::theme(base_size = 12) +
    theme(
      axis.title.y = element_text(margin = margin(r = 10, unit = "pt")),
      text = element_text(family = "serif", size = 12),
      legend.key = element_rect(color = "transparent"),
      legend.text = element_text(face = "italic"),
      legend.position = "bottom",
      legend.title.position = "top",
      legend.title = element_text(hjust = 0),
      legend.margin = margin(t = 0, unit = "pt"),
      legend.key.spacing.y = unit(0, "pt"),
      legend.justification = 0.5,
      panel.grid.major = element_line(color = "grey", linewidth = 0.5, linetype = "dashed"),
      panel.spacing = unit(10, "pt"),
      strip.background = element_blank(),
      strip.text = element_blank()
    )
}
```

```{r Adonis plot function, message=FALSE, warning=FALSE, include=FALSE}
ado_plot <- function(park){
  
  include_vector <- adonis_mods %>% pluck(park) %>% pluck("pairwise") %>% pluck("pairs")
  
  park_cover <- veg_cleaned$site_perc_cover %>% 
    filter(UnitCode == park) %>%
    ungroup() %>%
    select(UniqueID, UnitCode, Year_chr, SciName_cor, mean_site_cover) %>%
    group_by(UniqueID, UnitCode, Year_chr, SciName_cor) %>%
    pivot_wider(., names_from = "SciName_cor", values_from = "mean_site_cover", values_fill = 0) %>%
    pivot_longer(., cols = -c("UniqueID", "UnitCode", "Year_chr"), names_to = "SciName_cor", values_to = "mean_site_cover") %>%
    group_by(UnitCode, Year_chr, SciName_cor) %>%
    summarise(mean_cover = mean(mean_site_cover, na.rm = TRUE)) 
  
  years <- park_cover %>%
    group_by(UnitCode) %>%
    mutate(Year = as.Date(paste0(Year_chr, "-01-01")),
           first_date = as.integer(lubridate::year(min(Year))),
           last_date = as.integer(lubridate::year(max(Year)))) %>%
    ungroup() %>%
    select(first_date, last_date) %>%
    distinct()
  
  year_list <- as.list(seq(years$first_date, years$last_date, by = 2)) %>% map(., ~as.character(.x))
  
  year_list_combos <- as.data.frame(expand.grid("col1" = year_list, "col2" = year_list))
  
  df_filter_fun <- function(year1, year2) {
    park_year1 <- park_cover %>% filter(Year_chr == year1)
    park_year2 <- park_cover %>% filter(Year_chr == year2)
    
    park_year1_year2 <- full_join(park_year1, park_year2, by = "SciName_cor") %>%
      mutate(cover_dif = mean_cover.y - mean_cover.x)
    
    return(park_year1_year2)
  } 
  
  df_names <- year_list_combos %>%
    mutate(names = paste0(park, "_", col1, "_", col2)) %>%
    pull(names)
  
  park_species_difs <- map2(
    year_list_combos$col1, 
    year_list_combos$col2, 
    ~df_filter_fun(year1 = .x, year2 = .y)) %>%
    set_names(., nm = df_names) %>%
    bind_rows() %>%
    mutate(year_combo = paste0(Year_chr.x, " vs ", Year_chr.y))
  
  park_species_difs %>% 
    left_join(., kruskal$kruskal_park_species %>% pluck(park), by = c("SciName_cor", "year_combo")) %>% 
    filter(!is.na(p_val)) %>%
    select("UnitCode" = UnitCode.x, SciName_cor, Year_chr.x, Year_chr.y) %>%
    pivot_longer(., cols = -c(UnitCode, SciName_cor), names_to = "signif", values_to = "Year_chr")
}
```

|       ADONIS analyses identified significant differences in community composition between years at ASIS, COLO, and FIIS. There was no significant difference between years for GATE, GEWA, or SAHI. 

##### *3.7.1 Community Composition: ASIS*

|       At ASIS, there was a significant difference in community composition between years (*R*2 = `r signif(adonis_mods$ASIS$mod$R2[1], 2)`, *p* `r format_pval(adonis_mods[["ASIS"]][["mod"]][["Pr(>F)"]][1])`). Pairwise comparisons between years at ASIS found significant differences between `r as.character(english(adonis_mods$ASIS$pairwise %>% nrow()))` year pairs including `r adonis_mods$ASIS$pairwise %>% pluck("pairs") %>% knitr::combine_words()` (Figure 14). `r str_to_title(english(kruskal$kruskal_park_species %>% pluck("ASIS") %>% select(UnitCode, SciName_cor) %>% n_distinct()))` species contributed to the differences between these year pairs including `r kruskal$kruskal_species_text %>% filter(UnitCode == "ASIS") %>% unlist("sp_list") %>% pluck("sp_list")`.

```{r Figure 14, echo=FALSE, fig.height=5.5, fig.width=6.5, message=FALSE, warning=FALSE, out.height=5.5, out.width=6.5}
ggdraw() +
  draw_plot(
    species_matrix %>%
      filter(UnitCode == "ASIS") %>%
      pivot_longer(., cols = -c(UniqueID, UnitCode, Year_chr), names_to = "SciName_cor", values_to = "cover") %>%
      filter(SciName_cor %in% c(kruskal$kruskal_park_species %>% pluck("ASIS") %>% pluck("SciName_cor"))) %>%
      group_by(UnitCode, Year_chr, SciName_cor) %>%
      summarise(mean_cover = mean(cover),
                lab = format_sps(mean(cover)),
                lab_color = if_else(as.numeric(lab) > 49, "a", "b"),
                round_cover = as.numeric(format_sps(mean_cover)),
                binned_cover = case_when(round_cover == 0 ~ "h",
                                         round_cover <= 1 ~ "g",
                                         round_cover > 1 & round_cover <= 2 ~ "f",
                                         round_cover > 2 & round_cover <= 5 ~ "e",
                                         round_cover > 5 & round_cover <= 10 ~ "d",
                                         round_cover > 10 & round_cover <= 25 ~ "c",
                                         round_cover > 25 & round_cover <= 50 ~ "b",
                                         round_cover > 50 ~ "a")) %>%
      left_join(., ado_plot(park = "ASIS"), by = c("UnitCode", "SciName_cor", "Year_chr")) %>%
      mutate(lab_signif = if_else(!is.na(signif), paste0(lab, "*"), lab),
             sps = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                           SciName_cor,
                           paste0(SciName_cor, " sps."))) %>%
      ggplot(., aes(x = Year_chr, y = sps, fill = binned_cover)) +
      geom_tile(color = "black") +
      geom_text(aes(label = lab_signif, color = lab_color), family = "serif", show.legend = FALSE) +
      scale_x_discrete(expand = c(0,0), "Year") +
      scale_y_discrete(limits = rev, expand = c(0,0), "Species") +
      scale_fill_manual(values = rev(c('#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32')), labels = c("> 50", "25-50", "10-25", "5-10", "2-5", "1-2", "0-1", "0"), name = "Cover (%)") +
      scale_color_manual(values = c("white", "black")) +
      theme(
        panel.border= element_rect(color = "black", fill = NA),
        text = element_text(family = "serif"),
        axis.text = element_text(color = "black"),
        axis.text.y = element_text(face = "italic"),
        legend.key.size = unit(20, "pt"),
        legend.key = element_blank()
      ), y = 0.12, height = 0.89
  ) +
  draw_label(bquote(bold("Figure 14.")~"ASIS: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis. Cover values labeled with \"*\"")), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote("indicate significant differences between year pairs."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
```


```{r Figure 14 old, eval=FALSE, fig.height=5.5, fig.width=6.5, message=FALSE, warning=FALSE, include=FALSE, out.height=5.5, out.width=6.5}
ggdraw() +
  draw_plot(ado_plot_old("ASIS") + theme(legend.title = element_text(hjust = 0.5, margin = margin(0,0,5,0, "pt"))), y = 0.09, height = 0.91) +
  draw_label(bquote(bold("Figure 14.")~"ASIS: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis.")), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
```

 

##### *3.7.2 Community Composition: COLO*

|       At COLO, there was a significant difference in community composition between years (*R*2 = `r signif(adonis_mods$COLO$mod$R2[1], 2)`, *p* `r format_pval(adonis_mods[["COLO"]][["mod"]][["Pr(>F)"]][1])`). Pairwise comparisons between years at COLO found significant differences between `r as.character(english(adonis_mods$COLO$pairwise %>% nrow()))` year pairs including `r adonis_mods$COLO$pairwise %>% pluck("pairs") %>% knitr::combine_words()` (Figures 15a and 15b). `r str_to_title(english(kruskal$kruskal_park_species %>% pluck("COLO") %>% select(UnitCode, SciName_cor) %>% n_distinct()))` species contributed to the differences between these year pairs including `r kruskal$kruskal_species_text %>% filter(UnitCode == "COLO") %>% unlist("sp_list") %>% pluck("sp_list")`.

```{r Figure 15, echo=FALSE, fig.height=5.75, fig.width=6.5, message=FALSE, warning=FALSE, out.height=5.75, out.width=6.5}
ggdraw() +
  draw_plot(
    species_matrix %>%
      filter(UnitCode == "COLO") %>%
      pivot_longer(., cols = -c(UniqueID, UnitCode, Year_chr), names_to = "SciName_cor", values_to = "cover") %>%
      filter(SciName_cor %in% c(kruskal$kruskal_park_species %>% pluck("COLO") %>% pluck("SciName_cor"))) %>%
      group_by(UnitCode, Year_chr, SciName_cor) %>%
      summarise(mean_cover = mean(cover),
                lab = format_sps(mean(cover)),
                lab_color = if_else(as.numeric(lab) > 39, "a", "b"),
                round_cover = as.numeric(format_sps(mean_cover)),
                binned_cover = case_when(round_cover == 0 ~ "i",
                                         round_cover > 0 & round_cover <= 1 ~ "h",
                                         round_cover > 1 & round_cover <= 2 ~ "g",
                                         round_cover > 2 & round_cover <= 3 ~ "f",
                                         round_cover > 3 & round_cover <= 5 ~ "e",
                                         round_cover > 5 & round_cover <= 20 ~ "d",
                                         round_cover > 20 & round_cover <= 40 ~ "c",
                                         round_cover > 40 ~ "b")) %>%
      left_join(., ado_plot(park = "COLO"), by = c("UnitCode", "SciName_cor", "Year_chr")) %>%
      mutate(lab_signif = if_else(!is.na(signif), paste0(lab, "*"), lab),
             sps = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                           SciName_cor,
                           paste0(SciName_cor, " sps."))) %>%
      ggplot(., aes(x = Year_chr, y = sps, fill = binned_cover)) +
      geom_tile(color = "black") +
      geom_text(aes(label = lab_signif, color = lab_color), family = "serif", show.legend = FALSE) +
      scale_x_discrete(expand = c(0,0), "Year") +
      scale_y_discrete(limits = rev, expand = c(0,0), "Species") +
      scale_fill_manual(values = rev(c('#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32')), labels = c("> 40", "20-40", "5-20", "3-5", "2-3", "1-2", "0-1", "0"),  name = "Cover (%)") +
      scale_color_manual(values = c("white", "black")) +
      theme(
        panel.border= element_rect(color = "black", fill = NA),
        text = element_text(family = "serif"),
        axis.text = element_text(color = "black"),
        axis.text.y = element_text(face = "italic"),
        legend.key.size = unit(20, "pt"),
        legend.key = element_blank()
      ), y = 0.12, height = 0.89
  ) +
  draw_label(bquote(bold("Figure 15.")~"COLO: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis. Cover values labeled with \"*\"")), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote("indicate significant differences between year pairs."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
```

```{r Figure 15a old, eval=FALSE, fig.height=5.75, fig.width=6.5, message=FALSE, warning=FALSE, include=FALSE, out.height=5.75, out.width=6.5}
ggdraw() +
  draw_plot(ado_plot_old("COLO") + theme(legend.title = element_text(hjust = 0.5, margin = margin(0,0,5,0, "pt"))), y = 0.12, height = 0.88) +
  draw_label(bquote(bold("Figure 15a.")~"COLO: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.1, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis. Note that only the species with the")), x = 0.02, y = 0.06, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("top five greatest changes in cover that contributed to the differences between year-pairs are shown.")), x = 0.02, y = 0.02, fontfamily = "serif", hjust = 0, size = 12)
```

```{r Figure 15b old, eval=FALSE, fig.height=6, fig.width=6.5, message=FALSE, warning=FALSE, include=FALSE, out.height=6, out.width=6.5}
ggdraw() +
  draw_plot(ado_plot_old("COLO", second_plot = TRUE) + theme(legend.title = element_text(hjust = 0.5, margin = margin(0,0,5,0, "pt"))), y = 0.12, height = 0.88) +
  draw_label(bquote(bold("Figure 15b.")~"COLO: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.1, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis. Note that only the species with")), x = 0.02, y = 0.06, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("small changes in cover that contributed to the differences between year-pairs are shown.")), x = 0.02, y = 0.02, fontfamily = "serif", hjust = 0, size = 12)
```
&nbsp; 

##### *3.7.3 Community Composition: FIIS*
|       At FIIS, there was a significant difference in community composition between years (*R*2 = `r signif(adonis_mods$FIIS$mod$R2[1], 2)`, *p* `r format_pval(adonis_mods[["FIIS"]][["mod"]][["Pr(>F)"]][1])`). Pairwise comparisons between years at ASIS found significant differences between `r as.character(english(adonis_mods$FIIS$pairwise %>% nrow()))` year pairs including `r adonis_mods$FIIS$pairwise %>% pluck("pairs") %>% knitr::combine_words()` (Figure 16). `r str_to_title(english(kruskal$kruskal_park_species %>% pluck("FIIS") %>% select(UnitCode, SciName_cor) %>% n_distinct()))` species contributed to the differences between these year pairs including `r kruskal$kruskal_species_text %>% filter(UnitCode == "FIIS") %>% unlist("sp_list") %>% pluck("sp_list")`.

```{r Figure 16, echo=FALSE, fig.height=5.5, fig.width=6.5, message=FALSE, warning=FALSE, out.height=5.5, out.width=6.5}
ggdraw() +
  draw_plot(
    species_matrix %>%
      filter(UnitCode == "FIIS") %>%
      pivot_longer(., cols = -c(UniqueID, UnitCode, Year_chr), names_to = "SciName_cor", values_to = "cover") %>%
      filter(SciName_cor %in% c(kruskal$kruskal_park_species %>% pluck("FIIS") %>% pluck("SciName_cor"))) %>%
      group_by(UnitCode, Year_chr, SciName_cor) %>%
      summarise(mean_cover = mean(cover),
                lab = format_sps(mean(cover)),
                lab_color = if_else(as.numeric(lab) > 39, "a", "b"),
                round_cover = as.numeric(format_sps(mean_cover)),
                binned_cover = case_when(round_cover == 0 ~ "i",
                                         round_cover > 0 & round_cover <= 1 ~ "h",
                                         round_cover > 1 & round_cover <= 2 ~ "g",
                                         round_cover > 2 & round_cover <= 5 ~ "f",
                                         round_cover > 5 & round_cover <= 10 ~ "e",
                                         round_cover > 10 & round_cover <= 30 ~ "d",
                                         round_cover > 30 & round_cover <= 40 ~ "c",
                                         round_cover > 40 ~ "b")) %>%
      left_join(., ado_plot(park = "FIIS"), by = c("UnitCode", "SciName_cor", "Year_chr")) %>%
      mutate(lab_signif = if_else(!is.na(signif), paste0(lab, "*"), lab),
             sps = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                           SciName_cor,
                           paste0(SciName_cor, " sps."))) %>%
      ggplot(., aes(x = Year_chr, y = sps, fill = binned_cover)) +
      geom_tile(color = "black") +
      geom_text(aes(label = lab_signif, color = lab_color), family = "serif", show.legend = FALSE) +
      scale_x_discrete(expand = c(0,0), "Year") +
      scale_y_discrete(limits = rev, expand = c(0,0), "Species") +
      scale_fill_manual(values = rev(c('#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32')), labels = c("> 40", "30-40", "10-30", "5-10", "2-5", "1-2", "0-1", "0"),  name = "Cover (%)") +
      scale_color_manual(values = c("white", "black")) +
      theme(
        panel.border= element_rect(color = "black", fill = NA),
        text = element_text(family = "serif"),
        axis.text = element_text(color = "black"),
        axis.text.y = element_text(face = "italic"),
        legend.key.size = unit(20, "pt"),
        legend.key = element_blank()
      ), y = 0.12, height = 0.89
  ) +
  draw_label(bquote(bold("Figure 16.")~"FIIS: The change in mean cover of species contributing to differences between"), x = 0.02, y = 0.11, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis. Cover values labeled with \"*\"")), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote("indicate significant differences between year pairs."), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
```


```{r Figure 16 old, eval=FALSE, fig.height=5.5, fig.width=6.5, message=FALSE, warning=FALSE, include=FALSE, out.height=5.5, out.width=6.5}
ggdraw() +
  draw_plot(ado_plot_old("FIIS") + theme(legend.title = element_text(hjust = 0.5, margin = margin(0,0,5,0, "pt"))), y = 0.09, height = 0.91) +
  draw_label(bquote(bold("Figure 16.")~"FIIS: The change in mean cover (%) of species contributing to differences between"), x = 0.02, y = 0.07, fontfamily = "serif", hjust = 0, size = 12) +
  draw_label(bquote(plain("significantly different year-pairs identified by ADONIS analysis.")), x = 0.02, y = 0.03, fontfamily = "serif", hjust = 0, size = 12)
```

 

#### **4. Discussion**

##### **4.1** Park-level Trends

In the following paragraphs of this section, we summarize the above results for each park. We also identify critical limitations of the current data set and discuss how these findings could be used to modify and improve upon the existing salt marsh vegetation monitoring protocol.   

##### *4.1.1 Park-level Trends: ASIS*
|       The salt marsh plant community at ASIS has seen a reduction in total park-level species richness (Figure 3a) that is most likely due to the loss of species with medium salinity tolerance and/or species in the salt marsh open ditch category (Figure 5a and 11a). Similarly, mean total plot-level cover at ASIS declined substantially between 2008 to 2018 (Figure 2a), however this change was most likely driven by the decreasing frequency and cover of species with high salinity tolerance and/or species in the salt marsh pool/panne and tidal lagoon categories (Figure 5b and 5c, Figure 11b and 11c). Taken together, these results would seem to suggest that there has been a general decline in all salt marsh habitat at ASIS given the decreases in park-level species richness (Figure 3a) and frequency and cover of species with high salinity tolerance (Figure 5 and 11). Decline in the salt marsh habitats at ASIS could be the result of both conversion to open water due to sea-level rise and climate change and/or conversion to other wetland or upland habitats. However, the second process seems unlikely to be playing a strong role given that total plot cover (i.e., cover of species with all salinity tolerances and community classification categories) also declined between 2008 to 2018 (Figure 2a). Additionally, it is important to note that many of the previously mentioned metrics declined when comparing the data from the first sampling event in 2008 to the last sampling event in 2018, a closer inspection of their respective figures could also suggest that the majority of these declines occurred between 2008 to 2014, after which many of these metrics seemed to experience some recovery, although most have not recovered back to their 2008 level (Figures 2a, 3a, 5c, and 11c) . Regardless of the mechanism, additional data in the form of remotely sensed imagery (either from publicly available collections such as Landsat or from imagery collected by the park or NCBN staff) would be needed to confirm if these declines are indeed occurring as the salt marsh monitoring data would suggest, and also to quantify the spatial magnitude and rate of change.\
 

##### *4.1.2* Park-level Trends: COLO

| 

##### *4.1.3* Park-level Trends: FIIS

##### *4.1.4* Park-level Trends: GATE

##### *4.1.5* Park-level Trends: GEWA

##### *4.1.6* Park-level Trends: SAHI

 

##### **4.2** Opportunities for Future Salt Marsh Vegetation Monitoring at NCBN Parks

|     Although the manual field surveys that were previously conducted by NCBN have provided crucial information about the plant species diversity of the salt marshes at each park, these surveys were extremely time, labor, and cost intensive. As a result of these constraints, these surveys were relatively limited in their spatial and temporal scale. The power analyses conducted by Peck et al. (2021) suggests that the current sampling intensity and frequency are not high enough to detect a true difference in many of the metrics of interest at most parks. Therefore, monitoring approaches that can increase the spatial coverage of observations and thereby provide a greater ability to detect change at scales that are meaningful to park resource managers while minimizing the logistical constraints associated with field work would be highly valuable.

Over the past two decades, advances in the field of remote sensing have led to a rapid expansion in the use of these technologies for ecological research applications. In particular, UAS-based (unmanned aerial systems) surveys have become increasing popular as a tool for ecological monitoring given their relatively low cost, the ever-expanding options for sensor payloads, and straight-forward integration with existing image processing software. Additionally, UAS-based methods also have several advantages over satellite- or aircraft-based imagery. For instance, UAS-derived imagery can be collected at low altitude over specific areas and therefore have higher resolution. Additionally, repeated surveys utilizing UAS can be collected as often as needed and are not limited by weather, site access, or the presence of clouds. Finally, the costs associated with acquiring UAS-based imagery are generally much lower as compared to the cost of either buying imagery from a supplier (e.g., Planet labs, Maxar, etc.) or paying for image collection using manned aircraft (Manfreda et al. 2018).

Several recent peer-reviewed publications have demonstrated the utility of UAS-based remote sensing for monitoring vegetation changes in coastal wetlands. Myers et al. (2018) used a UAS equipped with a low-cost RGB camera and free, open-sourced software to develop multi-band image stacks that were needed to improve land cover classification accuracy for a coastal marsh in Westport, Massachusetts. Impressively, the authors of this study were able to collect over 1,500 aerial photographs over a period of just 71 minutes within a single field day using a single UAS (Myers et al. 2018). Díaz-Delgado et al. (2019) developed several indicators of ecological integrity that were assessed using UAS-based imagery for coastal wetlands located with the Doñana long-term ecological research site in Spain. Using data collected from only two flights, these authors were able to develop spectral indices that were comparable to on the ground surveys and also allowed for a rapid assessment of the cover of specific wetland species, open water cover, biomass, inundation depth, and water turbidity (Díaz-Delgado et al. 2019). Pricope et al. (2024) demonstrated the effectiveness of UAS-based imagery for classifying coastal wetlands by functional type across seven sites along the coast of North Carolina that span a gradient from forested palustrine to estuarine. Notably, these authors found that classification accuracies were highest (\> 80%) for estuarine intertidal emergent wetlands as a result of the low structural complexity that is typical of salt marsh plant communities (Pricope et al. 2024). Finally, although there are many different study designs and survey techniques that have been successfully used for capturing ecological data via UAS, Puckett et al. have developed a standardized protocol specifically for monitoring coastal wetlands with UAS that could be easily adopted and implemented by NCBN (Puckett et al., DiGiacomo et al. 2022).

There are many well established methods for either classifying marshes into relatively broad categories such as (e.g., low marsh, high marsh, dune, etc.) or to identify a few species that are easily distinguished from surrounding vegetation (e.g., Spartina alterniflora vs. mixed Distichlis spicata/Spartina patens) that could be adapted to the NCBN salt marsh vegetation monitoring protocol (Mason Harris et al., 2024). In fact, monitoring a subset of ecologically important cover groups or species is likely to be just as (if not more) informative for understanding changes in marsh condition as compared to measuring the cover of every single species because a) changes in the cover of a single species are not necessarily indicative of changes occurring across the broader landscape, and b) even the most pristine North American salt marshes are known to have very low species and functional diversity. Additionally, we could combine other remotely sensed metrics of marsh health, such as biomass, NDVI, plant height, etc. with the cover classifications to obtain a more comprehensive picture of marsh health. For example, results obtained from the previously collected ground-survey data indicate that species richness and diversity has remained largely unchanged over time, thus giving the impression that these marshes are also maintaining a ‘stable’ condition. However, there are numerous studies (in addition to the surface elevation table data collected by NCBN) that have found that marshes across the Atlantic coast of the U.S. are not keeping pace with sea-level rise and are either migrating laterally (where possible) or, in most cases, converting to open water, suggesting that there are likely to be changes occurring in the salt marsh ecosystems within these parks that are not being adequately captured by the current protocol. Further evidence for these points can be seen in the changes identified by the analysis of the salinity tolerance categories presented in the previous section, where the use of broad categories allowed for the detection of changes that were not apparent in the cover of individual species. Therefore, the information derived from UAS-based data collection is likely to be both easier to interpret and more informative, and thus more readily actionable by park resource managers. 
&nbsp;

#### **5. Literature Cited**

Benjamini, Y., and Y. Hochberg. 1995. Controlling the false discovery rate: a practical and powerful approach to multiple testing. Journal of the Royal Statistical Society Series B 57:289-300. doi.org/10.1111/j/2517-6161.1995.tb02031.x.

Díaz-Delgado, R., Cazacu, C., & Adamescu, M. (2019). Rapid Assessment of Ecological Integrity for LTER Wetland Sites by Using UAV Multispectral Mapping. Drones, 3(1), 3. <https://doi.org/10.3390/drones3010003>.

DiGiacomo, A.E., R. Giannelli, B. Puckett, E. Smith, J.T. Ridge, and J. Davis. 2022. Considerations and tradeoffs of UAS-based coastal wetland monitoring in the Southeastern United States. Frontiers in Remote Sensing 3. doi.org/10.3389/frsen.2022.924969.

Manfreda, S., McCabe, M. F., Miller, P. E., Lucas, R., Pajuelo Madrigal, V., Mallinis, G., Ben Dor, E., Helman, D., Estes, L., Ciraolo, G., Müllerová, J., Tauro, F., De Lima, M. I., De Lima, J. L. M. P., Maltese, A., Frances, F., Caylor, K., Kohv, M., Perks, M., ... Toth, B. (2018). On the Use of Unmanned Aerial Systems for Environmental Monitoring. Remote Sensing, 10(4), 641. <https://doi.org/10.3390/rs10040641>.

Mason Harris, J., W.P. Broussard III, and J.A. Nelson. 2024. Evaluating coastal wetland restoration using drones and high-resolution imagery. Estuaries and Coasts 47:1359-1375. doi.org/10.1007/s12237-024-01376-1.

Myers, D.J., C.M. Schweik, R. Wicks, F. Bowlick, and M. Carulloe. 2018. Developing a land cover classification of salt marshes using UAS time-series imagery and an open-source workflow. The International Archives of the Photogrammetry, Remote Sensing and Spatial Information Sciences, Volume XLII-4/W8:155-162. doi.org/10.5194/isprs-archives-XLII-4-W8-155-2018.

Narcisa Gabriela Pricope, Joanne Nancie Halls, Elijah Garrett Dalton, Asami Minei, Cuixian Chen, Yishi Wang. Precision Mapping of Coastal Wetlands: An Integrated Remote Sensing Approach Using Unoccupied Aerial Systems Light Detection and Ranging and Multispectral Data. J Remote Sens. 2024;4:0169. <DOI:10.34133/remotesensing.0169>.

Nardin, W., Y. Taddia, M. Quitadamo, I. Vona, C. Corbau, G. Franchi, L.W. Staver, and A. Pellegrinelli. 2021. Seasonality and characterization mapping of restored tidal marsh by NDVI imageries coupling UAVs and multispectral camera. Remote Sensing, 13:21, 4207. doi.org/10.3390/rs13214207.

Puckett, B., C. Falvo, C. Deaton, B. Morse, E. Smith, and J. Ridge. A protocol for monitoring coastal wetlands with drones: Image acquisition, processing, and analysis workflows. National Estuarine Research Reserve System Science Collaborative. <https://nerrssciencecollaborative.org/sites/default/files/files/NERRS_drone_marsh_monitoring_SOP_w_authors.pdf>.

Rocks, E.N., and S.M. Stevens. 2018. Northeast Coastal and Barrier Network salt marsh vegetation monitoring protocol implementation plan: Version 1.0. Natural Resource Report NPS/NCBN/NRR—2018/1790. National Park Service, Fort Collins, Colorado.

Roman, C.T., M.J. James-Pirri, and J.F. Heltshe. 2001. Monitoring Salt Marsh Vegetation: A Protocol for the Long-term Coastal Ecosystem Monitoring Program at Cape Cod National Seashore. Coordinated by the USGS Patuxent Wildlife Research Center, Coastal Research Field Station at the University of Rhode Island, Narragansett, RI 02882. Available at <https://irma.nps.gov/DataStore/Reference/Profile/563500>.

Routhier, M., G. Moore, and B. Rock. 2023. Assessing spectral band, elevation, and collection date combinations for classifying salt marsh vegetation with unoccupied aerial vehicle (UAV)-acquired imagery. Remote Sensing, 15:20, 5076. doi.org/10.3390/rs15205076.

State of New York. 2022. [New York Laws, Environmental Conservation § 9-170](https://law.justia.com/codes/new-york/2022/env/article-9/title-17/9-1709/). New York Department of State. 2021. [6 New York Codes, Rules and Regulations Part 575: Prohibited and Regulated Invasive Species](https://govt.westlaw.com/nycrr/Browse/Home/NewYork/NewYorkCodesRulesandRegulations?guid=Ie8d3e7b0339611e4baa20000845b8d3e&originationContext=documenttoc&transitionType=Default&contextData=(sc.Default)).

Warton, D.I., Wright, T.W., Wang, Y. 2012. Distance-based multivariate analyses confound location and dispersion effects. Methods in Ecology and Evolution, 3, 89–101.

#### **6. Appendices**

```{r Appendix 1, echo=FALSE, fig.width=6.5, message=FALSE, warning=FALSE, ft.keepnext=FALSE, out.width=6.5}
data.frame(
  state = c("MA", "NY", "NJ", "MD", "VA"),
  rare_source = c(
    "https://www.mass.gov/info-details/list-of-\nendangered-threatened-and-special-concern-\nspecies",
    "https://www.nynhp.org/documents/5/rare-\nplant-status-lists-2023.pdf",
    "https://www.nj.gov/dep/parksandforests/\nnatural/docs/njplantlist.pdf",
    "https://dnr.maryland.gov/wildlife/documents/\nrte_plant_list.pdf",
    "https://www.dcr.virginia.gov/natural-\nheritage/document/plantlist-current.pdf"),
    invasive_source = c(
      "https://massnrc.org/mipag/species\nreviewed_category.htm",
      "https://govt.westlaw.com/nycrr/Browse/Home/\nNewYork/NewYorkCodesRulesandRegulations?\nguid=Ie8d3e7b0339611e4baa20000845b8d3e&\noriginationContext=documenttoc&transitionType=\nDefault&contextData=(sc.Default)",
      "https://dep.nj.gov/invasive-species/plants/",
      "https://mda.maryland.gov/plants-pests/\nDocuments/Invasive-Plant-List-March-2020.pdf",
      "https://www.dcr.virginia.gov/natural-heritage/\ninvsppdflist")
) %>%
  flextable(data = .) %>%
  set_header_labels(., state = "State", rare_source = "Rare species list source", invasive_source = "Invasive species list source") %>%
  align(., align = "center", part = "all") %>%
  align(., j = c(2,3), part = "body", align = "left") %>%
  padding(., part = "body", padding.top = 3, padding.bottom = 3, padding.left = 3, padding.right = 3) %>%
  padding(., i = 1, j = 1, part = "header", padding.left = 5, padding.right = 5) %>%
  padding(., j = 1, part = "body", padding.left = 5, padding.right = 5) %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  add_header_lines(., values = c("Appendix 1. Data sources for rare and invasive species lists for each state.")) %>%
  align(., i = 1, align = "left", part = "header") %>%
  padding(., i = 1, part = "header", padding.left = 0)
```

 

```{r Appendix 2, echo=FALSE, message=FALSE, warning=FALSE}

top5_table_labs <- veg_cleaned$park_perc_cover %>% 
  ungroup() %>%
  mutate(state_te = if_else(!is.na(`State Status`), paste0(" ", str_sub(`State Status`, -1), " "), NA),
  manage = case_when(is.na(`NPS Tags`) ~ NA,
                     `NPS Tags` == "Exploitation Concern, Management Priority" ~ " Mp/Ec ",
                     `NPS Tags` == "Management Priority, Exploitation Concern" ~ " Mp/Ec ",
                     `NPS Tags` == "Management Priority" ~ " Mp ",
                     `NPS Tags` == "Exploitation Concern" ~ " Ec "),
  inv = case_when(
    UnitCode == "ASIS" & !is.na(invasive_asis_md) ~ " I ",
    UnitCode == "ASIS" & !is.na(invasive_asis_va) ~ " I ",
    UnitCode == "COLO" & !is.na(invasive_colo) ~ " I ",
    UnitCode == "FIIS" & !is.na(invasive_fiis) ~ " I ",
    UnitCode == "GATE" & !is.na(invasive_gate_nj) ~ " I ",
    UnitCode == "GATE" & !is.na(invasive_gate_ny) ~ " I ",
    UnitCode == "GEWA" & !is.na(invasive_gewa) ~ " I ",
    UnitCode == "SAHI" & !is.na(invasive_sahi) ~ " I ",
    T ~ NA
  ),
  SalinityCode = case_when(SalinityCode == "high >18 ppt" ~ "H",
                           SalinityCode == "medium 0.5-18 ppt" ~ "M",
                           SalinityCode == "low <0.5 ppt" ~ "L", 
                           SalinityCode == "unknown" ~ NA, 
                           SalinityCode == "no" ~ NA,
                           T ~ SalinityCode),
  SalinityTolerance = case_when(SalinityTolerance == "High" ~ "H",
                                SalinityTolerance == "Medium" ~ "M",
                                SalinityTolerance == "Low" ~ "L",
                                SalinityTolerance == "" ~ NA,
                                SalinityTolerance == "None" ~ NA,
                                T ~ SalinityTolerance),
  sal_code = if_else(is.na(SalinityTolerance) & !is.na(SalinityCode), SalinityCode, SalinityTolerance)) %>%
  select(UnitCode, SciName_cor, CommonName, AcceptedSymbol, state_te, manage, inv, sal_code) %>%
  distinct(UnitCode, SciName_cor, CommonName, AcceptedSymbol, state_te, manage, inv, sal_code)

top5 <- list(
  "top5cover" = veg_cleaned$park_perc_cover %>%
    group_by(UnitCode, SciName_cor) %>%
    summarise(mean_park_cover = mean(mean_park_cover)) %>% 
    group_by(UnitCode) %>%
    slice_max(order_by = mean_park_cover, n = 5) %>%
    ungroup() %>%
    select(UnitCode, mean_park_cover, SciName_cor) %>%
    left_join(., top5_table_labs, by = c("UnitCode", "SciName_cor")) %>%
    mutate(sciname_cover = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                                                           SciName_cor,
                                                           paste0(SciName_cor, " sps."))) %>%
    select(UnitCode, sciname_cover, mean_park_cover, "sal_cover" = sal_code, "state_te_cover" = state_te, "manage_cover" = manage, "inv_cover" = inv),
  
  "top5frq" = veg_cleaned$park_frq %>%
    group_by(UnitCode, SciName_cor) %>%
    summarise(mean_park_frq = mean(mean_frq)) %>%
    group_by(UnitCode) %>%
    slice_max(order_by = mean_park_frq, n = 5) %>%
    ungroup() %>%
    select(UnitCode, mean_park_frq, SciName_cor)  %>%
    left_join(., top5_table_labs, by = c("UnitCode", "SciName_cor")) %>%
    mutate(sciname_frq = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                                                           SciName_cor,
                                                           paste0(SciName_cor, " sps."))) %>%
    select(sciname_frq, mean_park_frq, "sal_frq" = sal_code, "state_te_frq" = state_te, "manage_frq" = manage, "inv_frq" = inv)
)

bind_cols(top5$top5cover, top5$top5frq) %>%
  flextable(data = ., col_keys = c("UnitCode", "dummy_cover", "mean_park_cover", "dummy_frq", "mean_park_frq")) %>%
  align(., align = "center", part = "all") %>%
  add_header_lines(., values = c("Appendix 2. Salt marsh plant cover species with the top five highest mean cover and/or frequency in each park unit across all years. Species labeled with sps. could not be identified beyond the genus level. Bold letters following the scientific name indicate that the species is considered endangered (E), rare (R), threatened (T), or vulnerable (V) at the state-level, management priority (MP) or exploitation concern (EC) in NPSpecies, or invasive (I). Italic letters following the scientific name represent the species salinity tolerance. Salinity tolerance categories were defined as: L = < 0.5 ppt, M = 0.5 to 18 ppt, H = > 18 ppt. Salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Species without salinity tolerance labels did not have salinity tolerance data in USDA Plants.")) %>%
  mk_par(j = "dummy_cover", 
           value = as_paragraph(
             as_i(sciname_cover), 
             " ", 
             as_chunk(state_te_cover, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(manage_cover, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(inv_cover, props = fp_text_default(font.size = 10, bold = TRUE)),
             as_chunk(sal_cover, props = fp_text_default(font.size = 10, italic = TRUE))
             )
           ) %>%
  mk_par(j = "dummy_frq", 
           value = as_paragraph(
             as_i(sciname_frq), 
             " ", 
             as_chunk(state_te_frq, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(manage_frq, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(inv_frq, props = fp_text_default(font.size = 10, bold = TRUE)),
             as_chunk(sal_frq, props = fp_text_default(font.size = 10, italic = TRUE))
             )
           ) %>%
  colformat_double(., j = c(3,5), digits = 0) %>%
  set_header_labels(., UnitCode = "Park Unit", sciname_cover = "Species", mean_park_cover = "Cover (%)", sciname_frq = "Species", mean_park_frq = "Frequency (% of plots)") %>%
  align(., i = 1, align = "left", part = "header") %>%
  hline(., i = c(5,10,15,20,25), border = fp_border(color = "black", width = 1)) %>%
  merge_v(., j = 1) %>%
  fix_border_issues() %>%
  padding(., part = "body", padding.top = 3, padding.bottom = 3) %>%
  autofit()
```

 

```{r Appendix 3 species lists for each park, message=FALSE, warning=FALSE, include=FALSE}
species_list_table_fun <- function(park_code, letter, park, table_caption) {
  
  labs <- veg_cleaned$park_perc_cover %>% 
  ungroup() %>%
  mutate(state_te = if_else(!is.na(`State Status`), str_sub(`State Status`, -1), NA),
  manage = case_when(is.na(`NPS Tags`) ~ NA,
                     `NPS Tags` == "Exploitation Concern, Management Priority" ~ " Mp/Ec ",
                     `NPS Tags` == "Management Priority, Exploitation Concern" ~ " Mp/Ec ",
                     `NPS Tags` == "Management Priority" ~ " Mp ",
                     `NPS Tags` == "Exploitation Concern" ~ " Ec "),
  inv = case_when(
    UnitCode == "ASIS" & !is.na(invasive_asis_md) ~ " I ",
    UnitCode == "ASIS" & !is.na(invasive_asis_va) ~ " I ",
    UnitCode == "COLO" & !is.na(invasive_colo) ~ " I ",
    UnitCode == "FIIS" & !is.na(invasive_fiis) ~ " I ",
    UnitCode == "GATE" & !is.na(invasive_gate_nj) ~ " I ",
    UnitCode == "GATE" & !is.na(invasive_gate_ny) ~ " I ",
    UnitCode == "GEWA" & !is.na(invasive_gewa) ~ " I ",
    UnitCode == "SAHI" & !is.na(invasive_sahi) ~ " I ",
    T ~ NA
  ),
  SalinityCode = case_when(SalinityCode == "high >18 ppt" ~ "High",
                           SalinityCode == "medium 0.5-18 ppt" ~ "Medium",
                           SalinityCode == "low <0.5 ppt" ~ "Low", 
                           SalinityCode == "unknown" ~ NA, 
                           SalinityCode == "no" ~ NA,
                           T ~ SalinityCode),
  SalinityTolerance = case_when(SalinityTolerance == "" ~ NA,
                                SalinityTolerance == "None" ~ NA,
                                T ~ SalinityTolerance),
  sal_code = if_else(is.na(SalinityTolerance) & !is.na(SalinityCode), SalinityCode, SalinityTolerance)) %>%
  select(UnitCode, SciName_cor, CommonName, AcceptedSymbol, state_te, manage, inv, sal_code) %>%
  distinct(UnitCode, SciName_cor, CommonName, AcceptedSymbol, state_te, manage, inv, sal_code)
  
  veg_cleaned$park_perc_cover %>%
    ungroup() %>%
    select(UnitCode, SciName_cor) %>%
    group_by(UnitCode) %>%
    distinct(SciName_cor) %>%
    ungroup() %>%
    filter(UnitCode == park_code) %>%
    select(UnitCode, SciName_cor) %>%
    arrange(SciName_cor) %>%
    left_join(., labs, by = c("UnitCode", "SciName_cor")) %>%
    mutate(SciName_cor = if_else(lengths(strsplit(SciName_cor, "\\W+")) > 1,
                                                           SciName_cor,
                                                           paste0(SciName_cor, " sps."))) %>%
    group_by(SciName_cor) %>%
    flextable(., col_keys = c("dummy_col", "CommonName", "AcceptedSymbol", "sal_code")) %>%
    mk_par(j = "dummy_col", 
           value = as_paragraph(
             as_i(SciName_cor), 
             " ", 
             as_chunk(state_te, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(manage, props = fp_text_default(font.size = 10, bold = TRUE)), 
             as_chunk(inv, props = fp_text_default(font.size = 10, bold = TRUE))
             )
           ) %>%
    align(., align = "center", part = "all") %>%
    set_table_properties(., layout = "autofit") %>%
    add_header_lines(., values = paste0(table_caption)) %>%
    set_header_labels(., dummy_col = "Species", CommonName = "Common Name", AcceptedSymbol = "Symbol", sal_code = "Salinity Tolerance") %>%
    align(., i = 1, align = "left", part = "header") %>%
    border_inner_h(., border = fp_border(color = "transparent"), part = "body") 
}
```

```{r Appendix 3A: Species lists for ASIS, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "ASIS", letter = "A", park = "Assateague Island National Seashore (ASIS)", table_caption ="Appendix 3A. Salt marsh plant species list for Assateague Island National Seashore (ASIS). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```

 

```{r Appendix 3B: Species lists for COLO, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "COLO", letter = "B", park = "Colonial National Historical Park (COLO)", table_caption = "Appendix 3B. Salt marsh plant species list for Colonial National Historical Park (COLO). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Bold letters following the scientific name indicate that the species is considered management priority (MP) in NPSpecies or invasive (I). Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```

 

```{r Appendix 3C: Species lists for FIIS, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "FIIS", letter = "C", park = "Fire Island National Seashore (FIIS)", table_caption = "Appendix 3C. Salt marsh plant species list for Fire Island National Seashore (FIIS). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Bold letters following the scientific name indicate that the species is considered threatened (T) or vulnerable (V) at the state-level, management priority (MP) or exploitation concern (EC) in NPSpecies, or invasive (I). Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```

 

```{r Appendix 3D: Species lists for GATE, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "GATE", letter = "D", park = "Gateway National Recreation Area (GATE)", table_caption = "Appendix 3D. Salt marsh plant species list for Gateway National Recreation Area (GATE). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Bold letters following the scientific name indicate that the species is considered endangered (E), rare (R), threatened (T), or vulnerable (V) at the state-level, management priority (MP) in NPSpecies, or invasive (I). Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```

 

```{r Appendix 3E: Species lists for GEWA, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "GEWA", letter = "E", park = "George Washington Birthplace National Monument (GEWA)", table_caption = "Appendix 3E. Salt marsh plant species list for George Washington Birthplace National Monument (GEWA). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```

 

```{r Appendix 3F: Species lists for SAHI, echo=FALSE, message=FALSE, warning=FALSE}
species_list_table_fun(park_code = "SAHI", letter = "F", park = "Sagamore Hill National Historic Site (SAHI)", table_caption = "Appendix 3F. Salt marsh plant species list for Sagamore Hill National Historic Site (SAHI). Species labeled with sps. could not be identified beyond the genus level. Common names, symbols, and salinity tolerance categories are derived from the USDA Plants database (plants.usda.gov). Bold letters following the scientific name indicate that the species is considered rare (R) or vulnerable (V) at the state-level or management priority (MP) in NPSpecies. Salinity tolerance categories were defined as: Low = < 0.5 ppt, Medium = 0.5 to 18 ppt, High = > 18 ppt. Blank indicates the species is missing salinity tolerance data in USDA Plants.")
```